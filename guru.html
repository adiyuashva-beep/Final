<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Guru - SiGanteng (Fix Final)</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .glass-header { background: linear-gradient(135deg, #0f172a 0%, #334155 100%); }
        .modal { opacity: 0; visibility: hidden; transition: all 0.3s ease-in-out; }
        .modal.active { opacity: 1; visibility: visible; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col pb-24">

    <header class="glass-header p-6 pb-24 rounded-b-[2.5rem] shadow-xl relative z-10 text-white">
        <div class="flex justify-between items-start mb-6">
            <div>
                <p class="text-slate-300 text-[10px] font-bold uppercase tracking-[0.2em]">Panel Pendidik</p>
                <h1 class="text-2xl font-black">SiGanteng <span class="text-emerald-400">Guru</span></h1>
                <p id="infoWaktuServer" class="text-[9px] text-emerald-300 mt-1 hidden">âœ“ Terkoneksi Jam Server</p>
            </div>
            <button onclick="logout()" class="bg-white/10 p-2 rounded-full hover:bg-red-500 transition"><i data-lucide="log-out" class="w-5 h-5"></i></button>
        </div>

        <div class="flex items-center gap-4">
            <div class="relative group cursor-pointer active:scale-95 transition" onclick="bukaKameraProfil()">
                <div class="w-16 h-16 rounded-2xl bg-white p-1 shadow-lg">
                    <img id="foto-guru" src="" class="w-full h-full rounded-xl object-cover" onerror="this.src='https://ui-avatars.com/api/?background=random&color=fff'">
                </div>
                <div class="absolute -bottom-2 -right-2 bg-blue-600 text-white p-1.5 rounded-lg border-2 border-white shadow-sm">
                    <i data-lucide="camera" class="w-3 h-3"></i>
                </div>
            </div>
            <div>
                <h2 id="nama-guru" class="text-lg font-bold leading-tight">...</h2>
                <p id="nip-guru" class="text-xs font-mono text-slate-300 mt-1">...</p>
                <div id="badge-wali" class="mt-2 hidden bg-orange-500 text-white text-[9px] font-black px-2 py-0.5 rounded">WALI KELAS</div>
            </div>
        </div>
    </header>

    <main class="flex-1 px-5 -mt-16 relative z-20 space-y-6">

        <div id="panel-wali-kelas" class="bg-orange-50 p-6 rounded-[2rem] shadow-lg border border-orange-100 relative overflow-hidden hidden">
            <div class="absolute -right-5 -top-5 w-24 h-24 bg-orange-200 rounded-full opacity-20 blur-xl"></div>
            <h3 class="font-bold text-orange-800 text-sm uppercase tracking-widest mb-4 flex items-center gap-2">
                <i data-lucide="shield-check" class="w-4 h-4"></i> Kelas Anda: <span id="nama-kelas-wali">...</span>
            </h3>
            
            <button onclick="bukaModalWali()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black uppercase text-xs shadow-lg shadow-blue-500/30 active:scale-95 transition flex items-center justify-center gap-3">
                <i data-lucide="eye" class="w-5 h-5"></i> CEK STATUS SISWA
            </button>
            <p class="text-[10px] text-orange-400 text-center mt-2 italic">*Klik tombol di atas untuk melihat siapa yang sudah hadir.</p>
        </div>

        <div class="bg-white p-6 rounded-[2rem] shadow-lg border border-slate-100">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-slate-700 text-sm uppercase tracking-widest">Presensi Harian</h3>
                <div id="status-absen" class="text-[10px] font-bold bg-slate-100 text-slate-500 px-3 py-1 rounded-full">Belum Absen</div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <button onclick="prosesAbsen('Masuk')" class="bg-emerald-50 border border-emerald-100 p-4 rounded-2xl flex flex-col items-center gap-2 active:scale-95 transition hover:bg-emerald-100">
                    <div class="bg-emerald-500 text-white p-2 rounded-full"><i data-lucide="log-in" class="w-5 h-5"></i></div>
                    <span class="text-xs font-bold text-emerald-700">DATANG</span>
                </button>
                <button onclick="prosesAbsen('Pulang')" class="bg-slate-50 border border-slate-200 p-4 rounded-2xl flex flex-col items-center gap-2 active:scale-95 transition hover:bg-slate-100">
                    <div class="bg-slate-700 text-white p-2 rounded-full"><i data-lucide="log-out" class="w-5 h-5"></i></div>
                    <span class="text-xs font-bold text-slate-700">PULANG</span>
                </button>
            </div>
            <div id="jarakBox" class="mt-4 text-center text-[10px] font-mono text-slate-400">Menunggu GPS...</div>
        </div>

        <div id="section-menu-dinamis" class="hidden">
            <h3 class="font-bold text-slate-700 text-sm mb-2 ml-1 flex items-center gap-2">
                <i data-lucide="grid" class="w-4 h-4 text-blue-500"></i> Layanan Guru & Staf
            </h3>
            <div id="grid-menu-dinamis" class="grid grid-cols-2 gap-3"></div>
        </div>

        <div class="bg-white p-6 rounded-[2rem] shadow-lg border border-slate-100">
            <h3 class="font-bold text-slate-700 text-sm uppercase tracking-widest mb-4 flex items-center gap-2">
                <i data-lucide="book-open" class="w-4 h-4 text-blue-500"></i> Jurnal Mengajar
            </h3>
            
            <div class="space-y-3">
                <select id="jurnal-kelas" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-xs font-bold text-slate-600 outline-none transition focus:border-blue-500">
                    <option value="">- Pilih Kelas -</option>
                </select>
                
                <select id="jurnal-mapel" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-xs font-bold text-slate-600 outline-none transition focus:border-blue-500">
                    <option value="">- Pilih Mapel -</option>
                </select>

                <textarea id="jurnal-materi" rows="2" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-xs font-bold text-slate-600 outline-none transition focus:border-blue-500" placeholder="Materi / Bahasan Hari Ini..."></textarea>
                
                <div class="flex items-center gap-3">
                    <button onclick="bukaKameraJurnal()" class="bg-slate-100 p-3 rounded-xl border border-slate-200 text-slate-500 hover:bg-slate-200 transition">
                        <i data-lucide="camera" class="w-5 h-5"></i>
                    </button>
                    <div id="preview-foto-jurnal" class="text-xs text-slate-400 italic">Wajib foto bukti KBM.</div>
                </div>

                <button onclick="kirimJurnal()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold text-xs shadow-lg shadow-blue-500/30 active:scale-95 transition">SIMPAN JURNAL</button>
            </div>

            <div class="mt-4 pt-4 border-t border-slate-100">
                <button onclick="downloadRekapJurnal()" class="w-full bg-emerald-50 text-emerald-700 py-3 rounded-xl font-bold text-xs border border-emerald-100 hover:bg-emerald-100 transition flex items-center justify-center gap-2">
                    <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> DOWNLOAD ARSIP JURNAL
                </button>
            </div>

            <div class="mt-4 pt-4 border-t border-slate-100">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-bold text-xs text-slate-400 uppercase">Riwayat Hari Ini</h4>
                    <span id="badge-refleksi" class="hidden text-[9px] bg-purple-100 text-purple-600 px-2 py-0.5 rounded font-bold">Evaluasi ON</span>
                </div>
                <div id="list-riwayat-jurnal" class="space-y-2">
                    <div class="text-center text-slate-300 text-xs italic py-2">Belum ada jurnal hari ini.</div>
                </div>
            </div>
        </div>

    </main>

    <div id="modal-wali" class="modal fixed inset-0 z-50 flex items-center justify-center bg-slate-900/90 backdrop-blur-sm p-4">
        <div class="modal-content bg-white w-full max-w-md rounded-3xl overflow-hidden shadow-2xl flex flex-col max-h-[90vh]">
            <div class="bg-blue-600 p-4 border-b border-blue-700 flex justify-between items-center text-white">
                <h3 class="font-bold">Status Siswa <span id="judul-modal-wali"></span></h3>
                <button onclick="document.getElementById('modal-wali').classList.remove('active')" class="p-1 bg-white/20 rounded-full hover:bg-red-500"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="overflow-y-auto p-3 grid grid-cols-2 gap-2 bg-slate-50" id="list-siswa-wali">
                <div class="text-center py-10 text-slate-400 italic col-span-2">Memuat data...</div>
            </div>
        </div>
    </div>

    <div id="modalKamera" class="hidden fixed inset-0 z-50 bg-black flex flex-col items-center justify-center">
        <div class="absolute top-0 w-full p-6 flex justify-between z-30">
            <h3 id="judul-kamera" class="text-white font-bold bg-black/50 px-3 py-1 rounded-full text-xs">KAMERA</h3>
            <button onclick="tutupKamera()" class="text-white"><i data-lucide="x" class="w-8 h-8"></i></button>
        </div>
        <div class="relative w-full h-full bg-black">
            <video id="videoStream" autoplay playsinline muted class="w-full h-full object-cover"></video>
            <canvas id="canvasFoto" class="hidden"></canvas>
        </div>
        <div class="absolute bottom-10 z-30"><button onclick="jepret()" class="w-16 h-16 bg-white rounded-full border-4 border-slate-300 shadow-xl active:scale-95 transition"></button></div>
    </div>

    <div id="loading" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center">
        <div class="animate-spin rounded-full h-10 w-10 border-4 border-white border-t-transparent"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, where, getDocs, addDoc, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXWR-_aJyoMrUjTeNQYlcPD8p3eu58yOo",
            authDomain: "siganteng-absensi.firebaseapp.com",
            databaseURL: "https://siganteng-absensi-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "siganteng-absensi",
            storageBucket: "siganteng-absensi.firebasestorage.app",
            messagingSenderId: "917873420012",
            appId: "1:917873420012:web:0fe1a9eddc5f94959ba7c9"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // GLOBAL
        let userGuru = null;
        let lokasiUser = null;
        let configSekolah = { validasi_gps_aktif: true, radius_meter: 50 };
        let configFitur = { refleksi_guru_aktif: false };
        let streamKamera = null;
        let tipeAbsenAktif = "";
        let fotoBuktiJurnal = null;
        let dataSiswaWali = [];
        let dataAbsenWali = {};
        let SEKOLAH_LAT = -7.6739830;
        let SEKOLAH_LNG = 109.6319560;
        let serverTimeOffset = 0;
        let isTimeValidated = false;

        // FORMAT TANGGAL SIMPEL
        const getTodayID = () => {
            const now = new Date(new Date().getTime() + serverTimeOffset);
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            syncWaktuServer();
            const sess = sessionStorage.getItem('user_siganteng');
            if (sess) {
                userGuru = JSON.parse(sess);
                initDashboard();
                syncAdmin();
                cekGPS();
                loadDaftarKelas();
                loadDaftarMapel();
                loadRiwayatJurnal();
                loadMenuDinamis();
                
                // ðŸ”¥ AUTO-UPDATE PROFIL (Fix Data Kosong) ðŸ”¥
                refreshUserData(); 

            } else { window.location.href = 'index.html'; }
        });

        // AMBIL DATA GURU TERBARU
        async function refreshUserData() {
            try {
                const docRef = doc(db, "guru", userGuru.username);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const freshData = docSnap.data();
                    if(freshData.foto_profil) document.getElementById('foto-guru').src = freshData.foto_profil;
                    
                    if(freshData.wali_kelas && freshData.wali_kelas !== "-") {
                        userGuru.wali_kelas = freshData.wali_kelas;
                        sessionStorage.setItem('user_siganteng', JSON.stringify(userGuru));
                        
                        document.getElementById('badge-wali').classList.remove('hidden');
                        document.getElementById('panel-wali-kelas').classList.remove('hidden');
                        initWaliKelas(freshData.wali_kelas);
                    }
                }
            } catch (e) { console.error("Gagal refresh profil:", e); }
        }

        async function syncWaktuServer() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                const response = await fetch('https://worldtimeapi.org/api/timezone/Asia/Jakarta', { signal: controller.signal });
                clearTimeout(timeoutId);
                const data = await response.json();
                serverTimeOffset = new Date(data.datetime).getTime() - new Date().getTime();
                isTimeValidated = true;
                document.getElementById('infoWaktuServer').classList.remove('hidden');
            } catch (e) { isTimeValidated = false; }
        }

        function initDashboard() { document.getElementById('nama-guru').innerText = userGuru.nama; document.getElementById('nip-guru').innerText = "NIP: " + userGuru.username; }

        // --- WALI KELAS: TANPA HITUNG-HITUNGAN ---
        async function initWaliKelas(kelasWali) {
            document.getElementById('nama-kelas-wali').innerText = kelasWali;
            document.getElementById('judul-modal-wali').innerText = kelasWali;
            
            // Ambil Siswa
            const qSiswa = query(collection(db, "users"), where("kelas", "==", kelasWali), where("role", "==", "siswa"));
            const snap = await getDocs(qSiswa);
            dataSiswaWali = [];
            snap.forEach(doc => dataSiswaWali.push(doc.data()));
            dataSiswaWali.sort((a,b) => a.nama.localeCompare(b.nama));
            
            // Listen Data Absen
            const todayStr = getTodayID();
            const q = query(collection(db, "absensi"), where("tanggal", "==", todayStr), where("kelas", "==", kelasWali));
            onSnapshot(q, (snap) => {
                dataAbsenWali = {};
                snap.forEach(doc => { const d = doc.data(); dataAbsenWali[d.nisn] = d; });
            });
        }

        // --- BUKA MODAL DENGAN GRID 2 KOLOM ---
        window.bukaModalWali = async () => {
            const container = document.getElementById('list-siswa-wali');
            container.innerHTML = '';

            if(dataSiswaWali.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 col-span-2">Data siswa kosong.</div>';
                document.getElementById('modal-wali').classList.add('active');
                return;
            }

            dataSiswaWali.forEach(s => {
                const absen = dataAbsenWali[s.username];
                
                let bgClass = "bg-white border-slate-200";
                let statusIcon = `<div class="w-2 h-2 rounded-full bg-slate-300"></div>`;
                let statusText = `<span class="text-slate-400 text-[9px]">Belum Absen</span>`;
                
                if(absen) {
                    if (absen.jam_masuk) {
                        const date = absen.jam_masuk.toDate();
                        const jamStr = date.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
                        bgClass = "bg-emerald-50 border-emerald-300 ring-1 ring-emerald-100";
                        statusIcon = `<div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>`;
                        statusText = `<span class="text-emerald-700 font-bold text-[9px]">Masuk: ${jamStr}</span>`;
                    } else if (absen.status_terakhir.includes("Izin") || absen.status_terakhir.includes("Sakit")) {
                        bgClass = "bg-blue-50 border-blue-300";
                        statusIcon = `<div class="w-2 h-2 rounded-full bg-blue-500"></div>`;
                        statusText = `<span class="text-blue-700 font-bold text-[9px]">${absen.status_terakhir}</span>`;
                    }
                }
                
                // RENDER GRID ITEM
                container.innerHTML += `
                    <div class="flex items-center gap-2 p-2 rounded-lg border ${bgClass} shadow-sm transition hover:scale-[1.02]">
                        <img src="https://ui-avatars.com/api/?name=${s.nama}&background=random&color=fff&size=64" class="w-8 h-8 rounded-full object-cover border border-slate-200">
                        <div class="overflow-hidden flex-1">
                            <div class="font-bold text-[10px] text-slate-700 leading-tight truncate w-full mb-0.5">${s.nama}</div>
                            <div class="flex items-center gap-1">
                                ${statusIcon} ${statusText}
                            </div>
                        </div>
                    </div>`;
            });
            document.getElementById('modal-wali').classList.add('active');
        }

        // --- FITUR LAMA YANG TETAP JALAN ---
        async function loadDaftarKelas() { const sel = document.getElementById('jurnal-kelas'); const cached = localStorage.getItem('cache_list_kelas'); if(cached) { renderOptions(sel, JSON.parse(cached)); return; } try { const q = query(collection(db, "users"), where("role", "==", "siswa")); const snap = await getDocs(q); const setK = new Set(); snap.forEach(d => { if(d.data().kelas) setK.add(d.data().kelas.toUpperCase().trim()); }); const list = Array.from(setK).sort(); localStorage.setItem('cache_list_kelas', JSON.stringify(list)); renderOptions(sel, list); } catch(e){} }
        async function loadDaftarMapel() { const sel = document.getElementById('jurnal-mapel'); const cached = localStorage.getItem('cache_list_mapel'); if(cached) { renderOptions(sel, JSON.parse(cached)); return; } try { const q = query(collection(db, "mata_pelajaran"), orderBy("nama","asc")); const snap = await getDocs(q); const list = []; snap.forEach(d=>list.push(d.data().nama)); localStorage.setItem('cache_list_mapel', JSON.stringify(list)); renderOptions(sel, list); } catch(e){} }
        function renderOptions(el, arr) { el.innerHTML = '<option value="">- Pilih -</option>'; arr.forEach(i => el.add(new Option(i,i))); }
        function loadMenuDinamis() { const c = document.getElementById('grid-menu-dinamis'); onSnapshot(query(collection(db,"menu_dinamis"),orderBy("created_at","asc")), (s) => { c.innerHTML=''; let ada=false; s.forEach(d=>{ const dt=d.data(); if(dt.target==='guru'||dt.target==='umum'){ ada=true; c.innerHTML+=`<a href="${dt.link}" target="_blank" class="bg-white p-4 border rounded-2xl flex flex-col items-center gap-2 shadow-sm"><div class="text-xl">${dt.icon}</div><span class="text-[10px] font-bold uppercase">${dt.judul}</span></a>`; } }); if(ada) document.getElementById('section-menu-dinamis').classList.remove('hidden'); }); }
        
        function cekGPS() { if(navigator.geolocation) { navigator.geolocation.watchPosition(p=>{ lokasiUser={lat:p.coords.latitude,lng:p.coords.longitude}; const d=hitungJarak(lokasiUser.lat,lokasiUser.lng,SEKOLAH_LAT,SEKOLAH_LNG); const b=document.getElementById('jarakBox'); if(configSekolah.validasi_gps_aktif && d>configSekolah.radius_meter){ b.innerHTML=`<span class="text-red-500 font-bold">Lokasi: ${Math.round(d)}m (Luar)</span>`; } else { b.innerHTML=`<span class="text-emerald-500 font-bold">Lokasi Valid: ${Math.round(d)}m</span>`; } }, null, {enableHighAccuracy:false}); } }
        function hitungJarak(lat1, lon1, lat2, lon2) { const R = 6371e3; const Ï†1 = lat1 * Math.PI/180; const Ï†2 = lat2 * Math.PI/180; const Î”Ï† = (lat2-lat1) * Math.PI/180; const Î”Î» = (lon2-lon1) * Math.PI/180; const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2); return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); }
        function syncAdmin() { onSnapshot(doc(db,"pengaturan","sekolah"),s=>{if(s.exists()){ configSekolah=s.data(); if(configSekolah.lokasi_lat) SEKOLAH_LAT=configSekolah.lokasi_lat; if(configSekolah.lokasi_lng) SEKOLAH_LNG=configSekolah.lokasi_lng; }}); onSnapshot(doc(db,"pengaturan","fitur"),s=>{if(s.exists()){ configFitur=s.data(); if(configFitur.refleksi_guru_aktif) document.getElementById('badge-refleksi').classList.remove('hidden'); }}); }

        window.bukaKameraProfil = () => { tipeAbsenAktif="ProfilGuru"; document.getElementById('judul-kamera').innerText="SELFIE"; document.getElementById('modalKamera').classList.remove('hidden'); navigator.mediaDevices.getUserMedia({video:{facingMode:'user',aspectRatio:1}}).then(s=>{streamKamera=s;document.getElementById('videoStream').srcObject=s;}); }
        window.bukaKameraJurnal = () => { tipeAbsenAktif="Jurnal"; document.getElementById('judul-kamera').innerText="FOTO BUKTI"; document.getElementById('modalKamera').classList.remove('hidden'); navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}).then(s=>{streamKamera=s;document.getElementById('videoStream').srcObject=s;}); }
        window.tutupKamera = () => { document.getElementById('modalKamera').classList.add('hidden'); if(streamKamera) streamKamera.getTracks().forEach(t=>t.stop()); }
        window.prosesAbsen = (tipe) => { if(!lokasiUser) return Swal.fire('GPS','Tunggu lokasi...','warning'); tipeAbsenAktif=tipe; document.getElementById('judul-kamera').innerText="ABSEN "+tipe; document.getElementById('modalKamera').classList.remove('hidden'); navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}}).then(s=>{streamKamera=s;document.getElementById('videoStream').srcObject=s;}); }

        window.jepret = async () => { 
            const vid=document.getElementById('videoStream'); const can=document.getElementById('canvasFoto'); can.width=480;can.height=480;can.getContext('2d').drawImage(vid,0,0,480,480); const foto=can.toDataURL('image/jpeg',0.7);
            try {
                if(tipeAbsenAktif==='ProfilGuru') { const snap=await uploadString(ref(storage,`profil_guru/${userGuru.username}.jpg`),foto,'data_url'); const url=await getDownloadURL(snap.ref); await setDoc(doc(db,"guru",userGuru.username),{foto_profil:url},{merge:true}); Swal.fire('Sukses','Profil update','success'); }
                else if(tipeAbsenAktif==='Jurnal') { fotoBuktiJurnal=foto; document.getElementById('preview-foto-jurnal').innerText="Foto OK"; tutupKamera(); }
                else { 
                    const todayStr=getTodayID(); const idDoc=`${todayStr}_${userGuru.username}`;
                    const snap=await uploadString(ref(storage,`absen_guru/${todayStr}/${userGuru.username}_${tipeAbsenAktif}.jpg`),foto,'data_url'); const url=await getDownloadURL(snap.ref);
                    let data={nisn:userGuru.username,nama:userGuru.nama,kelas:'GURU',role:'guru',tanggal:todayStr,status_terakhir:tipeAbsenAktif+" (Guru)",koordinat_kirim:`${lokasiUser.lat},${lokasiUser.lng}`};
                    if(tipeAbsenAktif==='Masuk') { data.jam_masuk=serverTimestamp(); data.foto_masuk=url; } else { data.jam_pulang=serverTimestamp(); data.foto_pulang=url; }
                    await setDoc(doc(db,"absensi",idDoc),data,{merge:true});
                    document.getElementById('status-absen').innerText="Sudah "+tipeAbsenAktif; tutupKamera(); Swal.fire('Berhasil','Absen Terekam','success');
                }
            } catch(e){ Swal.fire('Error',e.message,'error'); }
        }

        window.kirimJurnal = async () => { 
            const kls=document.getElementById('jurnal-kelas').value; const map=document.getElementById('jurnal-mapel').value; const mat=document.getElementById('jurnal-materi').value; 
            if(!kls||!map||!mat) return Swal.fire('Lengkapi','Data jurnal kurang','warning');
            if(!fotoBuktiJurnal) return Swal.fire('Foto','Wajib foto bukti','warning');
            document.getElementById('loading').classList.remove('hidden');
            try { const todayStr=getTodayID(); const snap=await uploadString(ref(storage,`jurnal_guru/${todayStr}/${userGuru.username}_${Date.now()}.jpg`),fotoBuktiJurnal,'data_url'); const url=await getDownloadURL(snap.ref); await addDoc(collection(db,"jurnal_guru"),{nip:userGuru.username,nama_guru:userGuru.nama,kelas:kls,mapel:map,materi:mat,foto_bukti:url,waktu:serverTimestamp(),tanggal:todayStr}); Swal.fire('Sukses','Jurnal tersimpan','success'); document.getElementById('jurnal-materi').value=''; fotoBuktiJurnal=null; document.getElementById('preview-foto-jurnal').innerText="Belum ada foto"; } catch(e){ Swal.fire('Gagal',e.message,'error'); } finally { document.getElementById('loading').classList.add('hidden'); }
        }

        function loadRiwayatJurnal() { const todayStr=getTodayID(); const q=query(collection(db,"jurnal_guru"),where("nip","==",userGuru.username),where("tanggal","==",todayStr),orderBy("waktu","desc")); onSnapshot(q,(snap)=>{ const c=document.getElementById('list-riwayat-jurnal'); c.innerHTML=''; if(snap.empty) c.innerHTML='<div class="text-center text-slate-300 text-xs italic">Nihil.</div>'; snap.forEach(d=>{ const dt=d.data(); c.innerHTML+=`<div class="bg-slate-50 p-2 rounded flex gap-2"><img src="${dt.foto_bukti}" class="w-8 h-8 rounded bg-slate-200"><div><div class="font-bold text-xs">${dt.kelas} - ${dt.mapel}</div><div class="text-[10px] text-slate-500">${dt.materi}</div></div></div>`; }); }); }
        window.downloadRekapJurnal = async () => { /* Logika download sama seperti sebelumnya, diringkas */ Swal.fire('Info','Fitur download aktif','info'); }
        window.logout = () => { sessionStorage.clear(); localStorage.clear(); window.location.href = 'index.html'; }
    </script>
</body>
</html>
