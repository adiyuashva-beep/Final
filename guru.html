<!DOCTYPE html>
<html lang="id">
<head>
    <link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="logo.png">
<meta name="theme-color" content="#0d6efd">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Guru - SiGanteng</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f1f5f9; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .glass-header { background: linear-gradient(135deg, #0f172a 0%, #334155 100%); }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col pb-20">

    <header class="glass-header p-6 pb-24 rounded-b-[2.5rem] shadow-xl relative z-10 text-white">
        <div class="flex justify-between items-start mb-6">
            <div>
                <p class="text-slate-300 text-[10px] font-bold uppercase tracking-[0.2em]">Panel Pendidik</p>
                <h1 class="text-2xl font-black">SiGanteng <span class="text-emerald-400">Guru</span></h1>
            </div>
            <button onclick="logout()" class="bg-white/10 p-2 rounded-full hover:bg-red-500 transition"><i data-lucide="log-out" class="w-5 h-5"></i></button>
        </div>

        <div class="flex items-center gap-4">
            <div class="w-16 h-16 rounded-2xl bg-white p-1">
                <img id="foto-guru" src="" class="w-full h-full rounded-xl object-cover">
            </div>
            <div>
                <h2 id="nama-guru" class="text-lg font-bold leading-tight">...</h2>
                <p id="nip-guru" class="text-xs font-mono text-slate-300 mt-1">...</p>
                <div id="badge-wali" class="hidden mt-2 inline-block bg-orange-500 text-white text-[9px] font-black px-2 py-0.5 rounded">WALI KELAS</div>
            </div>
        </div>
    </header>

    <main class="flex-1 px-5 -mt-16 relative z-20 space-y-6">

        <div class="bg-white p-6 rounded-[2rem] shadow-lg border border-slate-100">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-slate-700 text-sm uppercase tracking-widest">Presensi Harian</h3>
                <div id="status-absen" class="text-[10px] font-bold bg-slate-100 text-slate-500 px-3 py-1 rounded-full">Belum Absen</div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <button onclick="prosesAbsen('Masuk')" class="bg-emerald-50 border border-emerald-100 p-4 rounded-2xl flex flex-col items-center gap-2 active:scale-95 transition">
                    <div class="bg-emerald-500 text-white p-2 rounded-full"><i data-lucide="log-in" class="w-5 h-5"></i></div>
                    <span class="text-xs font-bold text-emerald-700">DATANG</span>
                </button>
                <button onclick="prosesAbsen('Pulang')" class="bg-slate-50 border border-slate-200 p-4 rounded-2xl flex flex-col items-center gap-2 active:scale-95 transition">
                    <div class="bg-slate-700 text-white p-2 rounded-full"><i data-lucide="log-out" class="w-5 h-5"></i></div>
                    <span class="text-xs font-bold text-slate-700">PULANG</span>
                </button>
            </div>
            <div id="jarakBox" class="mt-4 text-center text-[10px] font-mono text-slate-400">Menunggu GPS...</div>
        </div>

        <div class="bg-white p-6 rounded-[2rem] shadow-lg border border-slate-100">
            <h3 class="font-bold text-slate-700 text-sm uppercase tracking-widest mb-4 flex items-center gap-2">
                <i data-lucide="book-open" class="w-4 h-4 text-blue-500"></i> Jurnal Mengajar
            </h3>
            <div class="space-y-3">
                <select id="jurnal-kelas" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-xs font-bold text-slate-600 outline-none transition focus:border-blue-500">
                    <option value="">- Memuat Data Kelas... -</option>
                </select>
                
                <input type="text" id="jurnal-mapel" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-xs font-bold text-slate-600 outline-none transition focus:border-blue-500" placeholder="Mata Pelajaran (Cth: Matematika)">
                <textarea id="jurnal-materi" rows="2" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-xs font-bold text-slate-600 outline-none transition focus:border-blue-500" placeholder="Materi / Bahasan Hari Ini..."></textarea>
                <button onclick="kirimJurnal()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold text-xs shadow-lg shadow-blue-500/30 active:scale-95 transition">SIMPAN JURNAL</button>
            </div>
        </div>

        <div id="panel-wali-kelas" class="hidden bg-orange-50 p-6 rounded-[2rem] shadow-lg border border-orange-100">
            <h3 class="font-bold text-orange-800 text-sm uppercase tracking-widest mb-2 flex items-center gap-2">
                <i data-lucide="users" class="w-4 h-4"></i> Kelas Anda: <span id="nama-kelas-wali">...</span>
            </h3>
            <div class="grid grid-cols-3 gap-2 text-center mt-4">
                <div class="bg-white p-3 rounded-xl shadow-sm"><h4 class="text-emerald-500 font-black text-xl" id="wali-hadir">0</h4><p class="text-[9px] font-bold text-slate-400">HADIR</p></div>
                <div class="bg-white p-3 rounded-xl shadow-sm"><h4 class="text-blue-500 font-black text-xl" id="wali-izin">0</h4><p class="text-[9px] font-bold text-slate-400">IZIN</p></div>
                <div class="bg-white p-3 rounded-xl shadow-sm"><h4 class="text-red-500 font-black text-xl" id="wali-alpha">0</h4><p class="text-[9px] font-bold text-slate-400">ALPHA</p></div>
            </div>
            <button onclick="lihatDetailKelas()" class="w-full mt-4 bg-white text-orange-600 border border-orange-200 py-2 rounded-xl text-[10px] font-bold">LIHAT DETAIL SISWA</button>
        </div>

    </main>

    <div id="map-container" class="hidden"></div>

    <div id="modalKamera" class="hidden fixed inset-0 z-50 bg-black flex flex-col items-center justify-center">
        <div class="absolute top-0 w-full p-6 flex justify-end z-30"><button onclick="tutupKamera()" class="text-white"><i data-lucide="x" class="w-8 h-8"></i></button></div>
        <video id="videoStream" autoplay playsinline muted class="w-full h-full object-cover"></video>
        <canvas id="canvasFoto" class="hidden"></canvas>
        <div class="absolute bottom-10 z-30"><button onclick="jepret()" class="w-16 h-16 bg-white rounded-full border-4 border-slate-300"></button></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

        // FIREBASE CONFIG (SESUAIKAN DENGAN PROJECT MU)
        const firebaseConfig = {
            apiKey: "AIzaSyBXWR-_aJyoMrUjTeNQYlcPD8p3eu58yOo",
            authDomain: "siganteng-absensi.firebaseapp.com",
            databaseURL: "https://siganteng-absensi-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "siganteng-absensi",
            storageBucket: "siganteng-absensi.firebasestorage.app",
            messagingSenderId: "917873420012",
            appId: "1:917873420012:web:0fe1a9eddc5f94959ba7c9"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // STATE
        let userGuru = null;
        let lokasiUser = null;
        let configSekolah = { validasi_gps_aktif: true, radius_meter: 50 };
        let streamKamera = null;
        let tipeAbsenAktif = "";

        // Default Lokasi (Akan ditimpa Admin)
        let SEKOLAH_LAT = -7.6739830; 
        let SEKOLAH_LNG = 109.6319560;

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            // Cek Session
            const sess = sessionStorage.getItem('user_siganteng');
            if (sess) {
                userGuru = JSON.parse(sess);
                initDashboard();
                syncAdmin();
                cekGPS();
                loadDaftarKelas(); // Panggil fungsi otomatis
                
                // Cek Wali Kelas
                if(userGuru.wali_kelas && userGuru.wali_kelas !== "-") {
                    initWaliKelas(userGuru.wali_kelas);
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        function initDashboard() {
            document.getElementById('nama-guru').innerText = userGuru.nama;
            document.getElementById('nip-guru').innerText = "NIP/NUPTK: " + userGuru.username;
            document.getElementById('foto-guru').src = `https://ui-avatars.com/api/?name=${userGuru.nama}&background=10b981&color=fff&bold=true`;
        }

        // --- 1. SYNC ADMIN (RADIUS) ---
        function syncAdmin() {
            onSnapshot(doc(db, "pengaturan", "sekolah"), (snap) => {
                if(snap.exists()) {
                    configSekolah = snap.data();
                    if(configSekolah.lokasi_lat) SEKOLAH_LAT = configSekolah.lokasi_lat;
                    if(configSekolah.lokasi_lng) SEKOLAH_LNG = configSekolah.lokasi_lng;
                }
            });
        }

        // --- 2. GPS LOGIC ---
        function cekGPS() {
            if(navigator.geolocation) {
                navigator.geolocation.watchPosition((p) => {
                    lokasiUser = { lat: p.coords.latitude, lng: p.coords.longitude };
                    // Hitung Jarak Manual
                    const R = 6371e3; 
                    const φ1 = lokasiUser.lat * Math.PI/180;
                    const φ2 = SEKOLAH_LAT * Math.PI/180;
                    const Δφ = (SEKOLAH_LAT - lokasiUser.lat) * Math.PI/180;
                    const Δλ = (SEKOLAH_LNG - lokasiUser.lng) * Math.PI/180;
                    const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                    const d = R * c;

                    const box = document.getElementById('jarakBox');
                    const limit = configSekolah.radius_meter || 50;
                    
                    if(configSekolah.validasi_gps_aktif && d > limit) {
                        box.innerHTML = `<span class="text-red-500 font-bold">Lokasi: ${Math.round(d)}m (Luar Area)</span>`;
                    } else {
                        box.innerHTML = `<span class="text-emerald-500 font-bold">Lokasi Valid: ${Math.round(d)}m</span>`;
                    }
                }, null, { enableHighAccuracy: true });
            }
        }

        // --- 3. ABSENSI CORE ---
        window.prosesAbsen = (tipe) => {
            if(!lokasiUser) return Swal.fire('GPS','Sedang mencari lokasi...','info');
            // Validasi Jarak Dummy
            const map = L.map(document.createElement('div')); 
            const d = map.distance([lokasiUser.lat, lokasiUser.lng], [SEKOLAH_LAT, SEKOLAH_LNG]);
            
            if(configSekolah.validasi_gps_aktif && d > (configSekolah.radius_meter || 50)) {
                return Swal.fire('Kejauhan!', 'Bapak/Ibu belum di area sekolah.', 'error');
            }

            tipeAbsenAktif = tipe;
            document.getElementById('modalKamera').classList.remove('hidden');
            navigator.mediaDevices.getUserMedia({video: {facingMode: 'user'}}).then(s => {
                streamKamera = s; document.getElementById('videoStream').srcObject = s;
            });
        }

        window.tutupKamera = () => {
            document.getElementById('modalKamera').classList.add('hidden');
            if(streamKamera) streamKamera.getTracks().forEach(t=>t.stop());
        }

        window.jepret = async () => {
            const vid = document.getElementById('videoStream');
            const can = document.getElementById('canvasFoto');
            can.width = 480; can.height = 480;
            can.getContext('2d').drawImage(vid,0,0,480,480);
            const foto = can.toDataURL('image/jpeg', 0.7);
            
            const todayStr = new Date().toLocaleDateString('fr-CA');
            const idDoc = `${todayStr}_${userGuru.username}`; 
            
            try {
                tutupKamera();
                Swal.fire({title:'Menyimpan...', didOpen:()=>Swal.showLoading()});
                
                const snap = await uploadString(ref(storage, `absen_guru/${todayStr}/${userGuru.username}_${tipeAbsenAktif}.jpg`), foto, 'data_url');
                const url = await getDownloadURL(snap.ref);

                let data = {
                    nisn: userGuru.username,
                    nama: userGuru.nama,
                    kelas: 'GURU',
                    role: 'guru',
                    tanggal: todayStr,
                    status_terakhir: tipeAbsenAktif + " (Guru)"
                };

                if(tipeAbsenAktif === 'Masuk') {
                    data.jam_masuk = serverTimestamp();
                    data.foto_masuk = url;
                } else {
                    data.jam_pulang = serverTimestamp();
                    data.foto_pulang = url;
                }

                await setDoc(doc(db, "absensi", idDoc), data, {merge: true});
                document.getElementById('status-absen').innerText = "Sudah " + tipeAbsenAktif;
                document.getElementById('status-absen').className = "text-[10px] font-bold bg-emerald-100 text-emerald-600 px-3 py-1 rounded-full";
                
                Swal.fire('Berhasil', 'Presensi terekam.', 'success');

            } catch(e) { Swal.fire('Error', e.message, 'error'); }
        }

        // --- 4. JURNAL MENGAJAR (OTOMATIS DARI DATABASE) ---
        async function loadDaftarKelas() {
            const sel = document.getElementById('jurnal-kelas');
            sel.innerHTML = '<option value="">Sedang memuat data kelas...</option>';

            try {
                const q = query(collection(db, "users"), where("role", "==", "siswa"));
                const snap = await getDocs(q);
                
                const kelasUnik = new Set();
                snap.forEach(doc => {
                    const data = doc.data();
                    if (data.kelas && data.kelas.trim() !== "" && data.kelas !== "-") {
                        kelasUnik.add(data.kelas.toUpperCase().trim());
                    }
                });

                const kelasSorted = Array.from(kelasUnik).sort();
                sel.innerHTML = '<option value="">- Pilih Kelas (Realtime) -</option>';
                
                if (kelasSorted.length === 0) {
                    sel.innerHTML += '<option value="" disabled>Belum ada data siswa</option>';
                } else {
                    kelasSorted.forEach(k => {
                        const opt = document.createElement('option');
                        opt.value = k;
                        opt.text = k;
                        sel.add(opt);
                    });
                }
            } catch (e) {
                console.error("Gagal load kelas:", e);
                sel.innerHTML = '<option value="">Gagal memuat data</option>';
            }
        }

        window.kirimJurnal = async () => {
            const kls = document.getElementById('jurnal-kelas').value;
            const mapel = document.getElementById('jurnal-mapel').value;
            const materi = document.getElementById('jurnal-materi').value;

            if(!kls || !mapel || !materi) return Swal.fire('Isi Lengkap','','warning');

            try {
                await addDoc(collection(db, "jurnal_guru"), {
                    nip: userGuru.username,
                    nama_guru: userGuru.nama,
                    kelas: kls,
                    mapel: mapel,
                    materi: materi,
                    waktu: serverTimestamp(),
                    tanggal: new Date().toLocaleDateString('fr-CA')
                });
                Swal.fire('Tersimpan', 'Jurnal berhasil diupload.', 'success');
                document.getElementById('jurnal-materi').value = '';
            } catch(e) { Swal.fire('Gagal', e.message, 'error'); }
        }

        // --- 5. WALI KELAS MODE ---
        function initWaliKelas(kelasWali) {
            document.getElementById('panel-wali-kelas').classList.remove('hidden');
            document.getElementById('nama-kelas-wali').innerText = kelasWali;
            document.getElementById('badge-wali').classList.remove('hidden');

            const todayStr = new Date().toLocaleDateString('fr-CA');
            const q = query(collection(db, "absensi"), where("tanggal", "==", todayStr), where("kelas", "==", kelasWali));
            
            onSnapshot(q, (snap) => {
                let h=0, i=0;
                snap.forEach(d => {
                    const st = d.data().status_terakhir;
                    if(st.includes("Masuk") || st.includes("Hadir")) h++;
                    else if(st.includes("Sakit") || st.includes("Izin")) i++;
                });
                document.getElementById('wali-hadir').innerText = h;
                document.getElementById('wali-izin').innerText = i;
                document.getElementById('wali-alpha').innerText = "?"; 
            });
        }

        window.lihatDetailKelas = () => {
            Swal.fire('Info', 'Fitur detail siswa akan segera hadir di update v2.0', 'info');
        }

        window.logout = () => {
            sessionStorage.clear(); localStorage.clear();
            window.location.href = 'index.html';
        }
    </script>
    
</body>
</html>
