<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Guru - SiGanteng (Akademik)</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .glass-header { background: linear-gradient(135deg, #0f172a 0%, #334155 100%); }
        .modal { opacity: 0; visibility: hidden; transition: all 0.3s ease-in-out; }
        .modal.active { opacity: 1; visibility: visible; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom Radio Button Absensi */
        .radio-label input { display: none; }
        .radio-label span { display: inline-block; padding: 4px 10px; border-radius: 8px; font-size: 10px; font-weight: bold; cursor: pointer; border: 1px solid #e2e8f0; color: #94a3b8; }
        
        /* WARNA TOMBOL STATUS */
        .radio-label input:checked + span.opt-h { background-color: #d1fae5; color: #059669; border-color: #10b981; } /* Hijau */
        .radio-label input:checked + span.opt-s { background-color: #dbeafe; color: #2563eb; border-color: #3b82f6; } /* Biru */
        .radio-label input:checked + span.opt-i { background-color: #ffedd5; color: #ea580c; border-color: #f97316; } /* Oranye */
        .radio-label input:checked + span.opt-a { background-color: #fee2e2; color: #dc2626; border-color: #ef4444; } /* Merah */
        .radio-label input:checked + span.opt-d { background-color: #f3e8ff; color: #7e22ce; border-color: #a855f7; } /* Ungu (Dispen) */
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col pb-24">

    <input type="file" id="fileInputJurnal" accept="image/*" style="display:none" onchange="handleFileSelect(this)">

    <header class="glass-header p-6 pb-24 rounded-b-[2.5rem] shadow-xl relative z-10 text-white">
        <div class="flex justify-between items-start mb-6" id="header-top-row">
            <div>
                <p class="text-slate-300 text-[10px] font-bold uppercase tracking-[0.2em]">Panel Pendidik</p>
                <h1 class="text-2xl font-black">SiGanteng <span class="text-emerald-400">Guru</span></h1>
            </div>
            
            <div class="flex gap-2">
                <button onclick="logout()" class="bg-white/10 p-2 rounded-full hover:bg-red-500 transition"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <div class="relative group cursor-pointer active:scale-95 transition" onclick="bukaKameraProfil()">
                <div class="w-16 h-16 rounded-2xl bg-white p-1 shadow-lg">
                    <img id="foto-guru" src="" class="w-full h-full rounded-xl object-cover" onerror="this.src='https://ui-avatars.com/api/?background=random&color=fff'">
                </div>
                <div class="absolute -bottom-2 -right-2 bg-blue-600 text-white p-1.5 rounded-lg border-2 border-white shadow-sm">
                    <i data-lucide="camera" class="w-3 h-3"></i>
                </div>
            </div>
            <div>
                <h2 id="nama-guru" class="text-lg font-bold leading-tight">...</h2>
                <p id="nip-guru" class="text-xs font-mono text-slate-300 mt-1">...</p>
                <div id="badge-wali" class="hidden mt-2 inline-block bg-orange-500 text-white text-[9px] font-black px-2 py-0.5 rounded">WALI KELAS</div>
            </div>
        </div>
    </header>

    <main class="flex-1 px-5 -mt-16 relative z-20 space-y-6">

        <div id="section-menu-dinamis" class="hidden bg-white p-4 rounded-[2rem] shadow-lg border border-slate-100">
            <h3 class="font-bold text-slate-700 text-sm mb-3 ml-1 flex items-center gap-2">
                <i data-lucide="grid" class="w-4 h-4 text-blue-500"></i> Layanan Guru & Staf
            </h3>
            <div id="grid-menu-dinamis" class="grid grid-cols-2 gap-3"></div>
        </div>

        <div id="panel-wali-kelas" class="hidden bg-orange-50 p-6 rounded-[2rem] shadow-lg border border-orange-100 relative overflow-hidden">
            <div class="absolute -right-5 -top-5 w-24 h-24 bg-orange-200 rounded-full opacity-20 blur-xl"></div>
            <h3 class="font-bold text-orange-800 text-sm uppercase tracking-widest mb-2 flex items-center gap-2">
                <i data-lucide="shield-check" class="w-4 h-4"></i> Kelas Anda: <span id="nama-kelas-wali">...</span>
            </h3>
            
            <div class="grid grid-cols-3 gap-2 text-center mt-4 mb-4">
                <div class="bg-white p-3 rounded-xl shadow-sm border border-emerald-100"><h4 class="text-emerald-500 font-black text-xl" id="wali-hadir">0</h4><p class="text-[9px] font-bold text-slate-400">HADIR</p></div>
                <div class="bg-white p-3 rounded-xl shadow-sm border border-blue-100"><h4 class="text-blue-500 font-black text-xl" id="wali-izin">0</h4><p class="text-[9px] font-bold text-slate-400">IZIN</p></div>
                <div class="bg-white p-3 rounded-xl shadow-sm border border-red-100"><h4 class="text-red-500 font-black text-xl" id="wali-alpha">0</h4><p class="text-[9px] font-bold text-slate-400">ALPHA</p></div>
            </div>
            
            <button onclick="bukaModalWali()" class="w-full bg-white text-orange-600 border border-orange-200 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-orange-600 hover:text-white transition shadow-sm flex items-center justify-center gap-2">
                <i data-lucide="eye" class="w-3 h-3"></i> CEK STATUS SISWA
            </button>
        </div>

        <div class="bg-white p-6 rounded-[2rem] shadow-lg border border-slate-100">
            <h3 class="font-bold text-slate-700 text-sm uppercase tracking-widest mb-4 flex items-center gap-2">
                <i data-lucide="book-open" class="w-4 h-4 text-blue-500"></i> Jurnal Mengajar
            </h3>
            
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 ml-1">MULAI JAM KE-</label>
                        <select id="jam-mulai" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-xs font-bold text-slate-600 outline-none transition focus:border-blue-500">
                            <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                            <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
                            <option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 ml-1">SAMPAI JAM KE-</label>
                        <select id="jam-selesai" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-xs font-bold text-slate-600 outline-none transition focus:border-blue-500">
                            <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                            <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
                            <option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option>
                        </select>
                    </div>
                </div>

                <select id="jurnal-kelas" onchange="loadSiswaUntukAbsen()" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-xs font-bold text-slate-600 outline-none transition focus:border-blue-500">
                    <option value="">- Pilih Kelas -</option>
                </select>
                
                <select id="jurnal-mapel" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-xs font-bold text-slate-600 outline-none transition focus:border-blue-500">
                    <option value="">- Pilih Mapel -</option>
                </select>

                <div id="area-absen-mapel" class="hidden bg-slate-50 p-4 rounded-xl border border-slate-200 max-h-60 overflow-y-auto">
                    <h4 class="text-xs font-bold text-slate-500 mb-3 flex justify-between items-center sticky top-0 bg-slate-50 pb-2 border-b border-slate-200">
                        <span>Absensi Jam Ini</span>
                        <span id="jml-siswa-mapel" class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded text-[9px]">0 Siswa</span>
                    </h4>
                    <p class="text-[9px] text-slate-400 mb-2 italic">*Klik D untuk Dispensasi.</p>
                    <div id="list-absen-mapel" class="space-y-2"></div>
                </div>

                <textarea id="jurnal-materi" rows="2" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-xs font-bold text-slate-600 outline-none transition focus:border-blue-500" placeholder="Materi / Bahasan Hari Ini..."></textarea>
                
                <div class="flex items-center gap-2">
                    <button onclick="bukaKameraJurnal()" class="bg-slate-100 p-3 rounded-xl border border-slate-200 text-slate-600 hover:bg-slate-200 transition flex items-center gap-2">
                        <i data-lucide="camera" class="w-5 h-5"></i> <span class="text-xs font-bold">Kamera</span>
                    </button>
                    <button onclick="document.getElementById('fileInputJurnal').click()" class="bg-indigo-50 p-3 rounded-xl border border-indigo-100 text-indigo-600 hover:bg-indigo-100 transition flex items-center gap-2">
                        <i data-lucide="image-plus" class="w-5 h-5"></i> <span class="text-xs font-bold">Upload Galeri</span>
                    </button>
                    <div id="preview-foto-jurnal" class="text-xs text-slate-400 italic ml-2">Wajib foto bukti.</div>
                </div>
                <img id="img-preview-upload" src="" class="hidden w-full h-40 object-cover rounded-xl border border-slate-200 mt-2">

                <button onclick="kirimJurnal()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold text-xs shadow-lg shadow-blue-500/30 active:scale-95 transition">SIMPAN JURNAL</button>
            </div>

            <div class="mt-4 pt-4 border-t border-slate-100">
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 ml-1">DARI TANGGAL</label>
                        <input type="date" id="filter-mulai" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-xs font-bold text-slate-600 outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 ml-1">SAMPAI TANGGAL</label>
                        <input type="date" id="filter-selesai" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-xs font-bold text-slate-600 outline-none focus:border-blue-500">
                    </div>
                </div>
                <button onclick="downloadRekapJurnal()" class="w-full bg-emerald-50 text-emerald-700 py-3 rounded-xl font-bold text-xs border border-emerald-100 hover:bg-emerald-100 transition flex items-center justify-center gap-2">
                    <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> DOWNLOAD JURNAL
                </button>
            </div>

            <div class="mt-4 pt-4 border-t border-slate-100">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-bold text-xs text-slate-400 uppercase">Riwayat Hari Ini</h4>
                </div>
                <div id="list-riwayat-jurnal" class="space-y-2">
                    <div class="text-center text-slate-300 text-xs italic py-2">Belum ada jurnal hari ini.</div>
                </div>
            </div>
        </div>

    </main>

    <div id="modal-wali" class="modal fixed inset-0 z-50 flex items-center justify-center bg-slate-900/90 backdrop-blur-sm p-4">
        <div class="modal-content bg-white w-full max-w-lg rounded-3xl overflow-hidden shadow-2xl flex flex-col max-h-[90vh]">
            <div class="bg-orange-50 p-4 border-b border-orange-100 flex justify-between items-center shrink-0">
                <h3 class="font-bold text-orange-800">Detail Kelas <span id="judul-modal-wali"></span></h3>
                <button onclick="tutupModalWali()" class="p-2 bg-white rounded-full text-slate-400 hover:text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div class="bg-white p-2 border-b border-slate-100 flex justify-between text-[10px] font-bold text-slate-500 px-4 shrink-0">
                <span>NAMA SISWA</span>
                <span>STATUS / JAM</span>
            </div>
            <div class="overflow-y-auto p-4 space-y-2 bg-slate-50 flex-1" id="list-siswa-wali">
                <div class="text-center py-10 text-slate-400 italic">Memuat data...</div>
            </div>
        </div>
    </div>

    <div id="modalKamera" class="hidden fixed inset-0 z-50 bg-black flex flex-col items-center justify-center">
        <div class="absolute top-0 w-full p-6 flex justify-between z-30">
            <h3 id="judul-kamera" class="text-white font-bold bg-black/50 px-3 py-1 rounded-full text-xs">KAMERA</h3>
            <button onclick="tutupKamera()" class="text-white"><i data-lucide="x" class="w-8 h-8"></i></button>
        </div>
        <div class="relative w-full h-full bg-black">
            <video id="videoStream" autoplay playsinline muted class="w-full h-full object-cover"></video>
            <canvas id="canvasFoto" class="hidden"></canvas>
        </div>
        <div class="absolute bottom-10 z-30 flex items-center gap-6">
            <button onclick="gantiKamera()" class="w-12 h-12 rounded-full bg-white/20 backdrop-blur border border-white/30 text-white flex items-center justify-center hover:bg-white/40"><i data-lucide="refresh-ccw" class="w-6 h-6"></i></button>
            <button onclick="jepret()" class="w-16 h-16 bg-white rounded-full border-4 border-slate-300 shadow-xl active:scale-95 transition"></button>
            <div class="w-12"></div> 
        </div>
    </div>

    <div id="loading" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center">
        <div class="animate-spin rounded-full h-10 w-10 border-4 border-white border-t-transparent"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, where, getDocs, addDoc, serverTimestamp, orderBy, limit, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

        const firebaseConfig = { apiKey: "AIzaSyBXWR-_aJyoMrUjTeNQYlcPD8p3eu58yOo", authDomain: "siganteng-absensi.firebaseapp.com", databaseURL: "https://siganteng-absensi-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "siganteng-absensi", storageBucket: "siganteng-absensi.firebasestorage.app", messagingSenderId: "917873420012", appId: "1:917873420012:web:0fe1a9eddc5f94959ba7c9" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // --- ðŸ›¡ï¸ SATPAM GURU ---
        onSnapshot(doc(db, "pengaturan", "akses_global"), (snap) => {
            if (snap.exists()) {
                const akses = snap.data();
                if (akses.guru === false) {
                    document.body.innerHTML = `<div style="height:100vh; background:#0f172a; color:white; display:flex; flex-direction:column; justify-content:center; align-items:center; font-family:sans-serif; text-align:center;"><div style="font-size:4rem; margin-bottom:1rem;">â›”</div><h1 style="font-weight:900; font-size:2rem;">PANEL DITUTUP</h1><p style="color:#94a3b8; margin-bottom:2rem;">Akses Guru sedang dinonaktifkan sementara.<br>Hubungi Admin IT.</p><button onclick="window.location.href='index.html'" style="background:#f59e0b; color:black; border:none; padding:12px 30px; border-radius:12px; font-weight:bold; cursor:pointer;">LOGOUT</button></div>`;
                }
            }
        });
        const storage = getStorage(app);

        let userGuru = null;
        let streamKamera = null;
        let tipeAbsenAktif = "";
        let fotoBuktiJurnal = null;
        let dataSiswaWali = [];
        let dataAbsenWali = {};
        let currentFacingMode = 'environment';
        
        let cacheSiswaPerKelas = {}; 
        let unsubscribeWali = null; 

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            const sess = sessionStorage.getItem('user_siganteng');
            if (sess) {
                userGuru = JSON.parse(sess);
                initDashboard();
                loadDaftarKelas();
                loadDaftarMapel();
                loadRiwayatJurnal();
                loadMenuDinamis();
                
                const rolesPejabat = ['kurikulum', 'super', 'admin', 'bk']; 
                if (rolesPejabat.includes(userGuru.role)) { tampilkanTombolPortal(userGuru.role); }

                if(userGuru.wali_kelas && userGuru.wali_kelas !== "-") { initWaliKelas(userGuru.wali_kelas); } 
                else {
                    getDoc(doc(db, "guru", userGuru.username)).then(snap => {
                        if(snap.exists()){
                            const d = snap.data();
                            if(d.wali_kelas && d.wali_kelas !== "-") {
                                userGuru.wali_kelas = d.wali_kelas;
                                sessionStorage.setItem('user_siganteng', JSON.stringify(userGuru));
                                initWaliKelas(d.wali_kelas);
                            }
                        }
                    });
                }
                
                history.pushState(null, null, location.href); 
                window.onpopstate = function () {
                    if(!document.getElementById('modalKamera').classList.contains('hidden')) { tutupKamera(); history.pushState(null, null, location.href); return; }
                    if(document.getElementById('modal-wali').classList.contains('active')) { tutupModalWali(); history.pushState(null, null, location.href); return; }
                    history.pushState(null, null, location.href);
                };

            } else { window.location.href = 'index.html'; }
        });

        // --- FUNGSI UPLOAD FOTO DARI GALERI ---
        window.handleFileSelect = (input) => {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                
                Swal.fire({title: 'Memproses...', didOpen: () => Swal.showLoading()});

                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        // KOMPRESI GAMBAR (Biar hemat kuota)
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800; // Resize ke 800px
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        // Convert ke DataURL (Quality 0.6)
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.6);
                        
                        fotoBuktiJurnal = compressedDataUrl;
                        document.getElementById('preview-foto-jurnal').innerText = "Foto Galeri Siap âœ”";
                        document.getElementById('preview-foto-jurnal').className = "text-xs text-indigo-600 font-bold italic ml-2";
                        
                        // Tampilkan Preview
                        const imgPrev = document.getElementById('img-preview-upload');
                        imgPrev.src = compressedDataUrl;
                        imgPrev.classList.remove('hidden');
                        
                        Swal.close();
                    }
                }
                reader.readAsDataURL(file);
            }
        }

        function tampilkanTombolPortal(role) {
            let label = ""; let link = ""; let warnaBtn = "bg-yellow-500/20 text-yellow-400 border-yellow-500"; 
            if (role === 'bk') { label = "PANEL BK"; link = "adminBK.html"; warnaBtn = "bg-emerald-500/20 text-emerald-600 border-emerald-500"; } 
            else if (role === 'kurikulum') { label = "PANEL WAKA"; link = "adminKBM.html"; } 
            else if (role === 'super' || role === 'admin') { label = "MASTER CONTROL"; link = "admin.html"; warnaBtn = "bg-blue-500/20 text-blue-600 border-blue-500"; }

            const headerDiv = document.querySelector('#header-top-row div.flex');
            const btn = document.createElement('button');
            btn.className = `${warnaBtn} px-3 py-1.5 rounded-full text-[10px] font-bold border mr-2 hover:bg-opacity-100 hover:text-white transition flex items-center gap-1 shadow-sm`;
            btn.innerHTML = `<i data-lucide='layout-dashboard' class='w-3 h-3'></i> ${label}`;
            btn.onclick = () => window.location.href = link;
            const btnLogout = headerDiv.querySelector('button'); 
            headerDiv.insertBefore(btn, btnLogout);
            lucide.createIcons();
        }

        function initDashboard() { 
            document.getElementById('nama-guru').innerText = userGuru.nama; 
            document.getElementById('nip-guru').innerText = "NIP: " + userGuru.username; 
            getDoc(doc(db, "guru", userGuru.username)).then(snap => {
                if(snap.exists() && snap.data().foto_profil) document.getElementById('foto-guru').src = snap.data().foto_profil;
            });
        }

       async function initWaliKelas(kelasWali) {
            document.getElementById('panel-wali-kelas').classList.remove('hidden');
            document.getElementById('nama-kelas-wali').innerText = kelasWali;
            document.getElementById('badge-wali').classList.remove('hidden');
            document.getElementById('judul-modal-wali').innerText = kelasWali;

            if(!cacheSiswaPerKelas[kelasWali]) {
                const qSiswa = query(collection(db, "users"), where("kelas", "==", kelasWali), where("role", "==", "siswa"));
                const snap = await getDocs(qSiswa);
                dataSiswaWali = [];
                snap.forEach(doc => dataSiswaWali.push(doc.data())); 
                cacheSiswaPerKelas[kelasWali] = dataSiswaWali;
            } else { dataSiswaWali = cacheSiswaPerKelas[kelasWali]; }
            pantauAbsenWali(kelasWali); 
        }

        function pantauAbsenWali(kelasWali) {
            if(unsubscribeWali) unsubscribeWali(); 
            const todayStr = new Date().toLocaleDateString('fr-CA');
            const q = query(collection(db, "absensi"), where("tanggal", "==", todayStr), where("kelas", "==", kelasWali));
            unsubscribeWali = onSnapshot(q, (snap) => {
                let h=0, i=0; dataAbsenWali = {};
                snap.forEach(doc => {
                    const d = doc.data(); dataAbsenWali[d.nisn] = d;
                    const st = d.status_terakhir || "";
                    if(st.includes("Masuk") || st.includes("Hadir") || d.jam_masuk) h++;
                    else if(st.includes("Sakit") || st.includes("Izin")) i++;
                });
                document.getElementById('wali-hadir').innerText = h;
                document.getElementById('wali-izin').innerText = i;
                document.getElementById('wali-alpha').innerText = dataSiswaWali.length - (h + i);
                if(document.getElementById('modal-wali').classList.contains('active')) { renderListWali(); }
            });
        }

        window.bukaModalWali = async () => { document.getElementById('modal-wali').classList.add('active'); if(userGuru.wali_kelas) pantauAbsenWali(userGuru.wali_kelas); renderListWali(); }
        window.tutupModalWali = () => { document.getElementById('modal-wali').classList.remove('active'); }

        function renderListWali() {
            const container = document.getElementById('list-siswa-wali');
            container.innerHTML = '';
            if(dataSiswaWali.length === 0) { container.innerHTML = '<div class="text-center text-slate-400">Data siswa kosong.</div>'; return; }
            dataSiswaWali.sort((a,b) => a.nama.localeCompare(b.nama));
            dataSiswaWali.forEach(s => {
                const absen = dataAbsenWali[s.username]; 
                let statusHtml = `<span class="text-[10px] font-bold bg-slate-200 text-slate-500 px-2 py-0.5 rounded">Belum Absen</span>`;
                let borderClass = "border-slate-100";
                if(absen) {
                    const st = absen.status_terakhir || "";
                    if(absen.jam_masuk) {
                        const jam = new Date(absen.jam_masuk.seconds * 1000).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
                        statusHtml = `<span class="text-[10px] font-bold bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded">Masuk: ${jam}</span>`;
                        borderClass = "border-emerald-200 bg-emerald-50/20";
                    } else if(st.includes("Sakit")) {
                        statusHtml = `<span class="text-[10px] font-bold bg-blue-100 text-blue-600 px-2 py-0.5 rounded">Sakit</span>`; borderClass = "border-blue-200 bg-blue-50/20";
                    } else if(st.includes("Izin")) {
                        statusHtml = `<span class="text-[10px] font-bold bg-orange-100 text-orange-600 px-2 py-0.5 rounded">Izin</span>`; borderClass = "border-orange-200 bg-orange-50/20";
                    }
                }
                const fotoSrc = `https://ui-avatars.com/api/?name=${s.nama}&background=random&color=fff`;
                container.innerHTML += `<div class="flex items-center justify-between bg-white p-2 rounded-xl border ${borderClass} mb-2 shadow-sm"><div class="flex items-center gap-3"><img src="${fotoSrc}" class="w-8 h-8 rounded-full object-cover bg-slate-200"><div class="font-bold text-xs text-slate-700 truncate w-40">${s.nama}</div></div><div>${statusHtml}</div></div>`;
            });
        }

        window.loadSiswaUntukAbsen = async () => {
            const kls = document.getElementById('jurnal-kelas').value;
            const container = document.getElementById('list-absen-mapel');
            const area = document.getElementById('area-absen-mapel');
            if (!kls) { area.classList.add('hidden'); return; }
            area.classList.remove('hidden');
            if (cacheSiswaPerKelas[kls]) { renderSiswaAbsen(cacheSiswaPerKelas[kls]); return; }
            container.innerHTML = '<div class="text-center text-xs text-slate-400 italic">Memuat siswa...</div>';
            const q = query(collection(db, "users"), where("kelas", "==", kls), where("role", "==", "siswa"));
            const snap = await getDocs(q);
            let siswaArr = []; snap.forEach(doc => siswaArr.push(doc.data())); siswaArr.sort((a,b) => a.nama.localeCompare(b.nama));
            cacheSiswaPerKelas[kls] = siswaArr;
            renderSiswaAbsen(siswaArr);
        }

        function renderSiswaAbsen(siswaArr) {
            const container = document.getElementById('list-absen-mapel');
            container.innerHTML = '';
            document.getElementById('jml-siswa-mapel').innerText = siswaArr.length + ' Siswa';
            if(siswaArr.length === 0) { container.innerHTML = '<div class="text-center text-xs text-slate-400">Tidak ada siswa.</div>'; return; }
            siswaArr.forEach(s => {
                const id = s.username; 
                container.innerHTML += `<div class="flex items-center justify-between bg-white p-2 rounded-lg border border-slate-100 siswa-item" data-nisn="${id}" data-nama="${s.nama}"><span class="text-xs font-bold text-slate-700 truncate w-32">${s.nama}</span><div class="flex gap-1"><label class="radio-label"><input type="radio" name="absen_${id}" value="H" checked><span class="opt-h">H</span></label><label class="radio-label"><input type="radio" name="absen_${id}" value="S"><span class="opt-s">S</span></label><label class="radio-label"><input type="radio" name="absen_${id}" value="I"><span class="opt-i">I</span></label><label class="radio-label"><input type="radio" name="absen_${id}" value="A"><span class="opt-a">A</span></label><label class="radio-label"><input type="radio" name="absen_${id}" value="D"><span class="opt-d">D</span></label></div></div>`;
            });
        }

        async function loadDaftarKelas() { const sel = document.getElementById('jurnal-kelas'); const cachedKelas = localStorage.getItem('cache_list_kelas'); if(cachedKelas) { renderOptions(sel, JSON.parse(cachedKelas)); return; } try { const q = query(collection(db, "users"), where("role", "==", "siswa")); const snap = await getDocs(q); const kelasUnik = new Set(); snap.forEach(doc => { const d = doc.data(); if(d.kelas && d.kelas !== "-") kelasUnik.add(d.kelas.toUpperCase().trim()); }); const listArr = Array.from(kelasUnik).sort(); localStorage.setItem('cache_list_kelas', JSON.stringify(listArr)); renderOptions(sel, listArr); } catch (e) { console.error(e); } }
        async function loadDaftarMapel() { const sel = document.getElementById('jurnal-mapel'); const cachedMapel = localStorage.getItem('cache_list_mapel'); if(cachedMapel) { renderOptions(sel, JSON.parse(cachedMapel)); return; } try { const q = query(collection(db, "mata_pelajaran"), orderBy("nama", "asc")); const snap = await getDocs(q); const listArr = []; snap.forEach(doc => listArr.push(doc.data().nama)); localStorage.setItem('cache_list_mapel', JSON.stringify(listArr)); renderOptions(sel, listArr); } catch (e) { console.error(e); } }
        function renderOptions(selectEl, arrayData) { selectEl.innerHTML = '<option value="">- Pilih -</option>'; arrayData.forEach(item => selectEl.add(new Option(item, item))); }

        function loadMenuDinamis() { const container = document.getElementById('grid-menu-dinamis'); const sec = document.getElementById('section-menu-dinamis'); onSnapshot(query(collection(db, "menu_dinamis"), orderBy("created_at", "asc")), (snap) => { container.innerHTML = ''; let ada = false; snap.forEach(d => { const dt = d.data(); if (dt.target === 'guru' || dt.target === 'umum') { ada = true; const style = dt.highlight ? "bg-indigo-50 text-indigo-700 border-indigo-200" : "bg-white text-slate-700 border-slate-100"; container.innerHTML += `<a href="${dt.link}" target="_blank" class="${style} p-4 border rounded-2xl flex flex-col items-center gap-2 shadow-sm active:scale-95 transition"><div class="text-xl">${dt.icon}</div><span class="text-[10px] font-bold uppercase">${dt.judul}</span></a>`; } }); if(ada) sec.classList.remove('hidden'); else sec.classList.add('hidden'); }); }

        async function initKamera(mode) { if(streamKamera) streamKamera.getTracks().forEach(t=>t.stop()); try { streamKamera = await navigator.mediaDevices.getUserMedia({ video: { facingMode: mode } }); document.getElementById('videoStream').srcObject = streamKamera; } catch(e) { Swal.fire('Error', 'Gagal akses kamera: '+e.message, 'error'); } }
        window.bukaKameraProfil = () => { tipeAbsenAktif = "ProfilGuru"; document.getElementById('judul-kamera').innerText = "SELFIE PROFIL"; document.getElementById('modalKamera').classList.remove('hidden'); currentFacingMode='user'; initKamera(currentFacingMode); }
        window.bukaKameraJurnal = () => { tipeAbsenAktif = "Jurnal"; document.getElementById('judul-kamera').innerText = "FOTO BUKTI KBM"; document.getElementById('modalKamera').classList.remove('hidden'); currentFacingMode='environment'; initKamera(currentFacingMode); }
        window.tutupKamera = () => { document.getElementById('modalKamera').classList.add('hidden'); if(streamKamera) streamKamera.getTracks().forEach(t=>t.stop()); }
        window.gantiKamera = () => { currentFacingMode = (currentFacingMode === 'user') ? 'environment' : 'user'; initKamera(currentFacingMode); }
        window.jepret = async () => { const vid = document.getElementById('videoStream'); const can = document.getElementById('canvasFoto'); can.width = 480; can.height = 480; can.getContext('2d').drawImage(vid,0,0,480,480); const foto = can.toDataURL('image/jpeg', 0.7); if(tipeAbsenAktif === 'ProfilGuru') { try { tutupKamera(); Swal.fire({title:'Mengupdate Profil...', didOpen:()=>Swal.showLoading()}); const snap = await uploadString(ref(storage, `profil_guru/${userGuru.username}.jpg`), foto, 'data_url'); const url = await getDownloadURL(snap.ref); await setDoc(doc(db, "guru", userGuru.username), { foto_profil: url, updated_at: serverTimestamp() }, { merge: true }); Swal.fire('Cakep!', 'Foto profil berhasil diperbarui.', 'success'); } catch(e) { Swal.fire('Gagal', e.message, 'error'); } return; } if(tipeAbsenAktif === 'Jurnal') { fotoBuktiJurnal = foto; document.getElementById('preview-foto-jurnal').innerText = "Foto Siap âœ”"; document.getElementById('preview-foto-jurnal').className = "text-xs text-green-600 font-bold italic ml-2"; tutupKamera(); 
            // Tampilkan Preview
            const imgPrev = document.getElementById('img-preview-upload'); imgPrev.src = foto; imgPrev.classList.remove('hidden'); return; } }

        window.kirimJurnal = async () => { 
            const kls = document.getElementById('jurnal-kelas').value; const mapel = document.getElementById('jurnal-mapel').value; const materi = document.getElementById('jurnal-materi').value; 
            const jamMulai = document.getElementById('jam-mulai').value; const jamSelesai = document.getElementById('jam-selesai').value;
            if(!kls || !mapel || !materi) return Swal.fire('Lengkapi','Kelas, Mapel, dan Materi wajib diisi','warning'); 
            if(!fotoBuktiJurnal) return Swal.fire('Wajib Foto','Lampirkan foto bukti KBM','warning'); 
            let absensiSiswa = []; document.querySelectorAll('.siswa-item').forEach(el => { const nisn = el.getAttribute('data-nisn'); const nama = el.getAttribute('data-nama'); const status = document.querySelector(`input[name="absen_${nisn}"]:checked`).value; absensiSiswa.push({ nisn, nama, status }); });
            document.getElementById('loading').classList.remove('hidden'); 
            try { 
                const todayStr = new Date().toLocaleDateString('fr-CA'); 
                const snap = await uploadString(ref(storage, `jurnal_guru/${todayStr}/${userGuru.username}_${Date.now()}.jpg`), fotoBuktiJurnal, 'data_url'); 
                const urlFoto = await getDownloadURL(snap.ref); 
                await addDoc(collection(db, "jurnal_guru"), { nip: userGuru.username, nama_guru: userGuru.nama, kelas: kls, mapel: mapel, materi: materi, foto_bukti: urlFoto, waktu: serverTimestamp(), tanggal: todayStr, absensi_mapel: absensiSiswa, jam_ke: `${jamMulai} - ${jamSelesai}`, rekap_refleksi_string: "" }); 
                Swal.fire('Tersimpan', 'Jurnal berhasil diupload.', 'success'); 
                document.getElementById('jurnal-materi').value = ''; fotoBuktiJurnal = null; 
                document.getElementById('preview-foto-jurnal').innerText = "Belum ada foto bukti."; document.getElementById('preview-foto-jurnal').className = "text-xs text-slate-400 italic"; 
                document.getElementById('img-preview-upload').classList.add('hidden');
                document.querySelectorAll('input[value="H"]').forEach(r => r.checked = true); 
            } catch(e) { Swal.fire('Gagal', e.message, 'error'); } finally { document.getElementById('loading').classList.add('hidden'); } 
        }
        
        window.downloadRekapJurnal = async () => { 
            Swal.fire({ title: 'Menyusun Laporan...', text: 'Mengunduh Jurnal...', didOpen: () => Swal.showLoading() }); 
            try { 
                const tglMulai = document.getElementById('filter-mulai').value; const tglSelesai = document.getElementById('filter-selesai').value;
                if(!tglMulai || !tglSelesai) { return Swal.fire('Pilih Tanggal', 'Tentukan tanggal mulai dan selesai dulu.', 'warning'); }
                const q = query(collection(db, "jurnal_guru"), where("nip", "==", userGuru.username)); 
                const snap = await getDocs(q); 
                if (snap.empty) { Swal.fire('Kosong', 'Belum ada data jurnal.', 'info'); return; } 
                let rawData = []; 
                snap.forEach(doc => { const d = doc.data(); if (d.tanggal < tglMulai || d.tanggal > tglSelesai) { return; } let absenTxt = "-"; if(d.absensi_mapel) { const tidakHadir = d.absensi_mapel.filter(s => s.status !== 'H'); if(tidakHadir.length > 0) { absenTxt = tidakHadir.map(s => { if(s.status === 'D') return `${s.nama} (Dispen)`; return `${s.nama} (${s.status})`; }).join(", "); } else { absenTxt = "NIHIL (Hadir Semua)"; } } d.rekap_absen = absenTxt; d.komentar_siswa = d.rekap_refleksi_string || "(Data lama/Belum ada feedback)"; rawData.push(d); }); 
                rawData.sort((a, b) => (b.waktu?.toMillis() || 0) - (a.waktu?.toMillis() || 0)); 
                if(rawData.length === 0) { return Swal.fire('Kosong', 'Tidak ada jurnal di tanggal yang dipilih.', 'info'); }
                const dataExport = rawData.map(d => ({ Tanggal: d.tanggal || "-", Jam_Input: d.waktu ? new Date(d.waktu.toDate()).toLocaleTimeString('id-ID') : '-', Jam_Pelajaran: d.jam_ke || "-", Kelas: d.kelas, Mapel: d.mapel, Materi: d.materi, Ket_Tidak_Hadir: d.rekap_absen, Komentar_Siswa: d.komentar_siswa, Bukti_Fisik: d.foto_bukti })); 
                const ws = XLSX.utils.json_to_sheet(dataExport); const range = XLSX.utils.decode_range(ws['!ref']); for (let R = range.s.r + 1; R <= range.e.r; ++R) { const cellAddress = XLSX.utils.encode_cell({r: R, c: 8}); const cell = ws[cellAddress]; if (cell && cell.v && cell.v.startsWith('http')) { cell.l = { Target: cell.v }; cell.v = "ðŸ“¸ LIHAT FOTO"; } } const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Jurnal Mengajar"); XLSX.writeFile(wb, `JURNAL_${userGuru.nama}_${tglMulai}_sd_${tglSelesai}.xlsx`); Swal.close(); Swal.fire('Selesai!', 'Laporan Excel Siap.', 'success'); 
            } catch (e) { console.error(e); Swal.fire('Gagal', 'Error: ' + e.message, 'error'); } 
        }
        
        function loadRiwayatJurnal() { const todayStr = new Date().toLocaleDateString('fr-CA'); const q = query(collection(db, "jurnal_guru"), where("nip", "==", userGuru.username), where("tanggal", "==", todayStr), orderBy("waktu", "desc")); onSnapshot(q, (snap) => { const container = document.getElementById('list-riwayat-jurnal'); container.innerHTML = ''; if(snap.empty) { container.innerHTML = '<div class="text-center text-slate-300 text-xs italic py-2">Belum ada jurnal hari ini.</div>'; return; } snap.forEach(doc => { const d = doc.data(); const jam = d.waktu ? new Date(d.waktu.toDate()).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}) : '-'; container.innerHTML += `<div class="cursor-pointer flex items-center gap-3 bg-slate-50 p-2 rounded-xl border border-slate-100 fade-in hover:bg-slate-100 transition"><img src="${d.foto_bukti}" class="w-10 h-10 rounded-lg object-cover bg-slate-200"><div class="flex-1"><div class="flex justify-between"><h5 class="text-xs font-bold text-slate-700">${d.kelas} - ${d.mapel}</h5><span class="text-[10px] font-mono text-slate-400">${jam}</span></div><p class="text-[10px] text-slate-500 truncate">${d.materi}</p></div></div>`; }); }); }
        window.logout = () => { sessionStorage.clear(); localStorage.clear(); window.location.href = 'index.html'; }
    </script>
</body>
</html>
