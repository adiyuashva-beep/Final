<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guru Dashboard - SiGanteng</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f1f5f9; }
        .hidden-view { display: none !important; }
        .card-guru { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0; }
        .btn-nav { transition: all 0.2s; }
        .btn-nav.active { background-color: #eff6ff; color: #2563eb; border-left: 4px solid #2563eb; }
        
        /* Modal Login Guru */
        #modalLogin { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); z-index: 50; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="text-slate-800 h-screen flex overflow-hidden">

    <div id="modalLogin">
        <div class="bg-white p-8 rounded-3xl w-full max-w-md shadow-2xl text-center">
            <div class="w-16 h-16 bg-blue-600 rounded-2xl mx-auto flex items-center justify-center mb-4 text-white">
                <i data-lucide="graduation-cap" class="w-8 h-8"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2">Portal Guru</h2>
            <p class="text-slate-500 text-sm mb-6">SiGanteng SMAN 1 Pejagoan</p>
            
            <div class="text-left space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Guru</label>
                    <input type="text" id="inputNamaGuru" class="w-full border p-3 rounded-xl outline-none focus:border-blue-500 font-bold" placeholder="Contoh: Pak Budi">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Wali Kelas (Jika Ada)</label>
                    <select id="inputKelasWali" class="w-full border p-3 rounded-xl outline-none focus:border-blue-500 font-bold bg-white">
                        <option value="">- Bukan Wali Kelas -</option>
                        </select>
                </div>
                <button onclick="loginGuru()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl hover:bg-blue-700 transition shadow-lg mt-2">MASUK DASHBOARD</button>
            </div>
        </div>
    </div>

    <aside class="w-64 bg-white border-r border-slate-200 flex flex-col hidden md:flex z-10">
        <div class="p-6 border-b border-slate-100">
            <h1 class="font-black text-xl text-blue-600 tracking-tighter">SiGanteng</h1>
            <p class="text-xs text-slate-400 font-bold uppercase mt-1">Teacher Edition</p>
        </div>
        <div class="p-4 space-y-2">
            <button onclick="nav('dashboard')" id="menu-dashboard" class="btn-nav active w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-50">
                <i data-lucide="layout-grid" class="w-5 h-5"></i> Dashboard
            </button>
            <button onclick="nav('walikelas')" id="menu-walikelas" class="btn-nav w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-50">
                <i data-lucide="users" class="w-5 h-5"></i> Wali Kelas
            </button>
            <button onclick="nav('verifikasi')" id="menu-verifikasi" class="btn-nav w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-50 relative">
                <i data-lucide="file-check" class="w-5 h-5"></i> Verifikasi Izin
                <span id="badge-izin" class="absolute right-4 bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full hidden">0</span>
            </button>
            <button onclick="nav('jurnal')" id="menu-jurnal" class="btn-nav w-full flex items-center gap-3 px-4 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-50">
                <i data-lucide="book-open" class="w-5 h-5"></i> Jurnal KBM
            </button>
        </div>
        <div class="mt-auto p-6 border-t border-slate-100">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center font-bold text-blue-600">G</div>
                <div>
                    <p class="text-sm font-bold text-slate-800" id="profilNama">Guru</p>
                    <p class="text-xs text-slate-400" id="profilKelas">-</p>
                </div>
            </div>
            <button onclick="location.reload()" class="mt-4 text-xs text-red-500 font-bold hover:underline">Keluar</button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto relative">
        <div class="md:hidden bg-white p-4 flex justify-between items-center shadow-sm sticky top-0 z-20">
            <h1 class="font-bold text-blue-600">SiGanteng Guru</h1>
            <button onclick="nav('dashboard')"><i data-lucide="menu"></i></button>
        </div>

        <div class="p-6 md:p-10 max-w-6xl mx-auto space-y-8">

            <div id="view-dashboard" class="fade-in">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">Ringkasan Hari Ini</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="card-guru p-6 border-l-4 border-blue-500">
                        <p class="text-slate-400 text-xs font-bold uppercase">Siswa Perwalian</p>
                        <h3 class="text-3xl font-black text-slate-800 mt-2" id="dash-total">0</h3>
                    </div>
                    <div class="card-guru p-6 border-l-4 border-emerald-500">
                        <p class="text-slate-400 text-xs font-bold uppercase">Hadir Tepat Waktu</p>
                        <h3 class="text-3xl font-black text-emerald-600 mt-2" id="dash-hadir">0</h3>
                    </div>
                    <div class="card-guru p-6 border-l-4 border-red-500">
                        <p class="text-slate-400 text-xs font-bold uppercase">Perlu Perhatian (A/T)</p>
                        <h3 class="text-3xl font-black text-red-600 mt-2" id="dash-masalah">0</h3>
                    </div>
                </div>
                <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100 flex items-start gap-4">
                    <i data-lucide="info" class="text-blue-600 mt-1"></i>
                    <div>
                        <h4 class="font-bold text-blue-800">Halo, Bapak/Ibu Guru!</h4>
                        <p class="text-sm text-blue-600 mt-1">Silakan cek menu "Verifikasi Izin" jika ada siswa yang mengirim surat sakit hari ini. Pastikan juga mengisi Jurnal KBM setelah mengajar.</p>
                    </div>
                </div>
            </div>

            <div id="view-walikelas" class="hidden-view fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">Absensi Kelas <span id="judulKelasWali" class="text-blue-600">...</span></h2>
                    <button onclick="refreshData()" class="bg-slate-100 p-2 rounded-lg hover:bg-slate-200"><i data-lucide="refresh-cw" class="w-5 h-5 text-slate-600"></i></button>
                </div>

                <div class="card-guru overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 border-b border-slate-200">
                                <tr>
                                    <th class="p-4 font-bold text-slate-600">Nama Siswa</th>
                                    <th class="p-4 font-bold text-slate-600">Status</th>
                                    <th class="p-4 font-bold text-slate-600">Jam</th>
                                    <th class="p-4 font-bold text-slate-600 text-right">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="tabel-siswa" class="divide-y divide-slate-100">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-verifikasi" class="hidden-view fade-in">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">Verifikasi Izin/Sakit</h2>
                <div id="container-verifikasi" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    </div>
                <div id="empty-verif" class="hidden text-center py-10 text-slate-400">
                    <i data-lucide="check-circle" class="w-12 h-12 mx-auto mb-2 text-slate-300"></i>
                    <p>Tidak ada pengajuan izin baru.</p>
                </div>
            </div>

            <div id="view-jurnal" class="hidden-view fade-in">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">Jurnal Mengajar (KBM)</h2>
                <div class="card-guru p-8 max-w-2xl">
                    <div class="space-y-4">
                        <div>
                            <label class="font-bold text-xs uppercase text-slate-500">Kelas</label>
                            <select id="jurnalKelas" class="w-full border bg-slate-50 p-3 rounded-xl mt-1 font-bold outline-none"></select>
                        </div>
                        <div>
                            <label class="font-bold text-xs uppercase text-slate-500">Mata Pelajaran</label>
                            <input type="text" id="jurnalMapel" class="w-full border bg-slate-50 p-3 rounded-xl mt-1 font-bold outline-none" placeholder="Misal: Matematika Wajib">
                        </div>
                        <div>
                            <label class="font-bold text-xs uppercase text-slate-500">Materi / Bahasan</label>
                            <textarea id="jurnalMateri" class="w-full border bg-slate-50 p-3 rounded-xl mt-1 font-medium outline-none" rows="3" placeholder="Apa yang diajarkan hari ini?"></textarea>
                        </div>
                        <div class="pt-4">
                            <button onclick="simpanJurnal()" class="w-full bg-emerald-600 text-white font-bold py-4 rounded-xl hover:bg-emerald-700 shadow-lg">SIMPAN JURNAL</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, doc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXWR-_aJyoMrUjTeNQYlcPD8p3eu58yOo",
            authDomain: "siganteng-absensi.firebaseapp.com",
            projectId: "siganteng-absensi",
            storageBucket: "siganteng-absensi.firebasestorage.app",
            messagingSenderId: "917873420012",
            appId: "1:917873420012:web:0fe1a9eddc5f94959ba7c9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // STATE GURU
        let guruAktif = { nama: "", kelasAmpuan: "" };
        let dataSiswaWali = [];
        const todayStr = new Date().toLocaleDateString('fr-CA');

        // --- 1. SETUP AWAL ---
        window.addEventListener('load', async () => {
            lucide.createIcons();
            await populateDropdownKelas(); // Isi dropdown kelas di modal
        });

        async function populateDropdownKelas() {
            // Ambil semua kelas unik dari users
            const q = query(collection(db, "users"));
            const snap = await getDocs(q);
            const kelasSet = new Set();
            snap.forEach(doc => { if(doc.data().kelas) kelasSet.add(doc.data().kelas); });
            
            const sel = document.getElementById('inputKelasWali');
            const selJurnal = document.getElementById('jurnalKelas');
            
            Array.from(kelasSet).sort().forEach(k => {
                sel.add(new Option(k, k));
                selJurnal.add(new Option(k, k));
            });
        }

        window.loginGuru = () => {
            const nama = document.getElementById('inputNamaGuru').value;
            const kelas = document.getElementById('inputKelasWali').value;
            
            if(!nama) return Swal.fire('Error', 'Nama wajib diisi!', 'error');
            
            guruAktif = { nama, kelasAmpuan: kelas };
            
            // Update UI Profil
            document.getElementById('profilNama').innerText = nama;
            document.getElementById('profilKelas').innerText = kelas ? `Wali Kelas ${kelas}` : "Guru Mapel";
            document.getElementById('judulKelasWali').innerText = kelas || "(Bukan Wali Kelas)";
            
            document.getElementById('modalLogin').classList.add('hidden-view'); // Tutup Modal
            
            // Load Data
            if(kelas) loadDataWaliKelas();
            monitorVerifikasi();
        }

        // --- 2. FITUR WALI KELAS ---
        async function loadDataWaliKelas() {
            if(!guruAktif.kelasAmpuan) return;

            // A. Ambil Siswa Kelas Ini
            const qSiswa = query(collection(db, "users"), where("kelas", "==", guruAktif.kelasAmpuan));
            const snapSiswa = await getDocs(qSiswa);
            dataSiswaWali = [];
            snapSiswa.forEach(d => {
                const s = d.data();
                dataSiswaWali.push({ nisn: String(s.username), nama: s.nama, status: 'Belum Absen', jam: '-', docID: null });
            });

            // B. Ambil Absen Hari Ini
            const qAbsen = query(collection(db, "absensi"), where("tanggal", "==", todayStr), where("kelas", "==", guruAktif.kelasAmpuan));
            
            onSnapshot(qAbsen, (snapAbsen) => {
                let hadir=0, masalah=0;
                
                // Update Status di Array Local
                snapAbsen.forEach(d => {
                    const abs = d.data();
                    const idx = dataSiswaWali.findIndex(s => s.nisn.includes(abs.nisn) || abs.nisn.includes(s.nisn)); // Cocokkan NISN
                    
                    if(idx !== -1) {
                        dataSiswaWali[idx].status = abs.status_terakhir;
                        
                        // Format Jam
                        if(abs.jam_masuk) {
                            const dateObj = abs.jam_masuk.seconds ? new Date(abs.jam_masuk.seconds*1000) : null;
                            dataSiswaWali[idx].jam = dateObj ? dateObj.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}) : abs.jam_masuk;
                        }
                    }
                });

                // Render Tabel
                const tbody = document.getElementById('tabel-siswa');
                tbody.innerHTML = '';
                
                dataSiswaWali.sort((a,b) => a.nama.localeCompare(b.nama)).forEach(s => {
                    let badgeColor = 'bg-slate-100 text-slate-500';
                    if(s.status.includes('Masuk') || s.status.includes('Hadir')) { badgeColor = 'bg-emerald-100 text-emerald-700'; hadir++; }
                    else if(s.status === 'Sakit' || s.status === 'Izin') { badgeColor = 'bg-yellow-100 text-yellow-700'; }
                    else if(s.status === 'Terlambat') { badgeColor = 'bg-red-100 text-red-700'; masalah++; }
                    else { masalah++; } // Belum Absen dianggap masalah

                    // TOMBOL WA (FITUR PEMBUNUH)
                    let btnWA = '';
                    if(s.status === 'Belum Absen' || s.status === 'Terlambat') {
                        const pesan = `Assalamualaikum, Bapak/Ibu Wali Murid. Diberitahukan bahwa siswa a.n *${s.nama}* tercatat *${s.status}* di sekolah pada jam ${new Date().toLocaleTimeString('id-ID')} ini. Mohon konfirmasinya. Terima kasih.`;
                        const link = `https://wa.me/?text=${encodeURIComponent(pesan)}`;
                        btnWA = `<a href="${link}" target="_blank" class="flex items-center gap-2 bg-green-500 text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-green-600 transition"><i data-lucide="message-circle" class="w-3 h-3"></i> WA Ortu</a>`;
                    }

                    tbody.innerHTML += `
                        <tr class="hover:bg-slate-50 border-b border-slate-50">
                            <td class="p-4 font-bold text-slate-700">${s.nama}</td>
                            <td class="p-4"><span class="${badgeColor} px-2 py-1 rounded text-xs font-bold">${s.status}</span></td>
                            <td class="p-4 font-mono text-slate-500">${s.jam}</td>
                            <td class="p-4 text-right flex justify-end">${btnWA}</td>
                        </tr>
                    `;
                });
                
                lucide.createIcons();

                // Update Dashboard Stats
                document.getElementById('dash-total').innerText = dataSiswaWali.length;
                document.getElementById('dash-hadir').innerText = hadir;
                document.getElementById('dash-masalah').innerText = masalah;
            });
        }

        // --- 3. VERIFIKASI IZIN (SEMUA KELAS / FILTER KELAS) ---
        function monitorVerifikasi() {
            // Kalau Wali Kelas -> Filter Kelasnya. Kalau Guru Biasa -> Bisa lihat semua (opsional)
            let q = query(collection(db, "absensi"), where("tanggal", "==", todayStr), where("status_terakhir", "in", ["Sakit", "Izin"]));
            if(guruAktif.kelasAmpuan) {
                q = query(collection(db, "absensi"), where("tanggal", "==", todayStr), where("kelas", "==", guruAktif.kelasAmpuan), where("status_terakhir", "in", ["Sakit", "Izin"]));
            }

            onSnapshot(q, (snap) => {
                const container = document.getElementById('container-verifikasi');
                container.innerHTML = '';
                let count = 0;

                snap.forEach(d => {
                    const data = d.data();
                    const docID = d.id; // Penting buat update
                    
                    // Cek apakah sudah diverifikasi? (Kita asumsikan default blm ada field 'verifikasi')
                    // Jika ingin fitur approval, kita tambah field baru di database
                    const isVerified = data.verifikasi_guru === true;
                    
                    if(!isVerified) {
                        count++;
                        const foto = data.foto_bukti || data.foto_masuk || "https://placehold.co/400x300?text=No+Image";
                        const ket = data.riwayat_kegiatan ? data.riwayat_kegiatan[data.riwayat_kegiatan.length-1] : "Tanpa Keterangan";

                        container.innerHTML += `
                            <div class="card-guru p-4 flex gap-4">
                                <div class="w-1/3">
                                    <img src="${foto}" class="w-full h-32 object-cover rounded-lg bg-slate-100 cursor-pointer" onclick="Swal.fire({imageUrl: '${foto}', showConfirmButton:false})">
                                </div>
                                <div class="flex-1">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h4 class="font-bold text-lg">${data.nama}</h4>
                                            <span class="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded">${data.kelas}</span>
                                            <span class="text-xs font-bold text-orange-500 bg-orange-100 px-2 py-1 rounded">${data.status_terakhir}</span>
                                        </div>
                                    </div>
                                    <p class="text-sm text-slate-600 mt-2 bg-slate-50 p-2 rounded italic">"${ket}"</p>
                                    <div class="mt-3 flex gap-2">
                                        <button onclick="verifikasiAksi('${docID}', true)" class="flex-1 bg-blue-600 text-white py-2 rounded-lg text-xs font-bold hover:bg-blue-700">Setujui</button>
                                        <button onclick="verifikasiAksi('${docID}', false)" class="flex-1 bg-slate-200 text-slate-600 py-2 rounded-lg text-xs font-bold hover:bg-slate-300">Tolak</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });

                // Badge Notif
                const badge = document.getElementById('badge-izin');
                if(count > 0) { badge.innerText = count; badge.classList.remove('hidden'); }
                else { badge.classList.add('hidden'); document.getElementById('empty-verif').classList.remove('hidden'); }
            });
        }

        window.verifikasiAksi = async (docID, isApprove) => {
            const status = isApprove ? "Disetujui" : "Ditolak";
            // Update Firestore
            await updateDoc(doc(db, "absensi", docID), {
                verifikasi_guru: true,
                status_verifikasi: status,
                guru_verifikator: guruAktif.nama
            });
            Swal.fire('Berhasil', `Izin siswa ${status}`, 'success');
        }

        // --- 4. JURNAL KBM ---
        window.simpanJurnal = () => {
            const kls = document.getElementById('jurnalKelas').value;
            const mapel = document.getElementById('jurnalMapel').value;
            const materi = document.getElementById('jurnalMateri').value;

            if(!kls || !mapel || !materi) return Swal.fire('Lengkapi Data', 'Semua kolom wajib diisi!', 'warning');

            // Disini bisa simpan ke collection baru 'jurnal_guru'
            // Untuk demo ini kita tampilkan sukses saja
            Swal.fire({
                icon: 'success',
                title: 'Jurnal Tersimpan',
                text: `Laporan KBM ${mapel} di kelas ${kls} berhasil dicatat.`,
                confirmButtonColor: '#10b981'
            });
            
            // Reset
            document.getElementById('jurnalMateri').value = '';
        }

        // --- NAVIGASI ---
        window.nav = (v) => {
            document.querySelectorAll('.hidden-view').forEach(e=>e.classList.add('hidden-view')); // Reset semua hidden
            document.querySelectorAll('[id^="view-"]').forEach(e=>e.classList.add('hidden-view')); // Pastikan view hidden
            document.getElementById('view-'+v).classList.remove('hidden-view'); // Show target
            
            document.querySelectorAll('.btn-nav').forEach(e=>e.classList.remove('active'));
            document.getElementById('menu-'+v).classList.add('active');
        }

        // Export function to window
        window.loginGuru = loginGuru;
        window.verifikasiAksi = verifikasiAksi;
        window.simpanJurnal = simpanJurnal;
        window.nav = nav;

    </script>
</body>
</html>
