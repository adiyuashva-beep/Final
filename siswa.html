<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Siswa - SiGanteng</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: white; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border-radius: 1.5rem; }
        .btn-menu { transition: transform 0.1s; }
        .btn-menu:active { transform: scale(0.95); }
        
        /* Loading Overlay */
        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 50; display: flex; flex-col; justify-content: center; align-items: center; transition: opacity 0.3s; }
    </style>
</head>
<body class="pb-20">

    <div id="loading-overlay">
        <div class="animate-spin w-10 h-10 border-4 border-indigo-600 border-t-transparent rounded-full mb-3"></div>
        <p class="text-xs font-bold text-slate-500 animate-pulse">Memuat Data Siswa...</p>
    </div>

    <div class="bg-indigo-600 pt-8 pb-16 px-6 rounded-b-[2.5rem] shadow-lg relative overflow-hidden">
        <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10 blur-2xl"></div>
        <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full -ml-10 -mb-10 blur-xl"></div>

        <div class="relative z-10 flex flex-col items-center text-center">
            <div class="relative group">
                <img id="foto-profil" src="https://ui-avatars.com/api/?name=Siswa&background=random" 
                     class="w-24 h-24 rounded-full border-4 border-white/30 object-cover shadow-xl cursor-pointer hover:scale-105 transition"
                     onclick="pilihFotoBaru()">
                <div class="absolute bottom-0 right-0 bg-white text-indigo-600 p-1.5 rounded-full shadow-lg border border-indigo-100 cursor-pointer" onclick="pilihFotoBaru()">
                    <i data-lucide="camera" class="w-4 h-4"></i>
                </div>
            </div>
            <input type="file" id="input-foto" accept="image/*" class="hidden" onchange="prosesFoto(this)">

            <h2 id="nama-siswa" class="text-xl font-black text-white mt-4 tracking-tight">Memuat...</h2>
            <p id="kelas-siswa" class="text-indigo-200 text-sm font-medium">...</p>
            <p id="nisn-siswa" class="text-[10px] text-indigo-300 font-mono mt-1 opacity-80">NISN: ...</p>
        </div>
    </div>

    <div class="px-5 -mt-10 relative z-20 space-y-5">

        <div class="glass-card p-5">
            <div class="flex items-center gap-2 mb-3 border-b border-slate-100 pb-2">
                <i data-lucide="history" class="w-4 h-4 text-slate-400"></i>
                <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Aktivitas Hari Ini</h3>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-emerald-50 p-3 rounded-xl border border-emerald-100 flex items-center gap-3">
                    <div class="bg-emerald-500 text-white p-2 rounded-lg"><i data-lucide="log-in" class="w-4 h-4"></i></div>
                    <div>
                        <p class="text-[10px] text-emerald-600 font-bold uppercase">Masuk</p>
                        <p id="jam-masuk" class="text-lg font-black text-slate-700">--:--</p>
                    </div>
                </div>
                <div class="bg-rose-50 p-3 rounded-xl border border-rose-100 flex items-center gap-3">
                    <div class="bg-rose-500 text-white p-2 rounded-lg"><i data-lucide="log-out" class="w-4 h-4"></i></div>
                    <div>
                        <p class="text-[10px] text-rose-600 font-bold uppercase">Pulang</p>
                        <p id="jam-pulang" class="text-lg font-black text-slate-700">--:--</p>
                    </div>
                </div>
            </div>
            <div id="status-izin" class="hidden mt-3 bg-blue-50 p-3 rounded-xl border border-blue-100 text-center">
                <p class="text-xs font-bold text-blue-600">ðŸ“© Anda Mengajukan Izin/Sakit hari ini</p>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <button onclick="bukaHalaman('scan_masuk.html')" class="btn-menu glass-card p-5 flex flex-col items-center justify-center gap-3 h-32 bg-gradient-to-br from-emerald-500 to-teal-600 border-0 shadow-emerald-500/30 shadow-lg group">
                <div class="bg-white/20 p-3 rounded-2xl group-hover:scale-110 transition"><i data-lucide="qr-code" class="w-8 h-8 text-white"></i></div>
                <span class="text-white font-bold text-lg">ABSEN MASUK</span>
            </button>

            <button onclick="bukaHalaman('scan_pulang.html')" class="btn-menu glass-card p-5 flex flex-col items-center justify-center gap-3 h-32 bg-gradient-to-br from-rose-500 to-pink-600 border-0 shadow-rose-500/30 shadow-lg group">
                <div class="bg-white/20 p-3 rounded-2xl group-hover:scale-110 transition"><i data-lucide="home" class="w-8 h-8 text-white"></i></div>
                <span class="text-white font-bold text-lg">ABSEN PULANG</span>
            </button>

            <button onclick="bukaHalaman('izin.html')" class="btn-menu glass-card p-4 flex flex-col items-center justify-center gap-2">
                <div class="bg-blue-100 text-blue-600 p-2.5 rounded-xl"><i data-lucide="mail" class="w-6 h-6"></i></div>
                <span class="text-slate-600 font-bold text-sm">Izin / Sakit</span>
            </button>
            
            <button onclick="bukaHalaman('dispen.html')" class="btn-menu glass-card p-4 flex flex-col items-center justify-center gap-2">
                <div class="bg-purple-100 text-purple-600 p-2.5 rounded-xl"><i data-lucide="file-badge-2" class="w-6 h-6"></i></div>
                <span class="text-slate-600 font-bold text-sm">Dispensasi</span>
            </button>
        </div>
        
        <div class="glass-card p-4 flex items-start gap-3 bg-slate-800 text-slate-300 border-slate-700">
            <i data-lucide="info" class="w-5 h-5 text-yellow-400 mt-0.5"></i>
            <div>
                <h4 class="text-sm font-bold text-white">Info Penting</h4>
                <p class="text-xs leading-relaxed mt-1">Pastikan GPS aktif saat absen. Foto profil wajib menggunakan seragam sekolah yang rapi.</p>
            </div>
        </div>

        <button onclick="logout()" class="w-full py-3 text-sm font-bold text-red-500 hover:bg-red-50 rounded-xl transition">
            Keluar Aplikasi
        </button>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

        const firebaseConfig = { apiKey: "AIzaSyBXWR-_aJyoMrUjTeNQYlcPD8p3eu58yOo", authDomain: "siganteng-absensi.firebaseapp.com", databaseURL: "https://siganteng-absensi-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "siganteng-absensi", storageBucket: "siganteng-absensi.firebasestorage.app", messagingSenderId: "917873420012", appId: "1:917873420012:web:0fe1a9eddc5f94959ba7c9" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let userNISN = localStorage.getItem('user_nisn');
        let userData = null;

        document.addEventListener('DOMContentLoaded', async () => {
            if(!userNISN) { window.location.href = 'index.html'; return; }
            await loadProfil();
            await loadRiwayatHariIni();
            lucide.createIcons();
            setTimeout(() => document.getElementById('loading-overlay').style.opacity = '0', 500);
            setTimeout(() => document.getElementById('loading-overlay').remove(), 800);
        });

        // 1. LOAD PROFIL (Sekali Baca)
        async function loadProfil() {
            try {
                // Cek Cache dulu biar hemat
                const cachedUser = localStorage.getItem('cache_profil_'+userNISN);
                if(cachedUser) {
                    userData = JSON.parse(cachedUser);
                    renderProfil(userData);
                    // Update background (silent) buat mastiin data fresh
                    fetchUserDataSilent();
                } else {
                    await fetchUserDataSilent();
                }
            } catch (e) { console.error(e); }
        }

        async function fetchUserDataSilent() {
            const docRef = doc(db, "users", userNISN);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                userData = docSnap.data();
                userData.id = docSnap.id;
                localStorage.setItem('cache_profil_'+userNISN, JSON.stringify(userData));
                renderProfil(userData);
            }
        }

        function renderProfil(data) {
            document.getElementById('nama-siswa').innerText = data.nama || "Siswa";
            document.getElementById('kelas-siswa').innerText = data.kelas || "-";
            document.getElementById('nisn-siswa').innerText = "NISN: " + data.nisn;
            if(data.foto_profil) {
                document.getElementById('foto-profil').src = data.foto_profil;
            }
        }

        // 2. LOAD RIWAYAT HARI INI
        async function loadRiwayatHariIni() {
            const todayStr = new Date().toLocaleDateString('fr-CA'); // YYYY-MM-DD
            
            // Cek di LocalStorage dulu (Update instan pas habis absen)
            const localStatus = localStorage.getItem(`status_absen_${userNISN}_${todayStr}`);
            if(localStatus) {
                const status = JSON.parse(localStatus);
                updateTampilanJam(status.masuk, status.pulang);
            }

            // Ambil Data Valid dari Server (1x Read)
            try {
                const q = query(collection(db, "presensi"), where("nisn", "==", userNISN), where("tanggal", "==", todayStr));
                const snap = await getDocs(q);
                
                if(!snap.empty) {
                    const d = snap.docs[0].data();
                    const jamMasuk = d.jam_masuk || "--:--";
                    const jamPulang = d.jam_pulang || "--:--";
                    
                    updateTampilanJam(jamMasuk, jamPulang);

                    // Simpan ke lokal biar besok buka lgsg muncul
                    localStorage.setItem(`status_absen_${userNISN}_${todayStr}`, JSON.stringify({masuk: jamMasuk, pulang: jamPulang}));
                } else {
                    // Cek Izin
                    const qIzin = query(collection(db, "izin_sakit"), where("nisn", "==", userNISN), where("tanggal", "==", todayStr));
                    const snapIzin = await getDocs(qIzin);
                    if(!snapIzin.empty) {
                        document.getElementById('status-izin').classList.remove('hidden');
                    }
                }
            } catch(e) { console.log("Gagal load riwayat:", e); }
        }

        function updateTampilanJam(m, p) {
            if(m && m !== '--:--') document.getElementById('jam-masuk').innerHTML = m + '<span class="text-[10px] text-emerald-500 ml-1">WIB</span>';
            if(p && p !== '--:--') document.getElementById('jam-pulang').innerHTML = p + '<span class="text-[10px] text-rose-500 ml-1">WIB</span>';
        }

        // 3. LOGIKA UPLOAD FOTO + KOMPRESI (CANVAS)
        window.pilihFotoBaru = () => document.getElementById('input-foto').click();

        window.prosesFoto = (input) => {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                Swal.fire({
                    title: 'Memproses Foto...',
                    text: 'Sedang mengkompres ukuran foto agar hemat kuota.',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        // KOMPRESI PAKAI CANVAS
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 500; // Cukup buat avatar
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                        // Convert ke WebP/JPEG kualitas rendah (0.7)
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        
                        // Upload ke Firebase
                        uploadKeFirebase(dataUrl);
                    }
                }
                reader.readAsDataURL(file);
            }
        }

        async function uploadKeFirebase(dataUrl) {
            try {
                const storageRef = ref(storage, `foto_profil/${userNISN}.jpg`);
                await uploadString(storageRef, dataUrl, 'data_url');
                const url = await getDownloadURL(storageRef);

                // Update Firestore User
                await updateDoc(doc(db, "users", userNISN), {
                    foto_profil: url
                });

                // Update Tampilan
                document.getElementById('foto-profil').src = url;
                // Update Cache
                userData.foto_profil = url;
                localStorage.setItem('cache_profil_'+userNISN, JSON.stringify(userData));

                Swal.fire('Berhasil', 'Foto profil diperbarui!', 'success');
            } catch (error) {
                console.error(error);
                Swal.fire('Gagal', 'Terjadi kesalahan saat upload.', 'error');
            }
        }

        window.bukaHalaman = (url) => window.location.href = url;
        window.logout = () => {
            localStorage.clear();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
