<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kartu Pelajar Digital - SiGanteng</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #0f172a; overflow: hidden; }
        
        #card-container {
            width: 640px;
            height: 1020px;
            position: relative;
            background-color: #050505;
            border-radius: 40px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        #preview-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
            padding: 20px 0;
            overflow: visible;
        }

        .bg-premium {
            background: radial-gradient(circle at top right, rgba(251, 191, 36, 0.15), transparent 50%),
                        radial-gradient(circle at bottom left, rgba(37, 99, 235, 0.2), transparent 50%),
                        linear-gradient(to bottom, #0f172a, #020617);
        }

        .text-gold { color: #fbbf24; text-shadow: 0 2px 10px rgba(251, 191, 36, 0.3); }
        .text-glow { text-shadow: 0 0 15px rgba(255, 255, 255, 0.3); }
        
        .watermark {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 70%; opacity: 0.05;
            filter: grayscale(100%);
            pointer-events: none;
            z-index: 0;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center bg-slate-950">

    <div class="fixed top-4 left-4 z-50">
        <a href="siswa.html" class="bg-white/10 backdrop-blur-md p-3 rounded-full text-white hover:bg-white/20 transition border border-white/10">
            <i data-lucide="arrow-left" class="w-6 h-6"></i>
        </a>
    </div>

    <div id="preview-wrapper">
        <div id="card-container" class="bg-premium border-4 border-slate-800/50 relative">
            
            <img src="logo.png" class="watermark" crossorigin="anonymous">

            <div class="relative z-10 h-full flex flex-col p-10 justify-between">
                
                <div class="flex justify-between items-start w-full">
                    <img id="logo-sekolah-img" src="logo_sekolah.png" class="w-20 h-20 object-contain drop-shadow-[0_0_15px_rgba(255,255,255,0.4)]" crossorigin="anonymous">
                    <div class="text-right">
                        <h2 class="text-white font-black text-4xl tracking-tighter leading-none mb-1 text-glow">KARTU PELAJAR</h2>
                        <p class="text-amber-500 text-sm font-bold tracking-[0.4em] uppercase">SMAN 1 PEJAGOAN</p>
                    </div>
                </div>

                <div class="flex flex-col items-center w-full flex-1 justify-center -mt-10">
                    
                    <div class="relative w-60 h-60 mb-8">
                        <div class="absolute inset-0 rounded-full bg-gradient-to-tr from-amber-500 via-transparent to-blue-600 animate-[spin_8s_linear_infinite] opacity-70 blur-md"></div>
                        <div class="absolute inset-2 rounded-full p-1.5 bg-slate-900 z-10 overflow-hidden border-2 border-amber-500/30 shadow-2xl">
                             <img id="card-foto" src="" class="w-full h-full rounded-full object-cover bg-slate-800" crossorigin="anonymous">
                        </div>
                        <div class="absolute -bottom-3 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-amber-600 to-amber-800 px-6 py-1.5 rounded-full border-2 border-slate-900 shadow-lg z-20">
                            <span class="text-xs font-black text-white tracking-widest uppercase whitespace-nowrap">SISWA AKTIF</span>
                        </div>
                    </div>

                    <div class="w-full text-center px-4">
                        <h1 id="card-nama" class="text-4xl font-black text-white uppercase tracking-wide leading-normal drop-shadow-lg mb-2 line-clamp-2 w-full text-glow pb-2">...</h1>
                        <p class="text-sm text-slate-400 uppercase tracking-widest font-bold mb-1">NISN / ID</p>
                        <p id="card-nisn" class="text-3xl font-mono font-bold text-gold tracking-wider leading-none">...</p>
                    </div>
                </div>

                <div class="w-full">
                     <p class="text-center text-sm text-slate-400 italic mb-8">"Kartu ini adalah identitas resmi siswa selama berstatus pelajar aktif"</p>

                     <div class="bg-slate-900/80 backdrop-blur-md p-6 rounded-3xl border border-white/10 flex items-center justify-between">
                        <div>
                             <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mb-2">SCAN UNTUK ABSENSI</p>
                             <div class="flex items-center gap-2">
                                 <img src="logo.png" class="w-5 h-5 grayscale opacity-70" crossorigin="anonymous">
                                 <p class="text-lg font-black text-white leading-tight">SiGanteng <span class="text-emerald-500">Verified</span></p>
                             </div>
                        </div>
                        <div class="bg-white p-2.5 rounded-xl shadow-lg">
                             <div id="qrcode" class="flex-shrink-0"></div>
                        </div>
                     </div>
                </div>

            </div>
        </div>
    </div>

    <div class="fixed bottom-8 left-0 right-0 flex justify-center z-50 px-4">
        <button onclick="downloadKartu()" id="btnDownload" class="bg-gradient-to-r from-amber-600 to-orange-600 text-white w-full max-w-sm py-4 rounded-2xl font-bold shadow-[0_0_30px_rgba(245,158,11,0.4)] flex items-center justify-center gap-3 transition active:scale-95 border border-amber-400/30 text-lg">
            <i data-lucide="download" class="w-6 h-6"></i> SIMPAN KARTU HD
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBXWR-_aJyoMrUjTeNQYlcPD8p3eu58yOo", authDomain: "siganteng-absensi.firebaseapp.com", databaseURL: "https://siganteng-absensi-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "siganteng-absensi", storageBucket: "siganteng-absensi.firebasestorage.app", messagingSenderId: "917873420012", appId: "1:917873420012:web:0fe1a9eddc5f94959ba7c9" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        function scalePreview() {
            const card = document.getElementById('card-container');
            const wrapper = document.getElementById('preview-wrapper');
            const screenWidth = window.innerWidth - 40; 
            const scale = screenWidth / 640; 
            
            if (scale < 1) {
                card.style.transform = `scale(${scale})`;
                card.style.transformOrigin = 'top center';
                wrapper.style.height = `${1020 * scale + 40}px`;
            } else {
                card.style.transform = 'none';
                wrapper.style.height = 'auto';
            }
        }

        window.addEventListener('resize', scalePreview);

        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            scalePreview(); 

            const userLokal = localStorage.getItem('userSiswa');
            if (!userLokal) { window.location.href = 'index.html'; return; }
            const user = JSON.parse(userLokal);
            const nisn = String(user.username || user.nisn);

            document.getElementById('card-nama').innerText = user.nama;
            document.getElementById('card-nisn').innerText = nisn;

            const qrContainer = document.getElementById("qrcode");
            qrContainer.innerHTML = ""; 
            new QRCode(qrContainer, {
                text: nisn, width: 90, height: 90, 
                colorDark : "#000000", colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            const defaultFoto = `https://ui-avatars.com/api/?name=${user.nama}&background=1e293b&color=fbbf24&bold=true`;
            document.getElementById('card-foto').src = defaultFoto;

            try {
                const docRef = doc(db, "siswa", nisn);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if(data.foto_profil) {
                        const proxyUrl = `https://wsrv.nl/?url=${encodeURIComponent(data.foto_profil)}&output=png`;
                        document.getElementById('card-foto').src = proxyUrl;
                    }
                }
            } catch(e) { console.log(e); }
        });

        window.downloadKartu = () => {
            const card = document.getElementById('card-container');
            const btn = document.getElementById('btnDownload');
            const originalTransform = card.style.transform;

            btn.innerHTML = `<i class="animate-spin" data-lucide="loader-2"></i> Memproses HD...`;
            btn.disabled = true;
            lucide.createIcons();

            card.style.transform = 'none';

            html2canvas(card, {
                scale: 2, 
                useCORS: true,
                allowTaint: true,
                backgroundColor: null,
                logging: false,
                width: 640, 
                height: 1020, 
                windowWidth: 640, 
                windowHeight: 1020 
            }).then(canvas => {
                card.style.transform = originalTransform;

                const link = document.createElement('a');
                link.download = `KARTU_SISWA_${document.getElementById('card-nisn').innerText}.png`;
                link.href = canvas.toDataURL("image/png", 1.0);
                link.click();

                btn.innerHTML = `<i data-lucide="check-circle" class="text-emerald-300"></i> Berhasil Disimpan!`;
                btn.classList.replace('from-amber-600', 'from-emerald-600');
                btn.classList.replace('to-orange-600', 'to-teal-600');
                lucide.createIcons();

                Swal.fire({
                    title: 'Kartu HD Tersimpan! ðŸ“¸',
                    html: 'Hasil download dijamin <b>rapi, simetris, dan tajam</b>.<br>Siap dicetak atau dipamerkan!',
                    imageUrl: canvas.toDataURL("image/png"),
                    imageHeight: 250,
                    imageAlt: 'Preview Kartu HD',
                    confirmButtonText: 'Mantap!',
                    confirmButtonColor: '#059669',
                    background: '#0f172a',
                    color: '#fff'
                });

                setTimeout(() => {
                    btn.innerHTML = `<i data-lucide="download"></i> SIMPAN KARTU HD`;
                    btn.classList.replace('from-emerald-600', 'from-amber-600');
                    btn.classList.replace('to-teal-600', 'to-orange-600');
                    btn.disabled = false;
                    lucide.createIcons();
                }, 3000);

            }).catch(err => {
                console.error(err);
                card.style.transform = originalTransform; 
                Swal.fire('Gagal', 'Terjadi kesalahan saat memproses gambar.', 'error');
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="download"></i> COBA LAGI`;
                lucide.createIcons();
            });
        };
    </script>
</body>
</html>
