<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Jurnal KBM - SiGanteng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f8fafc; }
        .table-responsive { overflow-x: auto; }
        .btn-primary { background-color: #2563eb; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: 0.2s; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-success { background-color: #059669; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: 0.2s; }
        .btn-success:hover { background-color: #047857; }
        .btn-danger { background-color: #dc2626; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: 0.2s; }
        .btn-danger:hover { background-color: #b91c1c; }
    </style>
</head>
<body class="p-6">

    <div class="max-w-7xl mx-auto bg-white p-6 rounded-3xl shadow-xl border border-slate-100">
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div>
                <h1 class="text-2xl font-black text-slate-800">REKAP JURNAL KBM</h1>
                <p class="text-slate-500 text-sm">Monitoring Aktivitas Mengajar Guru</p>
            </div>
            <div class="flex gap-2">
                <button onclick="window.location.href='admin.html'" class="bg-slate-100 text-slate-600 px-4 py-2 rounded-lg font-bold hover:bg-slate-200 flex items-center gap-2">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i> Kembali
                </button>
            </div>
        </div>

        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200 mb-6 flex flex-col md:flex-row gap-4 justify-between items-end">
            <div class="w-full md:w-auto">
                <label class="block text-xs font-bold text-slate-500 mb-1">Pilih Tanggal</label>
                <input type="date" id="filterTanggal" class="p-2 border border-slate-300 rounded-lg text-sm font-bold text-slate-700 outline-none focus:border-blue-500">
                <button onclick="loadJurnalByDate()" class="ml-2 bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-blue-700 shadow-lg shadow-blue-500/30">
                    <i data-lucide="search" class="w-4 h-4 inline"></i> Tampilkan
                </button>
            </div>

            <div class="flex gap-2">
                <button onclick="downloadExcelHarian()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-emerald-700 shadow-lg shadow-emerald-500/30 flex items-center gap-2">
                    <i data-lucide="file-down" class="w-4 h-4"></i> Excel (Harian)
                </button>
                <button onclick="downloadRekapBulanan()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-indigo-700 shadow-lg shadow-indigo-500/30 flex items-center gap-2">
                    <i data-lucide="calendar-days" class="w-4 h-4"></i> Rekap Bulanan
                </button>
            </div>
        </div>

        <div class="table-responsive rounded-xl border border-slate-200">
            <table class="w-full text-left border-collapse">
                <thead class="bg-slate-100 text-slate-600 uppercase text-[10px] font-bold tracking-wider">
                    <tr>
                        <th class="p-4 border-b">Jam</th>
                        <th class="p-4 border-b">Kelas</th>
                        <th class="p-4 border-b">Guru</th>
                        <th class="p-4 border-b">Mapel</th>
                        <th class="p-4 border-b w-1/3">Materi</th>
                        <th class="p-4 border-b">Bukti</th>
                        <th class="p-4 border-b">Absensi</th>
                    </tr>
                </thead>
                <tbody id="tabelBody" class="text-sm text-slate-700 divide-y divide-slate-100">
                    <tr>
                        <td colspan="7" class="p-8 text-center text-slate-400 italic">Pilih tanggal lalu klik Tampilkan...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div id="loadingInfo" class="hidden text-center py-4 text-blue-500 font-bold text-xs animate-pulse">Sedang memuat data...</div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBXWR-_aJyoMrUjTeNQYlcPD8p3eu58yOo", authDomain: "siganteng-absensi.firebaseapp.com", databaseURL: "https://siganteng-absensi-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "siganteng-absensi", storageBucket: "siganteng-absensi.firebasestorage.app", messagingSenderId: "917873420012", appId: "1:917873420012:web:0fe1a9eddc5f94959ba7c9" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let dataJurnalCache = [];

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            // Set Default Tanggal Hari Ini
            document.getElementById('filterTanggal').valueAsDate = new Date();
            loadJurnalByDate(); // Auto load hari ini
        });

        window.loadJurnalByDate = async () => {
            const tgl = document.getElementById('filterTanggal').value;
            if(!tgl) return Swal.fire('Pilih Tanggal','','warning');

            const tbody = document.getElementById('tabelBody');
            const loading = document.getElementById('loadingInfo');
            
            tbody.innerHTML = '';
            loading.classList.remove('hidden');

            try {
                // Query: Ambil jurnal tanggal X, urutkan waktu terbaru
                const q = query(collection(db, "jurnal_guru"), where("tanggal", "==", tgl), orderBy("waktu", "desc"));
                const snap = await getDocs(q);

                dataJurnalCache = []; // Simpan utk export excel
                loading.classList.add('hidden');

                if(snap.empty) {
                    tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-slate-400 italic">Belum ada jurnal masuk pada tanggal ini.</td></tr>';
                    return;
                }

                snap.forEach(doc => {
                    const d = doc.data();
                    d.id = doc.id;
                    dataJurnalCache.push(d);

                    const jam = d.waktu ? new Date(d.waktu.seconds * 1000).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}) : '-';
                    
                    // Hitung Hadir/Sakit/Izin/Alpha dari Absensi Mapel
                    let stats = {H:0, S:0, I:0, A:0};
                    if(d.absensi_mapel) {
                        d.absensi_mapel.forEach(s => { if(stats[s.status] !== undefined) stats[s.status]++; });
                    }
                    const infoAbsen = d.absensi_mapel 
                        ? `<span class="text-[10px] bg-emerald-100 text-emerald-700 px-1 rounded">H:${stats.H}</span> 
                           <span class="text-[10px] bg-blue-100 text-blue-700 px-1 rounded">S:${stats.S}</span>
                           <span class="text-[10px] bg-orange-100 text-orange-700 px-1 rounded">I:${stats.I}</span>
                           <span class="text-[10px] bg-red-100 text-red-700 px-1 rounded">A:${stats.A}</span>`
                        : `<span class="text-[10px] text-slate-400">Belum Absen</span>`;

                    const row = `
                        <tr class="hover:bg-slate-50 transition border-b border-slate-50">
                            <td class="p-4 font-mono font-bold text-slate-500">${jam}</td>
                            <td class="p-4 font-bold text-indigo-600">${d.kelas}</td>
                            <td class="p-4 font-bold">${d.nama_guru}</td>
                            <td class="p-4 font-bold text-slate-600">${d.mapel}</td>
                            <td class="p-4 text-xs leading-relaxed text-slate-500">${d.materi}</td>
                            <td class="p-4">
                                <a href="${d.foto_bukti}" target="_blank" class="inline-flex items-center gap-1 text-[10px] font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded hover:bg-blue-100">
                                    <i data-lucide="image" class="w-3 h-3"></i> FOTO
                                </a>
                            </td>
                            <td class="p-4 flex gap-1 flex-wrap">${infoAbsen}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
                lucide.createIcons();

            } catch (e) {
                loading.classList.add('hidden');
                console.error(e);
                tbody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-red-500 font-bold">Error: ${e.message}</td></tr>`;
            }
        }

        window.downloadExcelHarian = () => {
            if(dataJurnalCache.length === 0) return Swal.fire('Data Kosong','Tampilkan data dulu','warning');
            
            const dataExport = dataJurnalCache.map(d => ({
                Tanggal: d.tanggal,
                Jam: d.waktu ? new Date(d.waktu.seconds * 1000).toLocaleTimeString('id-ID') : '-',
                Kelas: d.kelas,
                Guru: d.nama_guru,
                Mapel: d.mapel,
                Materi: d.materi,
                Link_Foto: d.foto_bukti
            }));

            const ws = XLSX.utils.json_to_sheet(dataExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Jurnal Harian");
            XLSX.writeFile(wb, `JURNAL_HARIAN_${document.getElementById('filterTanggal').value}.xlsx`);
        }

        // ⚠️ TOMBOL BAHAYA: SUDAH DIAMANKAN
        window.downloadRekapBulanan = async () => {
            const { value: bulanTahun } = await Swal.fire({
                title: 'Download Rekap Bulanan',
                text: 'Format: YYYY-MM (Contoh: 2026-01)',
                input: 'text',
                inputValue: new Date().toISOString().slice(0, 7),
                showCancelButton: true,
                confirmButtonText: 'Download',
                cancelButtonText: 'Batal'
            });

            if (bulanTahun) {
                Swal.fire({
                    title: 'Sedang Memproses...',
                    text: 'Mohon tunggu, data sedang ditarik dari server...',
                    allowOutsideClick: false,
                    didOpen: () => { Swal.showLoading() }
                });

                try {
                    // Query "startsWith" untuk string tanggal (YYYY-MM-DD starts with YYYY-MM)
                    // Firestore tidak punya startsWith native mudah, jadi kita pakai range
                    const startStr = bulanTahun + "-01";
                    const endStr = bulanTahun + "-31";

                    const q = query(collection(db, "jurnal_guru"), where("tanggal", ">=", startStr), where("tanggal", "<=", endStr));
                    const snap = await getDocs(q);

                    if(snap.empty) {
                        Swal.fire('Data Kosong', 'Tidak ada jurnal di bulan ini.', 'info');
                        return;
                    }

                    let allData = [];
                    snap.forEach(doc => {
                        const d = doc.data();
                        allData.push({
                            Tanggal: d.tanggal,
                            Jam: d.waktu ? new Date(d.waktu.seconds * 1000).toLocaleTimeString('id-ID') : '-',
                            Kelas: d.kelas,
                            Guru: d.nama_guru,
                            Mapel: d.mapel,
                            Materi: d.materi
                        });
                    });

                    // Sortir berdasarkan tanggal & jam
                    allData.sort((a,b) => a.Tanggal.localeCompare(b.Tanggal) || a.Jam.localeCompare(b.Jam));

                    const ws = XLSX.utils.json_to_sheet(allData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, `Rekap ${bulanTahun}`);
                    XLSX.writeFile(wb, `REKAP_JURNAL_${bulanTahun}.xlsx`);

                    Swal.fire('Selesai', `Berhasil mendownload ${allData.length} data jurnal.`, 'success');

                } catch(e) {
                    Swal.fire('Gagal', e.message, 'error');
                }
            }
        }
    </script>
</body>
</html>
