<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Monitoring KBM & Refleksi</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Times+New+Roman:wght@400;700&family=Arial:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* CSS KHUSUS CETAK DOKUMEN RESMI */
        body { background-color: #f3f4f6; font-family: 'Arial', sans-serif; color: #111827; }
        
        .paper {
            background: white;
            width: 297mm; /* A4 Landscape */
            min-height: 210mm;
            padding: 15mm 20mm;
            margin: 20px auto;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        /* Tabel Garis Hitam Tegas ala Dokumen Dinas */
        table.dinas { width: 100%; border-collapse: collapse; border: 2px solid black; font-size: 11px; }
        table.dinas th, table.dinas td { border: 1px solid black; padding: 6px 8px; vertical-align: top; }
        table.dinas th { background-color: #e5e7eb; text-align: center; font-weight: bold; text-transform: uppercase; }
        
        .kop-surat { border-bottom: 3px double black; margin-bottom: 20px; padding-bottom: 10px; display: flex; gap: 20px; align-items: center; }
        .logo-sekolah { width: 80px; height: 80px; object-fit: contain; }
        
        /* Indikator Paham/Ga Paham */
        .bar-container { display: flex; gap: 2px; height: 6px; width: 100%; margin-top: 4px; background: #e5e7eb; }
        .bar-hijau { background-color: #10b981; } /* Paham Banget */
        .bar-kuning { background-color: #f59e0b; } /* Paham */
        .bar-merah { background-color: #ef4444; } /* Ga Paham */

        @media print {
            body { background: white; margin: 0; }
            .paper { box-shadow: none; margin: 0; width: 100%; padding: 0; }
            .no-print { display: none !important; }
            @page { size: A4 landscape; margin: 10mm; }
        }
    </style>
</head>
<body>

    <div class="max-w-[297mm] mx-auto mt-6 mb-6 flex flex-wrap gap-4 no-print justify-between items-end px-4">
        <div class="flex gap-3 bg-white p-3 rounded-lg shadow-sm border border-gray-300">
            <button onclick="window.location.href='admin.html'" class="p-2 hover:bg-gray-100 rounded text-gray-600"><i data-lucide="arrow-left"></i></button>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase">Pilih Kelas</label>
                <select id="filter-kelas" class="border border-gray-300 rounded p-1 text-sm font-bold min-w-[120px]">
                    <option value="">- Semua -</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase">Tanggal</label>
                <input type="date" id="filter-tanggal" class="border border-gray-300 rounded p-1 text-sm font-bold">
            </div>
            <button onclick="loadLaporan()" class="bg-blue-900 text-white px-4 py-1 rounded text-sm font-bold hover:bg-blue-800">TAMPILKAN</button>
        </div>

        <div class="flex gap-2">
            <button onclick="window.print()" class="bg-gray-800 text-white px-4 py-2 rounded text-sm font-bold flex items-center gap-2 hover:bg-gray-700">
                <i data-lucide="printer" class="w-4 h-4"></i> CETAK DOKUMEN
            </button>
            <button onclick="downloadExcelLengkap()" class="bg-emerald-700 text-white px-4 py-2 rounded text-sm font-bold flex items-center gap-2 hover:bg-emerald-600">
                <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> DOWNLOAD XLS
            </button>
        </div>
    </div>

    <div class="paper">
        
        <div class="kop-surat">
            <img src="https://cdn-icons-png.flaticon.com/512/2990/2990638.png" class="logo-sekolah" alt="Logo">
            <div class="w-full text-center">
                <h2 class="text-lg font-bold font-serif uppercase tracking-widest">PEMERINTAH PROVINSI JAWA TENGAH</h2>
                <h1 class="text-2xl font-bold font-serif uppercase text-blue-900">SMA NEGERI 1 PEJAGOAN</h1>
                <p class="text-sm font-serif italic">Jalan Raya Pejagoan, Kebumen, Jawa Tengah - 54361</p>
                <p class="text-xs font-bold mt-1">Laporan Monitoring Kegiatan Belajar Mengajar (KBM) & Evaluasi Pembelajaran</p>
            </div>
        </div>

        <div class="flex justify-between text-sm font-bold mb-4 font-sans border-b border-black pb-2">
            <div>
                <p>HARI / TANGGAL : <span id="info-tanggal" class="uppercase">...</span></p>
                <p>KELAS TERPANTAU : <span id="info-kelas">...</span></p>
            </div>
            <div class="text-right">
                <p>TOTAL JAM PELAJARAN : <span id="info-total-jam">0</span> JP</p>
                <p>INDEX KEPUASAN SISWA : <span id="info-kepuasan" class="text-blue-700">0%</span></p>
            </div>
        </div>

        <table class="dinas">
            <thead>
                <tr>
                    <th style="width: 5%">JAM</th>
                    <th style="width: 20%">GURU & MAPEL</th>
                    <th style="width: 25%">MATERI & AKTIVITAS</th>
                    <th style="width: 15%">KETIDAKHADIRAN<br>SISWA</th>
                    <th style="width: 25%">RESPON & REFLEKSI SISWA<br><span class="text-[9px] font-normal lowercase">(Tingkat Pemahaman)</span></th>
                    <th style="width: 10%">BUKTI</th>
                </tr>
            </thead>
            <tbody id="tabel-body">
                <tr><td colspan="6" class="text-center py-10 italic text-gray-400">Silakan pilih filter di atas untuk menampilkan data.</td></tr>
            </tbody>
        </table>

        <div class="flex justify-between mt-12 text-center text-sm font-sans no-break">
            <div style="width: 200px;">
                <p>Mengetahui,</p>
                <p class="font-bold">Kepala Sekolah</p>
                <br><br><br>
                <p class="font-bold underline">...................................</p>
                <p>NIP. ..............................</p>
            </div>
            <div style="width: 200px;">
                <p>Kebumen, <span id="tgl-cetak">...</span></p>
                <p class="font-bold">Waka Kurikulum</p>
                <br><br><br>
                <p class="font-bold underline">ASMAUL RIYADI, S.Kom</p>
                <p>NIP. ..............................</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBXWR-_aJyoMrUjTeNQYlcPD8p3eu58yOo", authDomain: "siganteng-absensi.firebaseapp.com", databaseURL: "https://siganteng-absensi-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "siganteng-absensi", storageBucket: "siganteng-absensi.firebasestorage.app", messagingSenderId: "917873420012", appId: "1:917873420012:web:0fe1a9eddc5f94959ba7c9" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let dataLaporan = [];

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            document.getElementById('filter-tanggal').valueAsDate = new Date();
            const now = new Date();
            document.getElementById('tgl-cetak').innerText = now.toLocaleDateString('id-ID', {day:'numeric', month:'long', year:'numeric'});
            loadKelas();
            loadLaporan(); // Auto load hari ini
        });

        // Load List Kelas utk Filter
        async function loadKelas() {
            const sel = document.getElementById('filter-kelas');
            const cached = localStorage.getItem('cache_list_kelas');
            if(cached) {
                JSON.parse(cached).forEach(k => sel.add(new Option(k, k)));
            } else {
                const q = query(collection(db, "users"), where("kelas", "!=", "-"));
                const snap = await getDocs(q);
                const setK = new Set();
                snap.forEach(d => { if(d.data().kelas && d.data().kelas.length > 1) setK.add(d.data().kelas.toUpperCase().trim()); });
                const arr = Array.from(setK).sort();
                localStorage.setItem('cache_list_kelas', JSON.stringify(arr));
                arr.forEach(k => sel.add(new Option(k, k)));
            }
        }

        // LOAD DATA UTAMA
        window.loadLaporan = async () => {
            const tgl = document.getElementById('filter-tanggal').value;
            const kls = document.getElementById('filter-kelas').value;

            Swal.fire({title:'Menyiapkan Dokumen...', didOpen:()=>Swal.showLoading()});

            try {
                // 1. Ambil Jurnal
                let qJurnal = query(collection(db, "jurnal_guru"), where("tanggal", "==", tgl));
                if(kls) qJurnal = query(collection(db, "jurnal_guru"), where("tanggal", "==", tgl), where("kelas", "==", kls));
                
                const snapJurnal = await getDocs(qJurnal);
                
                // 2. Ambil Refleksi Siswa di hari yg sama
                let qRef = query(collection(db, "refleksi_siswa"), where("tanggal", "==", tgl));
                if(kls) qRef = query(collection(db, "refleksi_siswa"), where("tanggal", "==", tgl), where("kelas", "==", kls));
                const snapRef = await getDocs(qRef);

                // Mapping Refleksi per Jurnal ID
                const mapRef = {};
                snapRef.forEach(d => {
                    const r = d.data();
                    if(!mapRef[r.id_jurnal]) mapRef[r.id_jurnal] = { paham:0, lumayan:0, bingung:0, total:0, komen:[] };
                    
                    if(r.rating == 3) mapRef[r.id_jurnal].paham++;
                    else if(r.rating == 2) mapRef[r.id_jurnal].lumayan++;
                    else mapRef[r.id_jurnal].bingung++;
                    
                    mapRef[r.id_jurnal].total++;
                    if(r.pesan && r.pesan.length > 3) mapRef[r.id_jurnal].komen.push(r.pesan);
                });

                dataLaporan = [];
                snapJurnal.forEach(d => {
                    const dt = d.data();
                    dt.id = d.id;
                    dt.refleksi = mapRef[d.id] || { paham:0, lumayan:0, bingung:0, total:0, komen:[] };
                    dataLaporan.push(dt);
                });

                // Sort: Kelas -> Jam
                dataLaporan.sort((a,b) => a.kelas.localeCompare(b.kelas) || (a.waktu?.toMillis() - b.waktu?.toMillis()));

                renderTabel(tgl, kls);
                Swal.close();

            } catch (e) {
                Swal.fire('Error', e.message, 'error');
            }
        }

        function renderTabel(tgl, kls) {
            const body = document.getElementById('tabel-body');
            body.innerHTML = '';

            // Update Header Info
            const dateObj = new Date(tgl);
            document.getElementById('info-tanggal').innerText = dateObj.toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
            document.getElementById('info-kelas').innerText = kls ? kls : "SEMUA KELAS";
            document.getElementById('info-total-jam').innerText = dataLaporan.length;

            if(dataLaporan.length === 0) {
                body.innerHTML = '<tr><td colspan="6" class="text-center py-10 font-bold">TIDAK ADA KEGIATAN KBM TEREKAM.</td></tr>';
                document.getElementById('info-kepuasan').innerText = "0%";
                return;
            }

            let totalKepuasan = 0;
            let countJurnalWithRefleksi = 0;

            dataLaporan.forEach(d => {
                const jam = d.waktu ? new Date(d.waktu.seconds*1000).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}) : '-';
                
                // 1. Analisa Absensi (Siapa yg gak ada?)
                let listAbsen = [];
                if(d.absensi_mapel) {
                    d.absensi_mapel.forEach(s => {
                        if(s.status !== 'H') {
                            let label = "";
                            let style = "";
                            if(s.status === 'S') { label="Sakit"; style="text-blue-600"; }
                            else if(s.status === 'I') { label="Izin"; style="text-orange-600"; }
                            else if(s.status === 'A') { label="ALPHA"; style="text-red-600 font-bold"; } // Bolos Mapel
                            else if(s.status === 'D') { label="Dispen"; style="text-purple-600"; } // Dispensation
                            else { label=s.status; style="text-gray-600"; }
                            
                            listAbsen.push(`<div class="${style} text-[10px]">â€¢ ${s.nama} (${label})</div>`);
                        }
                    });
                }
                const absenHtml = listAbsen.length > 0 ? listAbsen.join('') : '<div class="text-center text-emerald-600 font-bold text-[10px]">NIHIL (FULL TEAM)</div>';

                // 2. Analisa Refleksi (Grafik Batang Mini)
                const ref = d.refleksi;
                let barHtml = '<div class="text-[10px] italic text-gray-400">Belum ada refleksi siswa</div>';
                let persenPaham = 0;
                
                if(ref.total > 0) {
                    const pPaham = (ref.paham / ref.total) * 100;
                    const pLumayan = (ref.lumayan / ref.total) * 100;
                    const pBingung = (ref.bingung / ref.total) * 100;
                    
                    persenPaham = pPaham + (pLumayan * 0.5); // Pembobotan sederhana
                    totalKepuasan += persenPaham;
                    countJurnalWithRefleksi++;

                    // Ambil 1 Sampel Komentar Terbaik/Terunik
                    const sampleKomen = ref.komen.length > 0 ? `"${ref.komen[0]}"` : "";

                    barHtml = `
                        <div class="flex justify-between text-[9px] font-bold mb-1">
                            <span class="text-emerald-600">Paham: ${ref.paham}</span>
                            <span class="text-yellow-600">Sedang: ${ref.lumayan}</span>
                            <span class="text-red-600">Bingung: ${ref.bingung}</span>
                        </div>
                        <div class="bar-container">
                            <div class="bar-hijau" style="width: ${pPaham}%"></div>
                            <div class="bar-kuning" style="width: ${pLumayan}%"></div>
                            <div class="bar-merah" style="width: ${pBingung}%"></div>
                        </div>
                        <div class="text-[9px] italic mt-1 text-gray-600 truncate">${sampleKomen}</div>
                    `;
                }

                // Render Baris
                body.innerHTML += `
                    <tr>
                        <td class="text-center font-bold">${jam}</td>
                        <td>
                            <div class="font-bold text-blue-900">${d.kelas}</div>
                            <div class="font-bold uppercase text-[10px]">${d.mapel}</div>
                            <div class="text-[10px] text-gray-600">${d.nama_guru}</div>
                        </td>
                        <td>
                            <div class="text-[10px] leading-snug">${d.materi}</div>
                        </td>
                        <td>
                            ${absenHtml}
                        </td>
                        <td>
                            ${barHtml}
                        </td>
                        <td class="text-center">
                            ${d.foto_bukti ? '<img src="'+d.foto_bukti+'" class="w-12 h-12 object-cover border border-gray-300 mx-auto">' : '-'}
                        </td>
                    </tr>
                `;
            });

            // Hitung Rata2 Kepuasan Sekolah
            const avgKepuasan = countJurnalWithRefleksi > 0 ? Math.round(totalKepuasan / countJurnalWithRefleksi) : 0;
            document.getElementById('info-kepuasan').innerText = avgKepuasan + "%";
        }

        // DOWNLOAD EXCEL KHUSUS
        window.downloadExcelLengkap = () => {
            if(dataLaporan.length === 0) return Swal.fire('Kosong','Tidak ada data','warning');
            const dataExport = dataLaporan.map(d => ({
                TANGGAL: d.tanggal,
                KELAS: d.kelas,
                GURU: d.nama_guru,
                MAPEL: d.mapel,
                MATERI: d.materi,
                SISWA_ABSEN: d.absensi_mapel ? d.absensi_mapel.filter(s=>s.status!=='H').map(s=>`${s.nama}(${s.status})`).join(', ') : '-',
                JML_PAHAM: d.refleksi.paham,
                JML_BINGUNG: d.refleksi.bingung,
                SAMPEL_TESTIMONI: d.refleksi.komen.join(' | ')
            }));
            const ws = XLSX.utils.json_to_sheet(dataExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Rekap KBM");
            XLSX.writeFile(wb, "LAPORAN_AKREDITASI_KBM.xlsx");
        }
    </script>
</body>
</html>
