<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin KBM & Jurnal - SiGanteng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f1f5f9; }
        .glass-panel { background: white; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-radius: 1rem; }
        .grid-box { transition: all 0.2s; cursor: pointer; }
        .grid-box:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="p-6">

    <div class="max-w-7xl mx-auto space-y-6">
        
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-black text-slate-800 tracking-tighter">MONITORING KBM</h1>
                <p class="text-slate-500 font-medium">Rekap Jurnal Mengajar Guru (Realtime)</p>
            </div>
            <div class="flex gap-3">
                <button onclick="window.location.href='admin.html'" class="bg-white border border-slate-300 text-slate-600 px-4 py-2 rounded-xl font-bold hover:bg-slate-50 flex items-center gap-2">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i> Kembali
                </button>
                <button onclick="downloadRekapHarian()" class="bg-emerald-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-emerald-700 shadow-lg shadow-emerald-500/30 flex items-center gap-2">
                    <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Download Rekap Hari Ini
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="space-y-4">
                <div class="bg-indigo-600 text-white p-3 rounded-xl text-center font-black tracking-widest shadow-lg shadow-indigo-500/30">KELAS X</div>
                <div id="grid-x" class="grid grid-cols-2 gap-3">
                    <div class="col-span-2 text-center py-4 text-slate-400 italic text-sm">Memuat data...</div>
                </div>
            </div>

            <div class="space-y-4">
                <div class="bg-blue-600 text-white p-3 rounded-xl text-center font-black tracking-widest shadow-lg shadow-blue-500/30">KELAS XI</div>
                <div id="grid-xi" class="grid grid-cols-2 gap-3">
                    <div class="col-span-2 text-center py-4 text-slate-400 italic text-sm">Memuat data...</div>
                </div>
            </div>

            <div class="space-y-4">
                <div class="bg-rose-600 text-white p-3 rounded-xl text-center font-black tracking-widest shadow-lg shadow-rose-500/30">KELAS XII</div>
                <div id="grid-xii" class="grid grid-cols-2 gap-3">
                    <div class="col-span-2 text-center py-4 text-slate-400 italic text-sm">Memuat data...</div>
                </div>
            </div>
        </div>

        <div id="modalDetail" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                <div class="p-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="font-bold text-lg text-slate-800" id="judulModal">Detail KBM</h3>
                    <button onclick="tutupModal()" class="p-2 hover:bg-slate-200 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div id="kontenModal" class="p-6 overflow-y-auto space-y-4">
                    </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBXWR-_aJyoMrUjTeNQYlcPD8p3eu58yOo", authDomain: "siganteng-absensi.firebaseapp.com", databaseURL: "https://siganteng-absensi-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "siganteng-absensi", storageBucket: "siganteng-absensi.firebasestorage.app", messagingSenderId: "917873420012", appId: "1:917873420012:web:0fe1a9eddc5f94959ba7c9" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // VARIABEL GLOBAL
        let jurnalHariIni = [];
        const todayStr = new Date().toLocaleDateString('fr-CA'); // YYYY-MM-DD

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            pantauJurnalHariIni();
        });

        function pantauJurnalHariIni() {
            // Kita ambil jurnal hari ini secara REALTIME
            // Hemat kuota karena filter by tanggal
            const q = query(collection(db, "jurnal_guru"), where("tanggal", "==", todayStr));
            
            onSnapshot(q, (snap) => {
                jurnalHariIni = [];
                snap.forEach(doc => {
                    const d = doc.data();
                    d.id = doc.id;
                    jurnalHariIni.push(d);
                });
                renderGridKelas();
            });
        }

        async function renderGridKelas() {
            // 1. Ambil daftar kelas dari Cache (biar hemat) atau Firestore (sekali aja)
            let daftarKelas = localStorage.getItem('cache_list_kelas');
            if(!daftarKelas) {
                // Fallback: Hardcode sementara biar cepat tampil, nanti bisa ambil dari DB
                // Kamu bisa edit list ini sesuai nama kelas asli di sekolahmu
                const listManual = [
                    "X-1","X-2","X-3","X-4","X-5","X-6","X-7","X-8","X-9","X-10",
                    "XI-1","XI-2","XI-3","XI-4","XI-5","XI-6","XI-7","XI-8","XI-9","XI-10",
                    "XII-1","XII-2","XII-3","XII-4","XII-5","XII-6","XII-7","XII-8","XII-9","XII-10"
                ];
                daftarKelas = JSON.stringify(listManual);
                localStorage.setItem('cache_list_kelas', daftarKelas);
            }
            
            const classes = JSON.parse(daftarKelas);
            const gridX = document.getElementById('grid-x');
            const gridXI = document.getElementById('grid-xi');
            const gridXII = document.getElementById('grid-xii');

            gridX.innerHTML = ''; gridXI.innerHTML = ''; gridXII.innerHTML = '';

            // 2. Mapping Data
            // Kita urutkan kelas biar rapi
            classes.sort();

            classes.forEach(kls => {
                // Cari apakah ada jurnal untuk kelas ini hari ini
                // Satu kelas bisa punya BANYAK jurnal (Bhs Indo, MTK, dll)
                const jurnalKelas = jurnalHariIni.filter(j => j.kelas === kls);
                const countJurnal = jurnalKelas.length;
                
                // Tentukan Warna
                let bgClass = "bg-white border-slate-200 text-slate-500";
                let statusIcon = `<i data-lucide="minus" class="w-4 h-4 text-slate-300"></i>`;
                let statusText = "Kosong";

                if (countJurnal > 0) {
                    bgClass = "bg-emerald-50 border-emerald-200 text-emerald-700";
                    statusIcon = `<div class="bg-emerald-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">${countJurnal} Mapel</div>`;
                    // Ambil mapel terakhir
                    const lastMapel = jurnalKelas[jurnalKelas.length-1].mapel;
                    statusText = `<span class="truncate block w-full text-[10px] font-normal">Terakhir: ${lastMapel}</span>`;
                }

                const cardHtml = `
                    <div onclick="lihatDetail('${kls}')" class="${bgClass} border p-3 rounded-xl grid-box flex flex-col justify-between h-24 relative overflow-hidden">
                        <div class="flex justify-between items-start">
                            <h4 class="font-black text-lg tracking-tighter">${kls}</h4>
                            ${statusIcon}
                        </div>
                        <div class="text-xs font-bold mt-1">
                            ${statusText}
                        </div>
                    </div>
                `;

                // Masukkan ke kolom yang sesuai
                if (kls.startsWith("X-") || kls.startsWith("10") || kls.includes("X ")) gridX.innerHTML += cardHtml;
                else if (kls.startsWith("XI") || kls.startsWith("11")) gridXI.innerHTML += cardHtml;
                else if (kls.startsWith("XII") || kls.startsWith("12")) gridXII.innerHTML += cardHtml;
            });
            lucide.createIcons();
        }

        window.lihatDetail = (kelas) => {
            const modal = document.getElementById('modalDetail');
            const konten = document.getElementById('kontenModal');
            document.getElementById('judulModal').innerText = `Detail KBM: ${kelas}`;
            
            const data = jurnalHariIni.filter(j => j.kelas === kelas);
            
            konten.innerHTML = '';
            if(data.length === 0) {
                konten.innerHTML = '<div class="text-center py-10 text-slate-400">Belum ada guru yang mengisi jurnal di kelas ini hari ini.</div>';
            } else {
                data.sort((a,b) => b.waktu.seconds - a.waktu.seconds); // Urut dari yang terbaru
                data.forEach(d => {
                    const jam = new Date(d.waktu.seconds * 1000).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
                    // Hitung Kehadiran di Mapel Ini
                    let hadirCount = 0;
                    if(d.absensi_mapel) {
                        hadirCount = d.absensi_mapel.filter(s => s.status === 'H').length;
                    }
                    
                    konten.innerHTML += `
                        <div class="bg-white border border-slate-100 p-4 rounded-xl shadow-sm flex gap-4">
                            <img src="${d.foto_bukti}" class="w-16 h-16 rounded-lg object-cover bg-slate-200 border border-slate-200">
                            <div class="flex-1">
                                <div class="flex justify-between items-start mb-1">
                                    <h4 class="font-bold text-slate-800">${d.mapel}</h4>
                                    <span class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded text-xs font-bold">${jam}</span>
                                </div>
                                <p class="text-xs text-slate-500 font-bold mb-2">üë®‚Äçüè´ ${d.nama_guru}</p>
                                <p class="text-xs text-slate-600 bg-slate-50 p-2 rounded mb-2">" ${d.materi} "</p>
                                <div class="flex gap-2 text-[10px]">
                                    <span class="bg-emerald-100 text-emerald-700 px-2 py-1 rounded font-bold">Hadir: ${hadirCount} Siswa</span>
                                    <span class="bg-slate-100 text-slate-500 px-2 py-1 rounded">Refleksi belum dihitung</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            modal.classList.remove('hidden');
        }

        window.tutupModal = () => document.getElementById('modalDetail').classList.add('hidden');

        window.downloadRekapHarian = () => {
            if(jurnalHariIni.length === 0) return Swal.fire('Kosong','Belum ada data hari ini','info');
            
            const dataExport = jurnalHariIni.map(d => ({
                Jam: new Date(d.waktu.seconds * 1000).toLocaleTimeString('id-ID'),
                Kelas: d.kelas,
                Mapel: d.mapel,
                Guru: d.nama_guru,
                Materi: d.materi,
                Jml_Siswa_Hadir_Mapel: d.absensi_mapel ? d.absensi_mapel.filter(s=>s.status==='H').length : 'N/A'
            }));

            const ws = XLSX.utils.json_to_sheet(dataExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Rekap Harian");
            XLSX.writeFile(wb, `Rekap_KBM_${todayStr}.xlsx`);
        }
    </script>
</body>
</html>
