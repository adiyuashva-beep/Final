<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Control - SiGanteng</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .nav-item.active { background: rgba(59, 130, 246, 0.1); border-right: 3px solid #3b82f6; color: #60a5fa; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-sm">

    <aside class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col hidden md:flex">
        <div class="p-6">
            <h1 class="font-black text-2xl tracking-tighter text-blue-500">SiGanteng</h1>
            <p class="text-xs text-slate-500 tracking-widest uppercase mt-1">Master Control (IT)</p>
            <div id="badge-role" class="mt-2 inline-block px-2 py-1 rounded bg-slate-800 text-xs font-bold text-slate-300">OPERATOR</div>
        </div>

        <nav class="flex-1 space-y-1 px-3 mt-4 overflow-y-auto hide-scroll">
            
            <p class="px-4 text-[10px] font-bold text-slate-600 uppercase mb-2">Menu Utama</p>
            <button onclick="nav('dashboard')" id="nav-dashboard" class="nav-item active w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard Sistem
            </button>
            <button onclick="nav('data')" id="nav-data" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition">
                <i data-lucide="database" class="w-5 h-5"></i> Database User
            </button>
            <button onclick="nav('mapel')" id="nav-mapel" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition">
                <i data-lucide="library" class="w-5 h-5"></i> Database Mapel
            </button>
            
            <p class="px-4 text-[10px] font-bold text-slate-600 uppercase mb-2 mt-4">Pengaturan</p>
            <button onclick="nav('menu-manager')" id="nav-menu-manager" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition">
                 <i data-lucide="layout-grid" class="w-5 h-5"></i> App Store (Tombol)
            </button>
            <button onclick="nav('settings')" id="nav-settings" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition">
                <i data-lucide="settings" class="w-5 h-5"></i> Setting Sistem
            </button>

            <p class="px-4 text-[10px] font-bold text-slate-600 uppercase mb-2 mt-4">Akses Panel Lain</p>
            <button onclick="window.open('adminBK.html', '_blank')" class="w-full flex items-center gap-3 px-4 py-3 text-emerald-400 hover:text-white hover:bg-emerald-900/30 rounded-lg transition font-bold">
                <i data-lucide="user-check" class="w-5 h-5"></i> Panel BK / Kesiswaan
            </button>
            <button onclick="window.open('adminKBM.html', '_blank')" class="w-full flex items-center gap-3 px-4 py-3 text-yellow-400 hover:text-white hover:bg-yellow-900/30 rounded-lg transition font-bold">
                <i data-lucide="book-open-check" class="w-5 h-5"></i> Panel Kurikulum (KBM)
            </button>
        </nav>

        <div class="p-4 border-t border-slate-800">
            <button onclick="logout()" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-500/10 text-red-500 rounded-lg hover:bg-red-500 hover:text-white transition font-bold">
                <i data-lucide="log-out" class="w-4 h-4"></i> Keluar
            </button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto bg-slate-950 relative p-4 md:p-8">
        
        <div class="md:hidden flex justify-between items-center mb-6">
            <h1 class="font-bold text-lg text-blue-500">Master Control</h1>
            <button onclick="logout()" class="text-red-500"><i data-lucide="log-out"></i></button>
        </div>

        <div id="view-dashboard" class="space-y-6 fade-in">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
                <div>
                    <h2 class="text-3xl font-bold text-white">System Monitor</h2>
                    <p class="text-slate-400 text-sm">Status Server: <span class="text-emerald-400 font-bold">ONLINE</span></p>
                </div>
                <div class="flex gap-2">
                    <button onclick="tarikDataSiswa(true)" class="bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 text-xs transition border border-slate-700">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i> Sync Data Siswa
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-slate-900 p-5 rounded-2xl border border-slate-800"><p class="text-slate-500 text-xs font-bold uppercase">Total User</p><h3 class="text-3xl font-black text-white mt-1" id="stat-total">0</h3></div>
                <div class="bg-slate-900 p-5 rounded-2xl border border-slate-800"><p class="text-slate-500 text-xs font-bold uppercase">Hadir Realtime</p><h3 class="text-3xl font-black text-emerald-400 mt-1" id="stat-hadir">0</h3></div>
                <div class="bg-slate-900 p-5 rounded-2xl border border-slate-800"><p class="text-slate-500 text-xs font-bold uppercase">Guru Aktif</p><h3 class="text-3xl font-black text-orange-400 mt-1" id="stat-guru">0</h3></div>
                <div class="bg-slate-900 p-5 rounded-2xl border border-slate-800"><p class="text-slate-500 text-xs font-bold uppercase">Admin Online</p><h3 class="text-3xl font-black text-blue-400 mt-1">1</h3></div>
            </div>

            <div class="bg-slate-900 rounded-2xl border border-slate-800 overflow-hidden mt-6">
                <div class="p-4 border-b border-slate-800"><h3 class="font-bold text-white">Live Traffic Log</h3></div>
                <div class="overflow-x-auto max-h-96">
                    <table class="w-full text-left text-slate-400">
                        <thead class="bg-slate-950 text-xs uppercase font-bold text-slate-500 sticky top-0">
                            <tr><th class="p-4">Jam</th><th class="p-4">User</th><th class="p-4">Aktivitas</th><th class="p-4">Device</th></tr>
                        </thead>
                        <tbody id="tabel-live" class="divide-y divide-slate-800"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-data" class="hidden space-y-6 fade-in">
            <h2 class="text-3xl font-bold text-white">Database Management</h2>
            
            <div class="flex gap-2 mb-6">
                <button onclick="gantiTabInput('excel')" id="btn-tab-excel" class="px-4 py-2 rounded-lg font-bold bg-blue-600 text-white transition">Import Excel (Massal)</button>
                <button onclick="gantiTabInput('manual')" id="btn-tab-manual" class="px-4 py-2 rounded-lg font-bold bg-slate-800 text-slate-400 transition hover:text-white">Input Manual (Satuan)</button>
                <button onclick="gantiTabInput('manage')" id="btn-tab-manage" class="px-4 py-2 rounded-lg font-bold bg-slate-800 text-slate-400 transition hover:text-white flex items-center gap-2"><i data-lucide="search" class="w-4 h-4"></i> Cari & Hapus</button>
            </div>

            <div id="area-input-excel" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-slate-900 p-6 rounded-2xl border border-slate-800">
                    <h3 class="font-bold text-white text-lg mb-2">Upload Data Siswa</h3>
                    <p class="text-xs text-slate-500 mb-4">Format Excel: [Nama, NISN, Password, Kelas, Wali Kelas]</p>
                    <input type="file" id="fileSiswa" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mb-4"/>
                    <button onclick="prosesImport('siswa')" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded-lg">Upload Siswa</button>
                </div>
                <div class="bg-slate-900 p-6 rounded-2xl border border-slate-800">
                    <h3 class="font-bold text-white text-lg mb-2">Upload Guru & Tendik</h3>
                    <p class="text-xs text-slate-500 mb-4">Format Excel: [Nama, NIP, Password, -, -]</p>
                    <input type="file" id="fileGuru" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100 mb-4"/>
                    <button onclick="prosesImport('guru')" class="w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-2 rounded-lg">Upload Guru</button>
                </div>
            </div>

            <div id="area-input-manual" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-slate-900 p-6 rounded-2xl border border-slate-800">
                    <h3 class="font-bold text-white text-lg mb-4 flex items-center gap-2"><i data-lucide="user-plus" class="text-blue-500"></i> Tambah Siswa Satuan</h3>
                    <div class="space-y-4">
                        <input type="text" id="manualNamaSiswa" class="w-full bg-slate-950 text-white p-3 rounded-lg border border-slate-700" placeholder="Nama Lengkap Siswa">
                        <input type="text" id="manualNISN" class="w-full bg-slate-950 text-white p-3 rounded-lg border border-slate-700" placeholder="NISN (Akan jadi Username)">
                        
                        <select id="manualKelas" class="w-full bg-slate-950 text-white p-3 rounded-lg border border-slate-700 outline-none">
                            <option value="">- Pilih Kelas -</option>
                        </select>

                        <button onclick="simpanManual('siswa')" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition">Simpan Siswa</button>
                    </div>
                </div>
                <div class="bg-slate-900 p-6 rounded-2xl border border-slate-800">
                    <h3 class="font-bold text-white text-lg mb-4 flex items-center gap-2"><i data-lucide="briefcase" class="text-orange-500"></i> Tambah Guru Satuan</h3>
                    <div class="space-y-4">
                        <input type="text" id="manualNamaGuru" class="w-full bg-slate-950 text-white p-3 rounded-lg border border-slate-700" placeholder="Nama Lengkap Guru">
                        <input type="text" id="manualNIP" class="w-full bg-slate-950 text-white p-3 rounded-lg border border-slate-700" placeholder="NIP (Akan jadi Username)">
                        <button onclick="simpanManual('guru')" class="w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-3 rounded-lg transition">Simpan Guru</button>
                    </div>
                </div>
            </div>

            <div id="area-input-manage" class="hidden bg-slate-900 p-6 rounded-2xl border border-slate-800">
                <h3 class="font-bold text-white text-lg mb-4 flex items-center gap-2"><i data-lucide="search" class="text-purple-500"></i> Cari & Kelola User (Mutasi)</h3>
                
                <div class="mb-4">
                    <input type="text" id="cariUserBox" onkeyup="cariUser()" class="w-full bg-slate-950 text-white p-3 rounded-lg border border-slate-700" placeholder="Ketik Nama atau NISN siswa yang akan dihapus...">
                </div>

                <div class="overflow-x-auto max-h-96 border border-slate-800 rounded-lg">
                    <table class="w-full text-left text-slate-400">
                        <thead class="bg-slate-950 text-xs uppercase font-bold text-slate-500 sticky top-0">
                            <tr><th class="p-3">Nama</th><th class="p-3">ID/NISN</th><th class="p-3">Kelas</th><th class="p-3 text-right">Aksi</th></tr>
                        </thead>
                        <tbody id="tabel-hasil-cari" class="divide-y divide-slate-800">
                            <tr><td colspan="4" class="p-4 text-center italic">Ketik nama siswa di atas...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>

        <div id="view-mapel" class="hidden space-y-6 fade-in">
            <h2 class="text-3xl font-bold text-white">Database Mata Pelajaran</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-slate-900 p-6 rounded-2xl border border-slate-800">
                    <h3 class="font-bold text-white mb-4">Tambah Mapel</h3>
                    <div class="space-y-4">
                        <input type="text" id="inputNamaMapel" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700" placeholder="Nama Mapel (Cth: Matematika)">
                        <button onclick="tambahMapel()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg">Simpan</button>
                    </div>
                </div>
                <div class="md:col-span-2 bg-slate-900 p-6 rounded-2xl border border-slate-800">
                    <h3 class="font-bold text-white mb-4">Daftar Mapel Terdaftar</h3>
                    <div class="max-h-96 overflow-y-auto">
                        <ul id="list-mapel" class="space-y-2"><li class="text-center text-slate-500 italic">Memuat...</li></ul>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-menu-manager" class="hidden space-y-6 fade-in">
            <h2 class="text-3xl font-bold text-white">App Builder (Menu Manager)</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-slate-900 p-6 rounded-2xl border border-slate-800">
                    <h3 class="font-bold text-white mb-4">Tambah Tombol Baru</h3>
                    <div class="space-y-4">
                        <div><label class="text-xs text-slate-500 uppercase font-bold">Target</label><select id="menuTarget" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 mt-1 outline-none"><option value="siswa">Siswa</option><option value="guru">Guru</option><option value="ortu">Orang Tua</option><option value="umum">Umum</option></select></div>
                        <div><label class="text-xs text-slate-500 uppercase font-bold">Judul Fitur</label><input type="text" id="menuJudul" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 mt-1" placeholder="Contoh: E-Raport"></div>
                        <div><label class="text-xs text-slate-500 uppercase font-bold">Ikon (Emoji)</label><input type="text" id="menuIcon" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 mt-1" placeholder="Contoh: ðŸŽ“"></div>
                        <div><label class="text-xs text-slate-500 uppercase font-bold">Link File</label><input type="text" id="menuLink" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 mt-1" placeholder="Contoh: raport.html"></div>
                        <div class="flex items-center gap-2 p-2 bg-slate-800/50 rounded-lg border border-slate-700"><input type="checkbox" id="menuWarna" class="w-4 h-4 cursor-pointer accent-blue-600"><label for="menuWarna" class="text-sm text-slate-300 cursor-pointer select-none">Highlight (Warna Warni)</label></div>
                        <button onclick="simpanMenuBaru()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-3 rounded-lg shadow-lg active:scale-95">Terbitkan Tombol</button>
                    </div>
                </div>
                <div class="md:col-span-2 bg-slate-900 p-6 rounded-2xl border border-slate-800">
                    <h3 class="font-bold text-white mb-4">Daftar Tombol Aktif</h3>
                    <div class="overflow-x-auto"><table class="w-full text-left text-sm text-slate-400"><thead class="bg-slate-950 text-xs uppercase font-bold text-slate-500"><tr><th class="p-3">Target</th><th class="p-3">Ikon</th><th class="p-3">Judul</th><th class="p-3">Link</th><th class="p-3 text-right">Aksi</th></tr></thead><tbody id="tbody-menu-list" class="divide-y divide-slate-800"></tbody></table></div>
                </div>
            </div>
        </div>

        <div id="view-settings" class="hidden space-y-6 fade-in">
            <h2 class="text-3xl font-bold text-white flex items-center gap-3"><i data-lucide="settings" class="w-8 h-8 text-blue-500"></i> Pengaturan & Fitur</h2>
            
            <div class="bg-slate-900 rounded-[2rem] border border-slate-800 p-8 shadow-2xl mb-6 relative overflow-hidden">
                <h3 class="font-bold text-white text-lg mb-6 flex items-center gap-2"><i data-lucide="shield-check" class="text-blue-500"></i> Kelola Tim Admin</h3>
                <div class="flex gap-4 items-end mb-6">
                    <div class="flex-1">
                        <label class="text-xs text-slate-500 uppercase font-bold">NIP / Username Calon Admin</label>
                        <input type="text" id="inputCalonAdmin" class="w-full bg-slate-950 text-white p-3 rounded-lg border border-slate-700 mt-1" placeholder="Masukkan NIP atau Username...">
                    </div>
                    <button onclick="angkatJadiAdmin()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg">Jadikan Admin</button>
                </div>
                <h4 class="text-sm font-bold text-slate-500 mb-2">Daftar Admin Aktif:</h4>
                <div id="list-admin-aktif" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    <div class="text-slate-500 italic text-sm">Memuat data admin...</div>
                </div>
            </div>

            <div class="bg-slate-900 rounded-[2rem] border border-slate-800 p-8 shadow-2xl relative overflow-hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                    <div>
                        <div class="flex items-center justify-between mb-6">
                            <div><h3 class="font-bold text-white text-lg">Mode Disiplin GPS</h3><p class="text-xs text-slate-400 mt-1">Jika ON, siswa wajib dalam radius sekolah.</p></div>
                            <div class="relative inline-block w-14 align-middle select-none"><input type="checkbox" id="toggleGPS" class="toggle-checkbox absolute block w-8 h-8 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-600 transition-all duration-300" onchange="updateLabelStatus()"/><label for="toggleGPS" class="toggle-label block overflow-hidden h-8 rounded-full bg-slate-700 cursor-pointer"></label></div>
                        </div>
                        <div id="statusGPSBadge" class="inline-block px-4 py-2 rounded-lg text-xs font-black uppercase tracking-widest bg-slate-800 text-slate-500">Menunggu Data...</div>
                        
                        <div class="mt-6 space-y-4">
                            <div class="flex items-center justify-between p-3 bg-slate-950/50 rounded-xl border border-slate-700">
                                <div><h4 class="font-bold text-white text-sm">Refleksi KBM (Ortu)</h4></div>
                                <div class="relative inline-block w-10 align-middle select-none"><input type="checkbox" id="toggleKBM_Ortu" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-2 appearance-none cursor-pointer border-slate-600 transition-all duration-300"/><label for="toggleKBM_Ortu" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-700 cursor-pointer"></label></div>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-slate-950/50 rounded-xl border border-slate-700">
                                <div><h4 class="font-bold text-white text-sm">Evaluasi Siswa (Guru)</h4></div>
                                <div class="relative inline-block w-10 align-middle select-none"><input type="checkbox" id="toggleRefleksi_Guru" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-2 appearance-none cursor-pointer border-slate-600 transition-all duration-300"/><label for="toggleRefleksi_Guru" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-700 cursor-pointer"></label></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-slate-950/50 p-6 rounded-2xl border border-slate-800">
                        <h4 class="font-bold text-white text-sm mb-4 flex items-center gap-2"><i data-lucide="map-pin" class="w-4 h-4 text-orange-500"></i> Titik Koordinat Sekolah</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-[10px] text-slate-500 uppercase font-bold mb-1">Latitude</label><input type="text" id="inputLat" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-white text-xs font-mono" placeholder="-7.xxxxx"></div>
                            <div><label class="block text-[10px] text-slate-500 uppercase font-bold mb-1">Longitude</label><input type="text" id="inputLng" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-white text-xs font-mono" placeholder="110.xxxxx"></div>
                        </div>
                        <div class="mt-4">
                            <div class="flex justify-between items-end mb-2"><label class="font-bold text-white text-xs">Jarak Toleransi</label><span id="labelRadius" class="text-xl font-black text-blue-500">50m</span></div>
                            <input type="range" id="inputRadius" min="10" max="1000" step="10" class="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-blue-600" oninput="updateLabelRadius()">
                        </div>
                    </div>
                </div>
                <button onclick="simpanConfig()" id="btnSaveConfig" class="mt-8 w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-500/20 active:scale-95 transition flex items-center justify-center gap-2"><i data-lucide="save" class="w-5 h-5"></i> SIMPAN SEMUA PENGATURAN</button>
            </div>
        </div>

    </main>

    <div id="loading" class="fixed inset-0 bg-slate-900 flex flex-col items-center justify-center z-50 text-white">
        <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="font-bold animate-pulse">Memuat Sistem...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, getDoc, onSnapshot, doc, setDoc, addDoc, deleteDoc, orderBy, updateDoc, limit } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXWR-_aJyoMrUjTeNQYlcPD8p3eu58yOo",
            authDomain: "siganteng-absensi.firebaseapp.com",
            databaseURL: "https://siganteng-absensi-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "siganteng-absensi",
            storageBucket: "siganteng-absensi.firebasestorage.app",
            messagingSenderId: "917873420012",
            appId: "1:917873420012:web:0fe1a9eddc5f94959ba7c9"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let listSiswa = []; 

        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            const role = localStorage.getItem('admin_role');
            document.getElementById('badge-role').innerText = role === 'SUPER' ? 'SUPER ADMIN' : 'OPERATOR';
            
            await tarikDataSiswa(); 
            pantauRealtime();
            loadMenuManager(); 
            loadMapel(); 
            loadSettings();
            loadDaftarAdmin(); 
            document.getElementById('loading').style.display = 'none';
        });

        window.nav = (v) => { 
            document.querySelectorAll('[id^="view-"]').forEach(e => e.classList.add('hidden')); 
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active')); 
            document.getElementById('view-'+v).classList.remove('hidden'); 
            document.getElementById('nav-'+v).classList.add('active'); 
        }

        window.gantiTabInput = (mode) => {
            document.getElementById('area-input-excel').classList.add('hidden');
            document.getElementById('area-input-manual').classList.add('hidden');
            document.getElementById('area-input-manage').classList.add('hidden'); // Tab Baru

            document.getElementById('btn-tab-excel').classList.replace('bg-blue-600', 'bg-slate-800');
            document.getElementById('btn-tab-excel').classList.replace('text-white', 'text-slate-400');
            document.getElementById('btn-tab-manual').classList.replace('bg-blue-600', 'bg-slate-800');
            document.getElementById('btn-tab-manual').classList.replace('text-white', 'text-slate-400');
            document.getElementById('btn-tab-manage').classList.replace('bg-blue-600', 'bg-slate-800');
            document.getElementById('btn-tab-manage').classList.replace('text-white', 'text-slate-400');

            document.getElementById(`area-input-${mode}`).classList.remove('hidden');
            document.getElementById(`btn-tab-${mode}`).classList.replace('bg-slate-800', 'bg-blue-600');
            document.getElementById(`btn-tab-${mode}`).classList.replace('text-slate-400', 'text-white');
        }

        // --- MANAJEMEN USER (CORE) ---
        window.tarikDataSiswa = async (forceRefresh = false) => {
            const cacheKey = 'master_siswa_cache_op'; 
            const cachedData = localStorage.getItem(cacheKey); 
            if (!forceRefresh && cachedData) {
                listSiswa = JSON.parse(cachedData);
                document.getElementById('stat-total').innerText = listSiswa.length;
                populateKelasDropdown(); // Generate Dropdown Kelas
                return;
            }
            try {
                if(forceRefresh) document.getElementById('loading').style.display = 'flex';
                const q = query(collection(db, "users"), where("role", "!=", "guru")); 
                const snap = await getDocs(q);
                listSiswa = []; 
                snap.forEach(doc => { const s = doc.data(); listSiswa.push(s); });
                localStorage.setItem(cacheKey, JSON.stringify(listSiswa)); 
                document.getElementById('stat-total').innerText = listSiswa.length;
                populateKelasDropdown(); // Generate Dropdown Kelas
                if(forceRefresh) { document.getElementById('loading').style.display = 'none'; Swal.fire('Sip','Data user diperbarui','success'); }
            } catch (e) { console.log(e); }
        }

        // --- NEW: POPULATE KELAS DROPDOWN (ANTI TYPO) ---
        function populateKelasDropdown() {
            const select = document.getElementById('manualKelas');
            select.innerHTML = '<option value="">- Pilih Kelas -</option>';
            
            const uniqueKelas = [...new Set(listSiswa.map(s => s.kelas))].filter(k => k && k !== '-').sort();
            uniqueKelas.forEach(k => {
                select.add(new Option(k, k));
            });
        }

        // --- NEW: CARI USER (LOCAL FILTER) ---
        window.cariUser = () => {
            const key = document.getElementById('cariUserBox').value.toLowerCase();
            const tbody = document.getElementById('tabel-hasil-cari');
            tbody.innerHTML = '';

            if(key.length < 3) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center italic text-xs">Ketik minimal 3 huruf...</td></tr>';
                return;
            }

            const hasil = listSiswa.filter(s => s.nama.toLowerCase().includes(key) || s.username.includes(key));
            
            if(hasil.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-400">Tidak ditemukan.</td></tr>';
                return;
            }

            hasil.slice(0, 10).forEach(s => {
                tbody.innerHTML += `
                    <tr class="border-b border-slate-800 hover:bg-slate-800">
                        <td class="p-3 text-white font-bold">${s.nama}</td>
                        <td class="p-3 font-mono text-xs text-blue-400">${s.username}</td>
                        <td class="p-3 text-xs">${s.kelas}</td>
                        <td class="p-3 text-right">
                            <button onclick="hapusUser('${s.username}', '${s.nama}')" class="bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded text-xs font-bold transition">Mutasi/Hapus</button>
                        </td>
                    </tr>
                `;
            });
        }

        // --- NEW: HAPUS USER (MUTASI) ---
        window.hapusUser = async (username, nama) => {
            const { value: confirm } = await Swal.fire({
                title: 'Hapus Permanen?',
                text: `Siswa ${nama} akan dihapus dari sistem. Data tidak bisa kembali!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, Hapus!'
            });

            if (confirm) {
                try {
                    await deleteDoc(doc(db, "users", username));
                    
                    // Update Local Data (Biar gak perlu refresh page & hemat kuota)
                    listSiswa = listSiswa.filter(s => s.username !== username);
                    localStorage.setItem('master_siswa_cache_op', JSON.stringify(listSiswa));
                    document.getElementById('stat-total').innerText = listSiswa.length;
                    
                    // Clear search box
                    document.getElementById('cariUserBox').value = '';
                    document.getElementById('tabel-hasil-cari').innerHTML = '<tr><td colspan="4" class="p-4 text-center text-green-400">User berhasil dihapus!</td></tr>';
                    
                    Swal.fire('Terhapus!', 'Data user telah dihapus.', 'success');
                } catch (e) {
                    Swal.fire('Gagal', e.message, 'error');
                }
            }
        }

        window.simpanManual = async (role) => {
            let nama, user, pass, kelas;
            if(role === 'siswa') {
                nama = document.getElementById('manualNamaSiswa').value;
                user = document.getElementById('manualNISN').value;
                kelas = document.getElementById('manualKelas').value; // Ambil dari Dropdown
                pass = user; 
                if(!nama || !user || !kelas) return Swal.fire('Lengkapi', 'Nama, NISN, dan Kelas wajib diisi', 'warning');
            } else {
                nama = document.getElementById('manualNamaGuru').value;
                user = document.getElementById('manualNIP').value;
                pass = "123456"; 
                kelas = "-";
                if(!nama || !user) return Swal.fire('Lengkapi', 'Nama dan NIP wajib diisi', 'warning');
            }
            try {
                const docRef = doc(db, "users", user);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) return Swal.fire('Gagal', `Username ${user} sudah ada!`, 'error');
                await setDoc(doc(db, "users", user), { nama, username: user, password: pass, role, kelas, wali_kelas: "-" });
                Swal.fire('Berhasil', `Data ${role} tersimpan!`, 'success');
                if(role === 'siswa') { document.getElementById('manualNamaSiswa').value=''; document.getElementById('manualNISN').value=''; document.getElementById('manualKelas').value=''; }
                else { document.getElementById('manualNamaGuru').value=''; document.getElementById('manualNIP').value=''; }
                tarikDataSiswa(true); 
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
        }

        window.prosesImport = async (tipe) => { 
            const file = document.getElementById(tipe==='siswa'?'fileSiswa':'fileGuru').files[0]; 
            if(!file) return; 
            const reader = new FileReader(); 
            reader.onload = async(e) => { 
                const wb = XLSX.read(e.target.result,{type:'array'}); 
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1}); 
                for(let i=1;i<json.length;i++) { 
                    const r=json[i]; 
                    if(r[0]) { 
                        let u=String(r[1]).replace(/[^a-zA-Z0-9]/g,'').trim(); 
                        await setDoc(doc(db,"users",u),{nama:r[0],username:u,password:String(r[2]||"123456"), role:tipe, kelas:String(r[3]||"-").toUpperCase().trim(), wali_kelas:String(r[4]||"-").toUpperCase()},{merge:true}); 
                    } 
                } 
                Swal.fire('Selesai','Import Berhasil','success'); tarikDataSiswa(true); 
            }; reader.readAsArrayBuffer(file); 
        }

        // --- DASHBOARD MONITOR ---
        function pantauRealtime() {
            const todayStr = new Date().toLocaleDateString('fr-CA');
            const qAllToday = query(collection(db, "absensi"), where("tanggal", "==", todayStr));
            onSnapshot(qAllToday, (snap) => {
                let hadir = 0; let logData = [];
                snap.forEach(doc => { 
                    const d = doc.data(); 
                    if(d.status_terakhir.includes("Masuk") || d.status_terakhir.includes("Hadir")) hadir++;
                    logData.push(d); 
                });
                document.getElementById('stat-hadir').innerText = hadir;
                
                logData.sort((a,b) => (b.jam_masuk ? b.jam_masuk.seconds : 0) - (a.jam_masuk ? a.jam_masuk.seconds : 0));
                const tabel = document.getElementById('tabel-live'); tabel.innerHTML = "";
                logData.slice(0, 10).forEach(data => {
                      let dev = "Unknown";
                      if(data.device_info) {
                          if(data.device_info.includes("Android")) dev = "ðŸ“± Android";
                          else if(data.device_info.includes("iPhone")) dev = "ðŸ“± iPhone";
                          else if(data.device_info.includes("Windows")) dev = "ðŸ’» PC";
                      }
                      tabel.innerHTML += `<tr class="border-b border-slate-800 hover:bg-slate-800/50"><td class="p-4 text-emerald-400 font-mono text-xs">${data.riwayat_kegiatan ? data.riwayat_kegiatan[data.riwayat_kegiatan.length-1].split(' - ')[0] : '-'}</td><td class="p-4 text-white font-bold">${data.nama}</td><td class="p-4 text-xs font-bold text-slate-500 bg-slate-900 rounded">${data.status_terakhir}</td><td class="p-4 text-xs text-slate-500">${dev}</td></tr>`;
                });
            });
            // Hitung Guru
            getDocs(query(collection(db, "users"), where("role", "==", "guru"))).then(s => document.getElementById('stat-guru').innerText = s.size);
        }

        // --- FITUR LAIN ---
        function loadMapel() { onSnapshot(query(collection(db, "mata_pelajaran"), orderBy("nama", "asc")), (snap) => { const list = document.getElementById('list-mapel'); list.innerHTML = ''; snap.forEach(doc => { list.innerHTML += `<li class="flex justify-between items-center bg-slate-800 p-3 rounded-lg border border-slate-700"><span class="text-white font-bold">${doc.data().nama}</span><button onclick="hapusMapel('${doc.id}')" class="text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></li>`; }); lucide.createIcons(); }); }
        window.tambahMapel = async () => { const nama = document.getElementById('inputNamaMapel').value.trim(); if(nama) { await addDoc(collection(db, "mata_pelajaran"), {nama}); document.getElementById('inputNamaMapel').value = ''; Swal.fire('Sukses','','success'); } }
        window.hapusMapel = async (id) => { if(confirm("Hapus?")) await deleteDoc(doc(db,"mata_pelajaran",id)); }
        
        function loadMenuManager() { onSnapshot(query(collection(db, "menu_dinamis"), orderBy("created_at", "asc")), (snap) => { const tb = document.getElementById('tbody-menu-list'); tb.innerHTML = ''; snap.forEach(d => { const data = d.data(); tb.innerHTML += `<tr class="hover:bg-slate-800"><td class="p-3 uppercase text-blue-400 font-bold">${data.target}</td><td class="p-3">${data.icon}</td><td class="p-3 text-white">${data.judul}</td><td class="p-3 text-xs font-mono text-blue-400">${data.link}</td><td class="p-3 text-right"><button onclick="hapusMenu('${d.id}')" class="text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`; }); lucide.createIcons(); }); }
        window.simpanMenuBaru = async () => { const t = document.getElementById('menuTarget').value; const j = document.getElementById('menuJudul').value; const i = document.getElementById('menuIcon').value; const l = document.getElementById('menuLink').value; if(j&&l) { await addDoc(collection(db, "menu_dinamis"), {target:t, judul:j, icon:i, link:l, highlight:document.getElementById('menuWarna').checked, created_at: new Date().toISOString()}); Swal.fire('Sukses','','success'); } }
        window.hapusMenu = async(id) => { if(confirm("Hapus?")) await deleteDoc(doc(db,"menu_dinamis",id)); }

        // --- SETTINGS ---
        async function loadSettings() { onSnapshot(doc(db, "pengaturan", "sekolah"), (docSnap) => { if (docSnap.exists()) { const d = docSnap.data(); document.getElementById('toggleGPS').checked = d.validasi_gps_aktif; document.getElementById('inputLat').value = d.lokasi_lat || "-7.6739830"; document.getElementById('inputLng').value = d.lokasi_lng || "109.6319560"; document.getElementById('inputRadius').value = d.radius_meter || 50; updateLabelRadius(); updateLabelStatus(); } }); onSnapshot(doc(db, "pengaturan", "fitur"), (docSnap) => { if (docSnap.exists()) { const d = docSnap.data(); document.getElementById('toggleKBM_Ortu').checked = d.kbm_ortu_aktif; document.getElementById('toggleRefleksi_Guru').checked = d.refleksi_guru_aktif; } }); }
        window.simpanConfig = async () => { const btn = document.getElementById('btnSaveConfig'); btn.innerHTML = `<i class="animate-spin" data-lucide="loader-2"></i> Menyimpan...`; try { await setDoc(doc(db, "pengaturan", "sekolah"), { lokasi_lat: parseFloat(document.getElementById('inputLat').value), lokasi_lng: parseFloat(document.getElementById('inputLng').value), radius_meter: parseInt(document.getElementById('inputRadius').value), validasi_gps_aktif: document.getElementById('toggleGPS').checked }, { merge: true }); await setDoc(doc(db, "pengaturan", "fitur"), { kbm_ortu_aktif: document.getElementById('toggleKBM_Ortu').checked, refleksi_guru_aktif: document.getElementById('toggleRefleksi_Guru').checked }, { merge: true }); Swal.fire('Berhasil!', '', 'success'); } catch(e) { Swal.fire('Error', e.message, 'error'); } finally { btn.innerHTML = `<i data-lucide="save"></i> SIMPAN SEMUA PENGATURAN`; lucide.createIcons(); } }
        window.updateLabelRadius = () => document.getElementById('labelRadius').innerText = document.getElementById('inputRadius').value + "m";
        window.updateLabelStatus = () => { const o = document.getElementById('toggleGPS').checked; const b = document.getElementById('statusGPSBadge'); b.innerText = o ? "MODE DISIPLIN: AKTIF" : "MODE DARURAT (BEBAS)"; b.className = o ? "inline-block px-4 py-2 rounded-lg text-xs font-black uppercase tracking-widest bg-emerald-900 text-emerald-400" : "inline-block px-4 py-2 rounded-lg text-xs font-black uppercase tracking-widest bg-red-900 text-red-400"; }

        function loadDaftarAdmin() { onSnapshot(query(collection(db, "users"), where("role", "==", "admin")), (snap) => { const container = document.getElementById('list-admin-aktif'); container.innerHTML = ''; snap.forEach(doc => { const d = doc.data(); container.innerHTML += `<div class="flex justify-between items-center bg-slate-950 p-3 rounded-lg border border-slate-800"><div><p class="text-white font-bold text-sm">${d.nama}</p><p class="text-xs text-slate-500 font-mono">${d.username}</p></div><button onclick="copotAdmin('${doc.id}', '${d.nama}')" class="text-red-500 hover:bg-red-500/10 p-2 rounded"><i data-lucide="shield-off" class="w-4 h-4"></i></button></div>`; }); lucide.createIcons(); }); }
        window.angkatJadiAdmin = async () => { const u = document.getElementById('inputCalonAdmin').value; if(!u) return; const q = query(collection(db, "users"), where("username", "==", u)); const snap = await getDocs(q); if(snap.empty) return Swal.fire('Gagal', 'User tidak ditemukan', 'error'); snap.forEach(async (d) => { await updateDoc(doc(db, "users", d.id), { role: 'admin' }); }); Swal.fire('Sukses', '', 'success'); document.getElementById('inputCalonAdmin').value=''; }
        window.copotAdmin = async (id, nama) => { if(confirm(`Copot admin ${nama}?`)) await updateDoc(doc(db, "users", id), { role: 'guru' }); }
        window.logout = () => { localStorage.clear(); window.location.href='index.html'; }
    </script>
</body>
</html>
