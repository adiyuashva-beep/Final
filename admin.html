<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Guru - SiGanteng (Laporan MBG Fix)</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .glass-header { background: linear-gradient(135deg, #0f172a 0%, #334155 100%); }
        .modal { opacity: 0; visibility: hidden; transition: all 0.3s ease-in-out; }
        .modal.active { opacity: 1; visibility: visible; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        .btn-jumbo { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-jumbo:active { transform: scale(0.95); }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col pb-24">

    <header class="glass-header p-6 pb-24 rounded-b-[2.5rem] shadow-xl relative z-10 text-white">
        <div class="flex justify-between items-start mb-6">
            <div>
                <p class="text-slate-300 text-[10px] font-bold uppercase tracking-[0.2em]">Panel Pendidik</p>
                <h1 class="text-2xl font-black">SiGanteng <span class="text-emerald-400">Guru</span></h1>
            </div>
            <button onclick="logout()" class="bg-white/10 p-2 rounded-full hover:bg-red-500 transition"><i data-lucide="log-out" class="w-5 h-5"></i></button>
        </div>

        <div class="flex items-center gap-4">
            <div class="relative group cursor-pointer active:scale-95 transition" onclick="bukaKameraProfil()">
                <div class="w-16 h-16 rounded-2xl bg-white p-1 shadow-lg">
                    <img id="foto-guru" src="" class="w-full h-full rounded-xl object-cover" onerror="this.src='https://ui-avatars.com/api/?background=random&color=fff'">
                </div>
                <div class="absolute -bottom-2 -right-2 bg-blue-600 text-white p-1.5 rounded-lg border-2 border-white shadow-sm">
                    <i data-lucide="camera" class="w-3 h-3"></i>
                </div>
            </div>
            <div>
                <h2 id="nama-guru" class="text-lg font-bold leading-tight">...</h2>
                <p id="nip-guru" class="text-xs font-mono text-slate-300 mt-1">...</p>
                <div id="badge-wali" class="hidden mt-2 inline-block bg-orange-500 text-white text-[9px] font-black px-2 py-0.5 rounded">WALI KELAS</div>
            </div>
        </div>
    </header>

    <main class="flex-1 px-5 -mt-16 relative z-20 space-y-6">

        <div id="panel-wali-kelas" class="hidden bg-white p-1 rounded-[2.5rem] shadow-xl border border-slate-100 relative overflow-hidden group">
            <div class="bg-orange-50 p-6 rounded-[2.3rem] border border-orange-100 relative overflow-hidden">
                <div class="absolute -right-5 -top-5 w-32 h-32 bg-orange-200 rounded-full opacity-20 blur-2xl group-hover:scale-150 transition duration-700"></div>
                
                <div class="flex justify-between items-center mb-6 relative z-10">
                    <div>
                        <p class="text-[10px] font-bold text-orange-600 uppercase tracking-widest mb-1">Monitoring Siswa</p>
                        <h3 class="font-black text-orange-900 text-2xl leading-none">Kelas <span id="nama-kelas-wali">...</span></h3>
                    </div>
                    <div class="bg-white p-3 rounded-full shadow-sm text-orange-500">
                        <i data-lucide="users" class="w-6 h-6"></i>
                    </div>
                </div>

                <div class="space-y-3 relative z-10">
                    <button onclick="bukaModalWali()" class="btn-jumbo w-full bg-white text-orange-600 border-2 border-orange-100 py-4 rounded-2xl text-xs font-black uppercase tracking-widest hover:bg-orange-50 shadow-sm flex items-center justify-center gap-2">
                        <i data-lucide="eye" class="w-4 h-4"></i> LIHAT ABSENSI
                    </button>

                    <button onclick="downloadLaporanWali()" class="btn-jumbo w-full bg-emerald-500 text-white border-2 border-emerald-600 py-4 rounded-2xl text-xs font-black uppercase tracking-widest hover:bg-emerald-600 shadow-lg shadow-emerald-200 flex items-center justify-center gap-2">
                          DOWNLOAD LAPORAN MBG
                    </button>
                </div>
            </div>
        </div>

        <div id="section-menu-dinamis" class="hidden">
            <h3 class="font-bold text-slate-700 text-sm mb-2 ml-1 flex items-center gap-2">
                <i data-lucide="grid" class="w-4 h-4 text-blue-500"></i> Layanan Digital
            </h3>
            <div id="grid-menu-dinamis" class="grid grid-cols-2 gap-3"></div>
        </div>

        <div class="bg-white p-6 rounded-[2rem] shadow-lg border border-slate-100">
            <h3 class="font-bold text-slate-700 text-sm uppercase tracking-widest mb-4 flex items-center gap-2">
                <i data-lucide="book-open" class="w-4 h-4 text-blue-500"></i> Jurnal Mengajar
            </h3>
            
            <div class="space-y-3">
                <select id="jurnal-kelas" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-xs font-bold text-slate-600 outline-none transition focus:border-blue-500">
                    <option value="">- Pilih Kelas -</option>
                </select>
                
                <select id="jurnal-mapel" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-xs font-bold text-slate-600 outline-none transition focus:border-blue-500">
                    <option value="">- Pilih Mapel -</option>
                </select>

                <textarea id="jurnal-materi" rows="2" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-xs font-bold text-slate-600 outline-none transition focus:border-blue-500" placeholder="Materi / Bahasan Hari Ini..."></textarea>
                
                <div class="flex items-center gap-3">
                    <button onclick="bukaKameraJurnal()" class="bg-slate-100 p-3 rounded-xl border border-slate-200 text-slate-500 hover:bg-slate-200 transition">
                        <i data-lucide="camera" class="w-5 h-5"></i>
                    </button>
                    <div id="preview-foto-jurnal" class="text-xs text-slate-400 italic">Wajib foto bukti KBM.</div>
                </div>

                <button onclick="kirimJurnal()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold text-xs shadow-lg shadow-blue-500/30 active:scale-95 transition">SIMPAN JURNAL</button>
            </div>

            <div class="mt-4 pt-4 border-t border-slate-100">
                <button onclick="downloadRekapJurnal()" class="w-full bg-slate-50 text-slate-600 py-3 rounded-xl font-bold text-xs border border-slate-200 hover:bg-slate-100 transition flex items-center justify-center gap-2">
                    <i data-lucide="archive" class="w-4 h-4"></i> ARSIP JURNAL
                </button>
            </div>

            <div class="mt-4 pt-4 border-t border-slate-100">
                <h4 class="font-bold text-xs text-slate-400 uppercase mb-3">Riwayat Hari Ini</h4>
                <div id="list-riwayat-jurnal" class="space-y-2">
                    <div class="text-center text-slate-300 text-xs italic py-2">Belum ada jurnal hari ini.</div>
                </div>
            </div>
        </div>

    </main>

    <div id="modal-wali" class="modal fixed inset-0 z-50 flex items-center justify-center bg-slate-900/90 backdrop-blur-sm p-4">
        <div class="modal-content bg-white w-full max-w-lg rounded-3xl overflow-hidden shadow-2xl flex flex-col max-h-[85vh]">
            <div class="bg-orange-50 p-4 border-b border-orange-100 flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-orange-800">Data Siswa</h3>
                    <p class="text-[10px] text-orange-600">Kelas <span id="judul-modal-wali"></span></p>
                </div>
                <div class="flex gap-2">
                    <button onclick="window.resetCacheData()" class="p-2 bg-white rounded-full text-orange-500 hover:bg-orange-100 shadow-sm"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
                    <button onclick="document.getElementById('modal-wali').classList.remove('active')" class="p-2 bg-red-100 rounded-full text-red-500 hover:bg-red-200"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
            </div>
            <div class="overflow-y-auto p-4 space-y-3 bg-slate-50" id="list-siswa-wali">
                <div class="text-center py-10 text-slate-400 italic">Memuat data...</div>
            </div>
        </div>
    </div>

    <div id="modalKamera" class="hidden fixed inset-0 z-50 bg-black flex flex-col items-center justify-center">
        <div class="absolute top-0 w-full p-6 flex justify-between z-30">
            <h3 id="judul-kamera" class="text-white font-bold bg-black/50 px-3 py-1 rounded-full text-xs">KAMERA</h3>
            <button onclick="tutupKamera()" class="text-white"><i data-lucide="x" class="w-8 h-8"></i></button>
        </div>
        <div class="relative w-full h-full bg-black">
            <video id="videoStream" autoplay playsinline muted class="w-full h-full object-cover"></video>
            <canvas id="canvasFoto" class="hidden"></canvas>
        </div>
        <div class="absolute bottom-10 z-30"><button onclick="jepret()" class="w-16 h-16 bg-white rounded-full border-4 border-slate-300 shadow-xl active:scale-95 transition"></button></div>
    </div>

    <div id="loading" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center">
        <div class="animate-spin rounded-full h-10 w-10 border-4 border-white border-t-transparent"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, where, getDocs, addDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBXWR-_aJyoMrUjTeNQYlcPD8p3eu58yOo",
            authDomain: "siganteng-absensi.firebaseapp.com",
            databaseURL: "https://siganteng-absensi-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "siganteng-absensi",
            storageBucket: "siganteng-absensi.firebasestorage.app",
            messagingSenderId: "917873420012",
            appId: "1:917873420012:web:0fe1a9eddc5f94959ba7c9"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // GLOBAL VARIABLES
        let userGuru = null;
        let streamKamera = null;
        let tipeAbsenAktif = "";
        let fotoBuktiJurnal = null;
        let dataSiswaWali = []; // Data Siswa
        let dataAbsenWali = {}; // Data Absen Hari Ini

        // --- 1. DATE FORMATTER (WAJIB ADA UNTUK DATA KOSONG) ---
        // Ini memastikan format tanggal selalu YYYY-MM-DD sesuai database
        const getTodayStr = () => {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // --- CACHE SYSTEM ---
        const setCache = (key, data) => { try { localStorage.setItem(key, JSON.stringify({ timestamp: Date.now(), data: data })); } catch (e) {} };
        const getCache = (key) => { const item = localStorage.getItem(key); if(!item) return null; const p = JSON.parse(item); if((Date.now() - p.timestamp) > 86400000) { localStorage.removeItem(key); return null; } return p.data; };
        window.resetCacheData = () => { localStorage.clear(); location.reload(); };

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            const sess = sessionStorage.getItem('user_siganteng');
            if (sess) {
                userGuru = JSON.parse(sess);
                initDashboard();
                loadDaftarKelas();
                loadDaftarMapel();
                loadRiwayatJurnal();
                loadMenuDinamis();
                if(userGuru.wali_kelas && userGuru.wali_kelas !== "-") initWaliKelas(userGuru.wali_kelas);
            } else { window.location.href = 'index.html'; }
        });

        function initDashboard() { 
            document.getElementById('nama-guru').innerText = userGuru.nama; 
            document.getElementById('nip-guru').innerText = "NIP: " + userGuru.username; 
            const cachedFoto = localStorage.getItem('foto_profil_guru');
            if(cachedFoto) document.getElementById('foto-guru').src = cachedFoto;
            getDoc(doc(db, "guru", userGuru.username)).then(snap => {
                if(snap.exists() && snap.data().foto_profil) {
                    const url = snap.data().foto_profil;
                    document.getElementById('foto-guru').src = url;
                    localStorage.setItem('foto_profil_guru', url);
                }
            });
        }

        // --- WALI KELAS LOGIC (FIXED) ---
        async function initWaliKelas(kelasWali) {
            document.getElementById('panel-wali-kelas').classList.remove('hidden');
            document.getElementById('nama-kelas-wali').innerText = kelasWali;
            document.getElementById('badge-wali').classList.remove('hidden');
            document.getElementById('judul-modal-wali').innerText = kelasWali;

            dataSiswaWali = getCache(`wali_siswa_${kelasWali}`);

            if(!dataSiswaWali) {
                const qSiswa = query(collection(db, "users"), where("kelas", "==", kelasWali), where("role", "==", "siswa"));
                const snap = await getDocs(qSiswa);
                dataSiswaWali = [];
                snap.forEach(doc => {
                    const d = doc.data();
                    if(d.nama && d.username && d.nama.length > 2) {
                        dataSiswaWali.push({ nama: d.nama, username: d.username });
                    }
                });
                setCache(`wali_siswa_${kelasWali}`, dataSiswaWali);
            }

            // Gunakan getTodayStr() agar tanggal konsisten
            const todayStr = getTodayStr();
            const qAbsen = query(collection(db, "absensi"), where("tanggal", "==", todayStr), where("kelas", "==", kelasWali));
            onSnapshot(qAbsen, (snap) => {
                dataAbsenWali = {};
                snap.forEach(doc => { const d = doc.data(); dataAbsenWali[d.nisn] = d; });
            });
        }

        window.bukaModalWali = () => {
            const container = document.getElementById('list-siswa-wali');
            container.innerHTML = '';
            
            if(!dataSiswaWali || dataSiswaWali.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400">Data siswa kosong.</div>';
                document.getElementById('modal-wali').classList.add('active');
                return;
            }

            dataSiswaWali.sort((a,b) => a.nama.localeCompare(b.nama));
            
            dataSiswaWali.forEach(s => {
                const absen = dataAbsenWali[s.username];
                let statusHtml = `<span class="text-[10px] font-bold bg-red-100 text-red-600 px-3 py-1 rounded-full">ALPHA</span>`;
                
                if(absen) {
                    const st = absen.status_terakhir;
                    let warna = "bg-emerald-100 text-emerald-600";
                    if(st.includes("Sakit")) warna = "bg-blue-100 text-blue-600";
                    else if(st.includes("Izin")) warna = "bg-orange-100 text-orange-600";
                    statusHtml = `<span class="text-[10px] font-bold ${warna} px-3 py-1 rounded-full uppercase">${st}</span>`;
                }

                container.innerHTML += `
                    <div class="flex items-center justify-between bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center font-bold text-slate-400 text-xs border border-slate-200">
                                ${s.nama.substring(0,2).toUpperCase()}
                            </div>
                            <div>
                                <div class="font-bold text-sm text-slate-700 leading-tight">${s.nama}</div>
                                <div class="text-[10px] text-slate-400 mt-0.5">${s.username}</div>
                            </div>
                        </div>
                        <div>${statusHtml}</div>
                    </div>
                `;
            });
            document.getElementById('modal-wali').classList.add('active');
        }

        // --- ðŸ”¥ FITUR BARU: LAPORAN MBG & ABSENSI ðŸ”¥ ---
        window.downloadLaporanWali = () => {
            if(!dataSiswaWali || dataSiswaWali.length === 0) return Swal.fire('Data Kosong','Belum ada data siswa','warning');
            
            Swal.fire({ title: 'Menyusun Laporan MBG...', didOpen: () => Swal.showLoading() });
            
            try {
                let dataExport = [];
                let totalHadir = 0;
                const todayStr = getTodayStr();
                const kls = document.getElementById('nama-kelas-wali').innerText;

                // Tentukan Kategori X/XI/XII dari Nama Kelas
                let kategori = "XII";
                if(kls.startsWith("X ")) kategori = "X";
                else if(kls.startsWith("XI ")) kategori = "XI";

                dataSiswaWali.sort((a,b) => a.nama.localeCompare(b.nama));
                
                dataSiswaWali.forEach((s, index) => {
                    const absen = dataAbsenWali[s.username];
                    let status = "Alpha";
                    let mbg = "TIDAK"; // Default Tidak Dapat

                    if(absen) {
                        status = absen.status_terakhir;
                        // Logika MBG: Hanya yang Masuk/Hadir yang dapat
                        if(status.includes("Masuk") || status.includes("Hadir") || status.includes("Pulang")) {
                            mbg = "DAPAT";
                            totalHadir++;
                        }
                    }

                    dataExport.push({
                        No: index + 1,
                        NISN: s.username,
                        Nama_Siswa: s.nama,
                        Kelas: kls,
                        Tanggal: todayStr,
                        Status_Absen: status,
                        Jatah_MBG: mbg,
                        Keterangan: ""
                    });
                });

                // Tambahkan Baris Ringkasan di Bawah
                dataExport.push({});
                dataExport.push({ Nama_Siswa: "RINGKASAN PORSI MAKAN:" });
                dataExport.push({ Nama_Siswa: `Total Hadir (Dapat Makan): ${totalHadir} Porsi` });
                dataExport.push({ Nama_Siswa: `Kategori Kelas: ${kategori}` });

                const ws = XLSX.utils.json_to_sheet(dataExport);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Rekap MBG");
                XLSX.writeFile(wb, `LAPORAN_MBG_${kls}_${todayStr}.xlsx`);
                
                Swal.close();
                Swal.fire('Selesai', `Laporan MBG Kelas ${kls} berhasil diunduh. Total: ${totalHadir} Porsi.`, 'success');
            } catch (e) {
                console.error(e);
                Swal.fire('Gagal', 'Terjadi kesalahan saat download', 'error');
            }
        }

        // --- DATA LOADERS LAINNYA ---
        async function loadDaftarKelas() {
            const sel = document.getElementById('jurnal-kelas');
            const cached = getCache('list_kelas');
            if(cached) { renderOptions(sel, cached); return; }
            try {
                const snap = await getDocs(query(collection(db, "users"), where("role", "==", "siswa")));
                const kelasUnik = new Set();
                snap.forEach(d => { if(d.data().kelas) kelasUnik.add(d.data().kelas.toUpperCase().trim()); });
                const arr = Array.from(kelasUnik).sort();
                setCache('list_kelas', arr); renderOptions(sel, arr);
            } catch(e){}
        }
        async function loadDaftarMapel() {
            const sel = document.getElementById('jurnal-mapel');
            const cached = getCache('list_mapel');
            if(cached) { renderOptions(sel, cached); return; }
            try {
                const snap = await getDocs(query(collection(db, "mata_pelajaran"), orderBy("nama", "asc")));
                const arr = []; snap.forEach(d => arr.push(d.data().nama));
                setCache('list_mapel', arr); renderOptions(sel, arr);
            } catch(e){}
        }
        function renderOptions(el, arr) { el.innerHTML = '<option value="">- Pilih -</option>'; arr.forEach(i => el.add(new Option(i, i))); }
        
        function loadMenuDinamis() {
            const container = document.getElementById('grid-menu-dinamis'); const sec = document.getElementById('section-menu-dinamis');
            onSnapshot(query(collection(db, "menu_dinamis"), orderBy("created_at", "asc")), (snap) => {
                container.innerHTML = ''; let ada = false;
                snap.forEach(d => {
                    const dt = d.data();
                    if (dt.target === 'guru' || dt.target === 'umum') {
                        ada = true;
                        container.innerHTML += `<a href="${dt.link}" target="_blank" class="bg-white p-4 border border-slate-100 rounded-2xl flex flex-col items-center gap-2 shadow-sm active:scale-95 transition"><div class="text-xl">${dt.icon}</div><span class="text-[10px] font-bold uppercase">${dt.judul}</span></a>`;
                    }
                });
                if(ada) sec.classList.remove('hidden'); else sec.classList.add('hidden');
            });
        }

        // --- KAMERA & JURNAL ---
        window.bukaKameraProfil = () => { tipeAbsenAktif = "ProfilGuru"; document.getElementById('judul-kamera').innerText = "SELFIE PROFIL"; document.getElementById('modalKamera').classList.remove('hidden'); navigator.mediaDevices.getUserMedia({video: {facingMode: 'user', aspectRatio: 1}}).then(s => { streamKamera = s; document.getElementById('videoStream').srcObject = s; }); }
        window.bukaKameraJurnal = () => { tipeAbsenAktif = "Jurnal"; document.getElementById('judul-kamera').innerText = "FOTO BUKTI KBM"; document.getElementById('modalKamera').classList.remove('hidden'); navigator.mediaDevices.getUserMedia({video: {facingMode: 'environment'}}).then(s => { streamKamera = s; document.getElementById('videoStream').srcObject = s; }); }
        window.tutupKamera = () => { document.getElementById('modalKamera').classList.add('hidden'); if(streamKamera) streamKamera.getTracks().forEach(t=>t.stop()); }
        
        window.jepret = async () => {
            const vid = document.getElementById('videoStream'); const can = document.getElementById('canvasFoto'); can.width = 480; can.height = 480; can.getContext('2d').drawImage(vid,0,0,480,480); const foto = can.toDataURL('image/jpeg', 0.7);
            if(tipeAbsenAktif === 'ProfilGuru') {
                try { tutupKamera(); Swal.fire({title:'Update Profil...', didOpen:()=>Swal.showLoading()}); const snap = await uploadString(ref(storage, `profil_guru/${userGuru.username}.jpg`), foto, 'data_url'); const url = await getDownloadURL(snap.ref); await setDoc(doc(db, "guru", userGuru.username), { foto_profil: url }, { merge: true }); localStorage.setItem('foto_profil_guru', url); document.getElementById('foto-guru').src = url; Swal.fire('Sukses', 'Foto Profil Diperbarui', 'success'); } catch(e){ Swal.fire('Gagal', e.message, 'error'); }
            } else if(tipeAbsenAktif === 'Jurnal') {
                fotoBuktiJurnal = foto; document.getElementById('preview-foto-jurnal').innerText = "Foto Terlampir âœ”"; document.getElementById('preview-foto-jurnal').className = "text-xs text-green-600 font-bold italic"; tutupKamera();
            }
        }

        window.kirimJurnal = async () => {
            const kls = document.getElementById('jurnal-kelas').value; const mapel = document.getElementById('jurnal-mapel').value; const materi = document.getElementById('jurnal-materi').value;
            if(!kls || !mapel || !materi) return Swal.fire('Lengkapi','Data Jurnal belum lengkap','warning');
            if(!fotoBuktiJurnal) return Swal.fire('Wajib Foto','Lampirkan foto bukti KBM','warning');
            document.getElementById('loading').classList.remove('hidden');
            try {
                const todayStr = getTodayStr(); // Pakai format konsisten
                const snap = await uploadString(ref(storage, `jurnal_guru/${todayStr}/${userGuru.username}_${Date.now()}.jpg`), fotoBuktiJurnal, 'data_url');
                const urlFoto = await getDownloadURL(snap.ref);
                await addDoc(collection(db, "jurnal_guru"), { nip: userGuru.username, nama_guru: userGuru.nama, kelas: kls, mapel: mapel, materi: materi, foto_bukti: urlFoto, waktu: serverTimestamp(), tanggal: todayStr });
                Swal.fire('Tersimpan', 'Jurnal berhasil diupload.', 'success');
                document.getElementById('jurnal-materi').value = ''; fotoBuktiJurnal = null; document.getElementById('preview-foto-jurnal').innerText = "Belum ada foto bukti."; document.getElementById('preview-foto-jurnal').className = "text-xs text-slate-400 italic";
            } catch(e) { Swal.fire('Gagal', e.message, 'error'); } finally { document.getElementById('loading').classList.add('hidden'); }
        }

        window.downloadRekapJurnal = async () => {
            Swal.fire({ title: 'Menyusun Laporan...', didOpen: () => Swal.showLoading() });
            try {
                const q = query(collection(db, "jurnal_guru"), where("nip", "==", userGuru.username)); const snap = await getDocs(q);
                if (snap.empty) { Swal.fire('Kosong', 'Belum ada data.', 'info'); return; }
                let rawData = []; snap.forEach(doc => rawData.push(doc.data())); rawData.sort((a, b) => (b.waktu?.toMillis() || 0) - (a.waktu?.toMillis() || 0));
                const dataExport = rawData.map(d => ({ Tanggal: d.tanggal, Jam: d.waktu ? new Date(d.waktu.toDate()).toLocaleTimeString('id-ID') : '-', Kelas: d.kelas, Mapel: d.mapel, Materi: d.materi, Bukti: d.foto_bukti }));
                const ws = XLSX.utils.json_to_sheet(dataExport); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Jurnal"); XLSX.writeFile(wb, `JURNAL_${userGuru.nama}.xlsx`); Swal.close();
            } catch (e) { Swal.fire('Error', e.message, 'error'); }
        }

        function loadRiwayatJurnal() {
            const todayStr = getTodayStr();
            onSnapshot(query(collection(db, "jurnal_guru"), where("nip", "==", userGuru.username), where("tanggal", "==", todayStr), orderBy("waktu", "desc")), (snap) => {
                const container = document.getElementById('list-riwayat-jurnal'); container.innerHTML = '';
                if(snap.empty) { container.innerHTML = '<div class="text-center text-slate-300 text-xs italic py-2">Belum ada jurnal hari ini.</div>'; return; }
                snap.forEach(doc => { const d = doc.data(); const jam = d.waktu ? new Date(d.waktu.toDate()).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}) : '-'; container.innerHTML += `<div class="flex items-center gap-3 bg-slate-50 p-2 rounded-xl border border-slate-100"><img src="${d.foto_bukti}" class="w-10 h-10 rounded-lg object-cover bg-slate-200"><div class="flex-1"><div class="flex justify-between"><h5 class="text-xs font-bold text-slate-700">${d.kelas} - ${d.mapel}</h5><span class="text-[10px] font-mono text-slate-400">${jam}</span></div><p class="text-[10px] text-slate-500 truncate">${d.materi}</p></div></div>`; });
            });
        }
        window.logout = () => { sessionStorage.clear(); localStorage.clear(); window.location.href = 'index.html'; }
    </script>
</body>
</html>
