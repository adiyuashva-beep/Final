<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Center - SiGanteng</title>
    
    <script>
        // Cek Login Sederhana
        if (!localStorage.getItem('admin_token')) {
            // window.location.href = 'index.html'; // Aktifkan nanti pas live
        }
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        
        /* Navigasi */
        .nav-item.active { background: rgba(59, 130, 246, 0.1); border-right: 3px solid #3b82f6; color: #60a5fa; }
        
        /* Tabel Sticky */
        .table-sticky th { position: sticky; top: 0; z-index: 10; background: #1e293b; }
        .table-sticky td:first-child, .table-sticky th:first-child { position: sticky; left: 0; z-index: 20; background: #1e293b; }
        
        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #10b981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10b981; }
        
        /* Warna Status Tabel Rekap */
        .bg-weekend { background-color: #334155; color: #475569; }
        .bg-hadir { background-color: #065f46; color: #a7f3d0; font-weight: bold; }
        .bg-sakit { background-color: #1e40af; color: #bfdbfe; font-weight: bold; }
        .bg-izin { background-color: #854d0e; color: #fef08a; font-weight: bold; }
        .bg-alpha { background-color: #7f1d1d; color: #fca5a5; font-weight: bold; }

        /* Modal Animasi */
        .modal { opacity: 0; visibility: hidden; transition: all 0.3s ease-in-out; }
        .modal.active { opacity: 1; visibility: visible; }
        .modal-content { transform: scale(0.95); transition: all 0.3s ease-in-out; }
        .modal.active .modal-content { transform: scale(1); }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-sm">

    <aside class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col hidden md:flex">
        <div class="p-6">
            <h1 class="font-black text-2xl tracking-tighter text-blue-500">SiGanteng</h1>
            <p class="text-xs text-slate-500 tracking-widest uppercase mt-1">Admin Panel v6.0</p>
            <div id="badge-role" class="mt-2 inline-block px-2 py-1 rounded bg-slate-800 text-xs font-bold text-slate-300">...</div>
        </div>

        <nav class="flex-1 space-y-1 px-3 mt-4 overflow-y-auto hide-scroll">
            
            <p class="px-4 text-[10px] font-bold text-slate-600 uppercase mb-2 mt-2">Utama</p>
            <button onclick="nav('dashboard')" id="nav-dashboard" class="nav-item active w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard
            </button>
            <button onclick="nav('rekap')" id="nav-rekap" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition">
                <i data-lucide="calendar-days" class="w-5 h-5"></i> Rekap Absen (BK)
            </button>
            <button onclick="nav('mbg')" id="nav-mbg" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition">
                <i data-lucide="utensils" class="w-5 h-5"></i> Laporan MBG
            </button>

            <p class="px-4 text-[10px] font-bold text-slate-600 uppercase mb-2 mt-4">Akademik & KBM</p>
            <button onclick="nav('kbm')" id="nav-kbm" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition">
                <i data-lucide="book-open-check" class="w-5 h-5"></i> Monitoring KBM
            </button>
            <button onclick="nav('mapel')" id="nav-mapel" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition">
                <i data-lucide="library" class="w-5 h-5"></i> Kelola Mapel
            </button>

            <p class="px-4 text-[10px] font-bold text-slate-600 uppercase mb-2 mt-4">Sistem</p>
            <button onclick="nav('menu-manager')" id="nav-menu-manager" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition">
                <i data-lucide="layout-grid" class="w-5 h-5"></i> Kelola Tombol
            </button>
            <button onclick="nav('libur')" id="nav-libur" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition">
                <i data-lucide="calendar-off" class="w-5 h-5"></i> Kelola Hari Libur
            </button>
            
            <div id="menu-super" class="hidden border-t border-slate-800 pt-4 mt-4">
                <button onclick="nav('data')" id="nav-data" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition">
                    <i data-lucide="database" class="w-5 h-5"></i> Import Data
                </button>
                <button onclick="nav('settings')" id="nav-settings" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition">
                    <i data-lucide="settings" class="w-5 h-5"></i> Remote GPS
                </button>
            </div>
        </nav>

        <div class="p-4 border-t border-slate-800">
            <button onclick="logout()" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-500/10 text-red-500 rounded-lg hover:bg-red-500 hover:text-white transition font-bold">
                <i data-lucide="log-out" class="w-4 h-4"></i> Keluar
            </button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto bg-slate-950 relative p-4 md:p-8">
        
        <div class="md:hidden flex justify-between items-center mb-6">
            <h1 class="font-bold text-lg text-blue-500">SiGanteng Admin</h1>
            <button onclick="logout()" class="text-red-500"><i data-lucide="log-out"></i></button>
        </div>

        <div id="view-dashboard" class="space-y-6 fade-in">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
                <div>
                    <h2 class="text-3xl font-bold text-white">Monitoring Harian</h2>
                    <p class="text-slate-400 text-sm">Realtime Update: <span id="jam-real" class="font-mono text-blue-400">...</span></p>
                </div>
                <div class="flex gap-2">
                    <button onclick="window.open('kiosk_webcam.html', '_blank')" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 text-xs">
                        <i data-lucide="scan-barcode" class="w-4 h-4"></i> Buka Scanner
                    </button>
                    <button onclick="window.open('monitor.html', '_blank')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 text-xs">
                        <i data-lucide="tv" class="w-4 h-4"></i> Layar TV
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-slate-900 p-5 rounded-2xl border border-slate-800"><p class="text-slate-500 text-xs font-bold uppercase">Hadir</p><h3 class="text-3xl font-black text-emerald-400 mt-1" id="stat-hadir">0</h3></div>
                <div class="bg-slate-900 p-5 rounded-2xl border border-slate-800"><p class="text-slate-500 text-xs font-bold uppercase">Izin / Sakit</p><h3 class="text-3xl font-black text-blue-400 mt-1" id="stat-izin">0</h3></div>
                <div class="bg-slate-900 p-5 rounded-2xl border border-slate-800"><p class="text-slate-500 text-xs font-bold uppercase">Alpha / Belum</p><h3 class="text-3xl font-black text-red-400 mt-1" id="stat-alpha">0</h3></div>
                <div class="bg-slate-900 p-5 rounded-2xl border border-slate-800"><p class="text-slate-500 text-xs font-bold uppercase">Total Siswa</p><h3 class="text-3xl font-black text-white mt-1" id="stat-total">0</h3></div>
            </div>

            <div class="mt-6">
                <h3 class="font-bold text-white mb-4 flex items-center gap-2">
                    <i data-lucide="grid" class="w-5 h-5 text-blue-500"></i> Pantauan Per Kelas
                </h3>
                <div id="grid-kelas-container" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                    <div class="col-span-full text-center text-slate-500 py-10">Memuat data kelas...</div>
                </div>
            </div>

            <div class="bg-slate-900 rounded-2xl border border-slate-800 overflow-hidden mt-6">
                <div class="p-4 border-b border-slate-800"><h3 class="font-bold text-white">Log Aktivitas Terbaru</h3></div>
                <div class="overflow-x-auto max-h-96">
                    <table class="w-full text-left text-slate-400">
                        <thead class="bg-slate-950 text-xs uppercase font-bold text-slate-500 sticky top-0">
                            <tr><th class="p-4">Jam</th><th class="p-4">Nama Siswa</th><th class="p-4">Kelas</th><th class="p-4">Status</th><th class="p-4">Via</th></tr>
                        </thead>
                        <tbody id="tabel-live" class="divide-y divide-slate-800"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-rekap" class="hidden space-y-6 fade-in h-full flex flex-col">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <h2 class="text-2xl font-bold text-white">Rekap Absensi (BK)</h2>
                <div class="flex gap-2 bg-slate-900 p-2 rounded-xl border border-slate-800">
                    <select id="pilih-bulan" class="bg-slate-800 text-white text-xs rounded-lg px-3 py-2 outline-none border border-slate-700"></select>
                    <select id="pilih-tahun" class="bg-slate-800 text-white text-xs rounded-lg px-3 py-2 outline-none border border-slate-700"></select>
                    <select id="pilih-kelas" class="bg-slate-800 text-white text-xs rounded-lg px-3 py-2 outline-none border border-slate-700"><option value="">- Pilih Kelas -</option></select>
                    <button onclick="loadRekap()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-xs font-bold">Tampilkan</button>
                    <button onclick="downloadExcel('tabel-rekap')" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg text-xs font-bold" title="Download Excel"><i data-lucide="file-spreadsheet" class="w-4 h-4"></i></button>
                </div>
            </div>
            <div class="flex-1 bg-slate-900 rounded-2xl border border-slate-800 overflow-auto relative">
                <table id="tabel-rekap" class="w-full text-center text-[10px] border-collapse table-sticky whitespace-nowrap">
                    <thead class="text-slate-300 font-bold" id="thead-rekap"></thead>
                    <tbody id="tbody-rekap" class="text-slate-400 divide-y divide-slate-800"></tbody>
                </table>
            </div>
        </div>

        <div id="view-mbg" class="hidden space-y-6 fade-in">
            <h2 class="text-2xl font-bold text-white mb-4">Laporan Logistik (MBG)</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-slate-900 rounded-2xl border border-slate-800 p-6 relative overflow-hidden group hover:border-blue-500 transition cursor-pointer" onclick="previewMBG('X')">
                    <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20"><i data-lucide="utensils" class="w-24 h-24 text-blue-500"></i></div>
                    <h3 class="text-xl font-black text-white">KELAS X</h3>
                    <div class="flex gap-2 mt-4"><div class="bg-emerald-500/20 text-emerald-400 px-3 py-1 rounded text-xs font-bold">Hadir: <span id="mbg-x-hadir">0</span></div><div class="bg-red-500/20 text-red-400 px-3 py-1 rounded text-xs font-bold">Sisa: <span id="mbg-x-sisa">0</span></div></div>
                </div>
                <div class="bg-slate-900 rounded-2xl border border-slate-800 p-6 relative overflow-hidden group hover:border-green-500 transition cursor-pointer" onclick="previewMBG('XI')">
                    <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20"><i data-lucide="utensils" class="w-24 h-24 text-green-500"></i></div>
                    <h3 class="text-xl font-black text-white">KELAS XI</h3>
                    <div class="flex gap-2 mt-4"><div class="bg-emerald-500/20 text-emerald-400 px-3 py-1 rounded text-xs font-bold">Hadir: <span id="mbg-xi-hadir">0</span></div><div class="bg-red-500/20 text-red-400 px-3 py-1 rounded text-xs font-bold">Sisa: <span id="mbg-xi-sisa">0</span></div></div>
                </div>
                <div class="bg-slate-900 rounded-2xl border border-slate-800 p-6 relative overflow-hidden group hover:border-orange-500 transition cursor-pointer" onclick="previewMBG('XII')">
                    <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20"><i data-lucide="utensils" class="w-24 h-24 text-orange-500"></i></div>
                    <h3 class="text-xl font-black text-white">KELAS XII</h3>
                    <div class="flex gap-2 mt-4"><div class="bg-emerald-500/20 text-emerald-400 px-3 py-1 rounded text-xs font-bold">Hadir: <span id="mbg-xii-hadir">0</span></div><div class="bg-red-500/20 text-red-400 px-3 py-1 rounded text-xs font-bold">Sisa: <span id="mbg-xii-sisa">0</span></div></div>
                </div>
            </div>
            
            <div id="container-tabel-mbg" class="hidden bg-white text-slate-900 rounded-2xl p-6 shadow-xl mt-6 border border-slate-700">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg text-slate-800" id="judul-tabel-mbg">Detail Logistik</h3>
                    <button onclick="downloadExcel('tabel-mbg-detail')" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-2"><i data-lucide="printer" class="w-4 h-4"></i> Download Cetak</button>
                </div>
                <div class="overflow-x-auto">
                    <table id="tabel-mbg-detail" class="w-full text-sm border border-slate-300">
                        <thead class="bg-slate-100">
                            <tr><th class="border p-3 text-left">Kelas</th><th class="border p-3 text-center">Total Siswa</th><th class="border p-3 bg-green-100 text-green-800 text-center">Jatah Makan (Hadir)</th><th class="border p-3 bg-red-100 text-red-800 text-center">Sisa (Tidak Hadir)</th></tr>
                        </thead>
                        <tbody id="tbody-mbg" class="text-slate-700"></tbody>
                        <tfoot class="bg-slate-50 font-bold">
                            <tr><td class="border p-3 text-right">TOTAL KESELURUHAN</td><td class="border p-3 text-center" id="mbg-grand-total">0</td><td class="border p-3 text-center bg-green-50 text-green-700" id="mbg-grand-hadir">0</td><td class="border p-3 text-center bg-red-50 text-red-700" id="mbg-grand-sisa">0</td></tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-kbm" class="hidden space-y-6 fade-in">
            <h2 class="text-3xl font-bold text-white">Monitoring Jurnal Guru (KBM)</h2>
            <div class="bg-slate-900 rounded-2xl border border-slate-800 overflow-hidden">
                <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                    <h3 class="font-bold text-white">Timeline Mengajar Hari Ini</h3>
                    <span id="tgl-kbm" class="text-xs text-slate-400 font-mono">...</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-slate-400 text-sm">
                        <thead class="bg-slate-950 text-xs uppercase font-bold text-slate-500 sticky top-0">
                            <tr>
                                <th class="p-4">Jam</th>
                                <th class="p-4">Guru</th>
                                <th class="p-4">Kelas / Mapel</th>
                                <th class="p-4">Materi</th>
                                <th class="p-4 text-center">Bukti Foto</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-kbm" class="divide-y divide-slate-800">
                            <tr><td colspan="5" class="p-6 text-center italic">Menunggu data jurnal guru...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-mapel" class="hidden space-y-6 fade-in">
            <h2 class="text-3xl font-bold text-white">Database Mata Pelajaran</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-slate-900 p-6 rounded-2xl border border-slate-800">
                    <h3 class="font-bold text-white mb-4">Tambah Mapel</h3>
                    <div class="space-y-4">
                        <input type="text" id="inputNamaMapel" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700" placeholder="Nama Mapel (Cth: Matematika Wajib)">
                        <button onclick="tambahMapel()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg">Simpan</button>
                    </div>
                </div>
                <div class="md:col-span-2 bg-slate-900 p-6 rounded-2xl border border-slate-800">
                    <h3 class="font-bold text-white mb-4">Daftar Mapel Terdaftar</h3>
                    <div class="max-h-96 overflow-y-auto">
                        <ul id="list-mapel" class="space-y-2">
                            <li class="text-center text-slate-500 italic">Memuat...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-menu-manager" class="hidden space-y-6 fade-in">
            <h2 class="text-3xl font-bold text-white">Manajemen Tombol Siswa</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-slate-900 p-6 rounded-2xl border border-slate-800">
                    <h3 class="font-bold text-white mb-4">Tambah Tombol</h3>
                    <div class="space-y-4">
                        <input type="text" id="menuJudul" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700" placeholder="Judul">
                        <input type="text" id="menuIcon" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700" placeholder="Ikon (Emoji)">
                        <input type="text" id="menuLink" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700" placeholder="Link">
                        <div class="flex items-center gap-2"><input type="checkbox" id="menuWarna" class="w-4 h-4"> <label class="text-sm text-slate-300">Highlight</label></div>
                        <button onclick="simpanMenuBaru()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg">Terbitkan</button>
                    </div>
                </div>
                <div class="md:col-span-2 bg-slate-900 p-6 rounded-2xl border border-slate-800">
                    <table class="w-full text-left text-sm text-slate-400">
                        <thead class="bg-slate-950 text-xs uppercase font-bold text-slate-500"><tr><th class="p-3">Ikon</th><th class="p-3">Judul</th><th class="p-3">Link</th><th class="p-3 text-right">Aksi</th></tr></thead>
                        <tbody id="tbody-menu-list" class="divide-y divide-slate-800"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-libur" class="hidden space-y-6 fade-in">
            <h2 class="text-3xl font-bold text-white">Kelola Hari Libur</h2>
            <p class="text-slate-400 text-sm">Siswa tidak akan dianggap Alpa jika tanggal merah sudah didaftarkan disini.</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-slate-900 p-6 rounded-2xl border border-slate-800">
                    <h3 class="font-bold text-white mb-4 flex items-center gap-2">
                        <i data-lucide="plus-circle" class="w-5 h-5 text-red-500"></i> Tambah Libur
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-slate-500 uppercase font-bold">Tanggal</label>
                            <input type="date" id="inputTglLibur" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 mt-1 cursor-pointer">
                        </div>
                        <div>
                            <label class="text-xs text-slate-500 uppercase font-bold">Keterangan</label>
                            <input type="text" id="inputKetLibur" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 mt-1" placeholder="Contoh: HUT RI / Cuti Bersama">
                        </div>
                        <button onclick="simpanLibur()" id="btnSimpanLibur" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded-lg transition">
                            Simpan Tanggal
                        </button>
                    </div>
                </div>
                <div class="md:col-span-2 bg-slate-900 p-6 rounded-2xl border border-slate-800">
                    <h3 class="font-bold text-white mb-4">Daftar Libur Mendatang</h3>
                    <div class="overflow-y-auto max-h-96">
                        <table class="w-full text-left text-sm text-slate-400">
                            <thead class="bg-slate-950 text-xs uppercase font-bold text-slate-500 sticky top-0">
                                <tr><th class="p-3">Tanggal</th><th class="p-3">Keterangan</th><th class="p-3 text-right">Aksi</th></tr>
                            </thead>
                            <tbody id="tbody-libur" class="divide-y divide-slate-800">
                                <tr><td colspan="3" class="p-4 text-center italic">Memuat data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-data" class="hidden space-y-6 fade-in">
            <h2 class="text-3xl font-bold text-white">Import Database</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-slate-900 p-6 rounded-2xl border border-slate-800">
                    <h3 class="font-bold text-white text-lg mb-2">Data Siswa</h3>
                    <input type="file" id="fileSiswa" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mb-4"/>
                    <button onclick="prosesImport('siswa')" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded-lg">Upload Siswa</button>
                </div>
                <div class="bg-slate-900 p-6 rounded-2xl border border-slate-800">
                    <h3 class="font-bold text-white text-lg mb-2">Guru & Tendik</h3>
                    <input type="file" id="fileGuru" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100 mb-4"/>
                    <button onclick="prosesImport('guru')" class="w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-2 rounded-lg">Upload Guru</button>
                </div>
            </div>
            <div class="bg-slate-900 p-4 rounded-xl border border-slate-800 text-xs text-slate-400 font-mono"><div id="log-import" class="h-40 overflow-y-auto"></div></div>
        </div>

        <div id="view-settings" class="hidden space-y-6 fade-in">
            <h2 class="text-3xl font-bold text-white flex items-center gap-3">
                <i data-lucide="satellite" class="w-8 h-8 text-blue-500"></i> Remote GPS Control
            </h2>
            <div class="bg-slate-900 rounded-[2rem] border border-slate-800 p-8 shadow-2xl relative overflow-hidden">
                <div class="absolute -top-10 -right-10 w-40 h-40 bg-blue-600 rounded-full blur-[80px] opacity-20"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                    <div>
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h3 class="font-bold text-white text-lg">Mode Disiplin GPS</h3>
                                <p class="text-xs text-slate-400 mt-1">Jika ON, siswa wajib dalam radius sekolah.</p>
                            </div>
                            <div class="relative inline-block w-14 align-middle select-none">
                                <input type="checkbox" id="toggleGPS" class="toggle-checkbox absolute block w-8 h-8 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-600 transition-all duration-300" onchange="updateLabelStatus()"/>
                                <label for="toggleGPS" class="toggle-label block overflow-hidden h-8 rounded-full bg-slate-700 cursor-pointer"></label>
                            </div>
                        </div>
                        <div id="statusGPSBadge" class="inline-block px-4 py-2 rounded-lg text-xs font-black uppercase tracking-widest bg-slate-800 text-slate-500">
                            Menunggu Data...
                        </div>
                    </div>
                    <div class="bg-slate-950/50 p-6 rounded-2xl border border-slate-800">
                        <h4 class="font-bold text-white text-sm mb-4 flex items-center gap-2"><i data-lucide="map-pin" class="w-4 h-4 text-orange-500"></i> Titik Koordinat Sekolah</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] text-slate-500 uppercase font-bold mb-1">Latitude</label>
                                <input type="text" id="inputLat" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-white text-xs font-mono" placeholder="-7.xxxxx">
                            </div>
                            <div>
                                <label class="block text-[10px] text-slate-500 uppercase font-bold mb-1">Longitude</label>
                                <input type="text" id="inputLng" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2 text-white text-xs font-mono" placeholder="110.xxxxx">
                            </div>
                        </div>
                    </div>
                </div>
                <hr class="border-slate-800 my-8">
                <div>
                    <div class="flex justify-between items-end mb-4">
                        <label class="font-bold text-white text-sm">Jarak Toleransi (Radius)</label>
                        <span id="labelRadius" class="text-3xl font-black text-blue-500">50 Meter</span>
                    </div>
                    <input type="range" id="inputRadius" min="10" max="1000" step="10" class="w-full h-3 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-blue-600 hover:accent-blue-400" oninput="updateLabelRadius()">
                    <div class="flex justify-between text-[10px] text-slate-500 font-bold uppercase mt-2">
                        <span>10 Meter (Ketad)</span>
                        <span>1000 Meter (Longgar)</span>
                    </div>
                </div>
                <button onclick="simpanConfig()" id="btnSaveConfig" class="mt-8 w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-500/20 active:scale-95 transition flex items-center justify-center gap-2">
                    <i data-lucide="save" class="w-5 h-5"></i> SIMPAN PENGATURAN
                </button>
            </div>
        </div>

    </main>

    <div id="modal-kelas" class="modal fixed inset-0 z-50 flex items-center justify-center bg-slate-900/80 backdrop-blur-sm">
        <div class="modal-content bg-slate-800 w-full max-w-4xl rounded-2xl border border-slate-700 shadow-2xl p-6 relative flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-white" id="judul-modal-kelas">...</h3>
                <button onclick="tutupModalKelas()" class="text-slate-400 hover:text-white p-2 bg-slate-700/50 rounded-full"><i data-lucide="x"></i></button>
            </div>
            <div class="overflow-y-auto flex-1 border border-slate-700 rounded-xl">
                <table class="w-full text-left text-slate-300">
                    <thead class="bg-slate-900 text-xs uppercase font-bold sticky top-0 text-slate-400">
                        <tr>
                            <th class="p-3 w-10 text-center">No</th>
                            <th class="p-3">Siswa</th>
                            <th class="p-3">Absen</th>
                            <th class="p-3">Kontak</th>
                            <th class="p-3 text-right">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-modal-kelas" class="divide-y divide-slate-700 bg-slate-800"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="loading" class="fixed inset-0 bg-slate-900 flex flex-col items-center justify-center z-50 text-white">
        <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="font-bold animate-pulse">Memuat Database...</p>
    </div>

    <<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, getDoc, onSnapshot, doc, setDoc, addDoc, deleteDoc, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXWR-_aJyoMrUjTeNQYlcPD8p3eu58yOo",
            authDomain: "siganteng-absensi.firebaseapp.com",
            databaseURL: "https://siganteng-absensi-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "siganteng-absensi",
            storageBucket: "siganteng-absensi.firebasestorage.app",
            messagingSenderId: "917873420012",
            appId: "1:917873420012:web:0fe1a9eddc5f94959ba7c9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- GLOBAL VARIABLES ---
        let listSiswa = []; 
        let mapKelas = {}; 
        let cacheAbsenHariIni = {}; 
        let mapProfilSiswa = {}; 
        let cacheHariLibur = {}; // <-- TEMPAT NYIMPEN DAFTAR TANGGAL MERAH

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            const role = localStorage.getItem('admin_role');
            document.getElementById('badge-role').innerText = role === 'SUPER' ? 'SUPER ADMIN' : 'GURU BK / PIKET';
            if(role === 'SUPER') document.getElementById('menu-super').classList.remove('hidden');

            setupDropdown();
            
            // Load Data Awal
            await Promise.all([tarikDataSiswa(), tarikDataProfilLengkap()]);
            
            // Listeners Realtime
            pantauRealtime();
            loadMenuManager(); 
            loadHariLibur(); // <-- Ini sekaligus ngisi cacheHariLibur
            loadMapel(); 
            pantauKBM(); 
            
            if(role === 'SUPER') loadSettings();
            
            document.getElementById('loading').style.display = 'none';
        });

        // --- 1. CORE DATA SISWA ---
        async function tarikDataSiswa() {
            try {
                const q = query(collection(db, "users"), where("role", "!=", "guru"));
                const snap = await getDocs(q);
                listSiswa = []; mapKelas = {}; const kelasSet = new Set();
                snap.forEach(doc => {
                    const s = doc.data();
                    if(s.kelas && s.kelas !== '-' && s.role !== 'guru') {
                        const nisn = String(s.username).replace(/[^a-zA-Z0-9]/g, '');
                        const kls = String(s.kelas).trim().toUpperCase();
                        listSiswa.push({ ...s, nisn, kelas: kls });
                        if(!mapKelas[kls]) mapKelas[kls] = [];
                        mapKelas[kls].push({ ...s, nisn });
                        kelasSet.add(kls);
                    }
                });
                const sel = document.getElementById('pilih-kelas');
                Array.from(kelasSet).sort().forEach(k => sel.add(new Option(k, k)));
                document.getElementById('stat-total').innerText = listSiswa.length;
            } catch (e) { console.log("Error tarik siswa:", e); }
        }

        async function tarikDataProfilLengkap() {
            try {
                const snap = await getDocs(collection(db, "siswa"));
                mapProfilSiswa = {};
                snap.forEach(doc => { mapProfilSiswa[doc.id] = doc.data(); });
            } catch (e) { console.log("Gagal tarik profil:", e); }
        }

        // --- 2. MONITORING REALTIME ---
        function pantauRealtime() {
            const todayStr = new Date().toLocaleDateString('fr-CA');
            const q = query(collection(db, "absensi"), where("tanggal", "==", todayStr));
            onSnapshot(q, (snap) => {
                cacheAbsenHariIni = {}; let hadir = 0, izin = 0;
                const tabel = document.getElementById('tabel-live'); tabel.innerHTML = "";
                snap.forEach(doc => {
                    const data = doc.data();
                    const nisn = String(data.nisn).replace(/[^a-zA-Z0-9]/g, '');
                    cacheAbsenHariIni[nisn] = data;
                    const st = data.status_terakhir;
                    if(st.includes("Masuk") || st.includes("Hadir") || st.includes("Pulang") || st.includes("Kembali")) hadir++;
                    else if(st.includes("Sakit") || st.includes("Izin")) izin++;
                    
                    tabel.innerHTML += `<tr class="border-b border-slate-800 hover:bg-slate-800/50"><td class="p-4 text-blue-400 font-mono">${data.riwayat_kegiatan ? data.riwayat_kegiatan[data.riwayat_kegiatan.length-1].split(' - ')[0] : '-'}</td><td class="p-4 text-white font-bold">${data.nama}</td><td class="p-4">${data.kelas}</td><td class="p-4"><span class="bg-slate-700 px-2 py-1 rounded text-xs text-white">${st}</span></td><td class="p-4 text-xs">${data.lokasi_masuk?.includes("Kiosk") ? "üè¢ Kiosk" : "üì± HP"}</td></tr>`;
                });
                document.getElementById('stat-hadir').innerText = hadir;
                document.getElementById('stat-izin').innerText = izin;
                document.getElementById('stat-alpha').innerText = listSiswa.length - (hadir + izin);
                renderGridKelas();
                ['X', 'XI', 'XII'].forEach(t => hitungMBG(t));
            });
        }

        // --- 3. REKAP ABSEN (FIXED LOGIC HARI LIBUR) ---
        window.loadRekap = async () => {
            const bln = parseInt(document.getElementById('pilih-bulan').value) + 1; 
            const thn = document.getElementById('pilih-tahun').value;
            const kls = document.getElementById('pilih-kelas').value;
            if(!kls) return Swal.fire('Pilih Kelas', 'Silakan pilih kelas dulu.', 'warning');

            const blnStr = bln < 10 ? '0' + bln : bln;
            const daysInMonth = new Date(thn, bln, 0).getDate();
            
            // Header Tabel
            let headerHTML = '<tr><th class="p-2 border border-slate-700 w-10">No</th><th class="p-2 border border-slate-700 min-w-[200px] text-left">Nama Siswa</th><th class="p-2 border border-slate-700">NISN</th>';
            for(let d=1; d<=daysInMonth; d++) {
                // Cek Libur Nasional di Header (Opsional, kasih warna beda dikit)
                const cekTgl = `${thn}-${blnStr}-${d < 10 ? '0'+d : d}`;
                const isMerah = cacheHariLibur[cekTgl];
                
                const dayOfWeek = new Date(thn, bln-1, d).getDay();
                let bgHead = (dayOfWeek === 0 || dayOfWeek === 6 || isMerah) ? 'bg-red-900/50 text-red-200' : 'bg-slate-900';
                
                headerHTML += `<th class="p-2 border border-slate-700 ${bgHead} w-8 text-center" title="${isMerah || ''}">${d}</th>`;
            }
            headerHTML += '<th class="p-2 border border-slate-700 bg-emerald-900">H</th><th class="p-2 border border-slate-700 bg-blue-900">S</th><th class="p-2 border border-slate-700 bg-yellow-900">I</th><th class="p-2 border border-slate-700 bg-red-900">A</th></tr>';
            document.getElementById('thead-rekap').innerHTML = headerHTML;

            const tbody = document.getElementById('tbody-rekap'); 
            tbody.innerHTML = '<tr><td colspan="40" class="p-4 text-center">Mengambil data absensi...</td></tr>';

            // Tarik Data
            const start = `${thn}-${blnStr}-01`;
            const end = `${thn}-${blnStr}-${daysInMonth}`;
            const q = query(collection(db, "absensi"), where("tanggal", ">=", start), where("tanggal", "<=", end));
            const snap = await getDocs(q);
            
            let dataMap = {}; 
            if(mapKelas[kls]) {
                mapKelas[kls].forEach(s => {
                    dataMap[s.nisn] = { nama: s.nama, att: {}, counts: {h:0, s:0, i:0, a:0} };
                });
            }

            snap.forEach(doc => {
                const d = doc.data();
                const nisn = String(d.nisn).replace(/[^a-zA-Z0-9]/g, '');
                if(dataMap[nisn]) {
                    const tgl = parseInt(d.tanggal.split('-')[2]); 
                    const st = d.status_terakhir;
                    let code = 'A';
                    if(st.includes("Masuk") || st.includes("Hadir") || st.includes("Pulang") || st.includes("Kembali")) { code = 'H'; dataMap[nisn].counts.h++; }
                    else if(st.includes("Sakit")) { code = 'S'; dataMap[nisn].counts.s++; }
                    else if(st.includes("Izin")) { code = 'I'; dataMap[nisn].counts.i++; }
                    dataMap[nisn].att[tgl] = code; // Simpan status H/S/I
                }
            });

            tbody.innerHTML = '';
            if(Object.keys(dataMap).length === 0) { tbody.innerHTML = '<tr><td colspan="40" class="p-4 text-center">Tidak ada siswa.</td></tr>'; return; }

            // Render Baris Siswa
            Object.keys(dataMap).sort((a,b) => dataMap[a].nama.localeCompare(dataMap[b].nama)).forEach((nisn, idx) => {
                const r = dataMap[nisn];
                let rowHTML = `<tr class="hover:bg-slate-800 border-b border-slate-800"><td class="p-2 border border-slate-700 text-center">${idx+1}</td><td class="p-2 border border-slate-700 text-left font-bold text-slate-300">${r.nama}</td><td class="p-2 border border-slate-700 text-center font-mono text-xs">${nisn}</td>`;
                let totalAlpha = 0;
                
                for(let d=1; d<=daysInMonth; d++) {
                    const dateStr = `${thn}-${blnStr}-${d < 10 ? '0'+d : d}`; // Format YYYY-MM-DD
                    const dayOfWeek = new Date(thn, bln-1, d).getDay();
                    const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
                    const isLiburNasional = cacheHariLibur[dateStr]; // Cek di Daftar Libur
                    
                    const status = r.att[d]; // Status Absen (H/S/I)
                    let cellClass = ""; let cellText = "";

                    if (status) {
                        // Kalau ada data absen (H/S/I), prioritaskan tampilkan
                        if (status === 'H') { cellClass = "bg-hadir"; cellText = "‚Ä¢"; }
                        else if (status === 'S') { cellClass = "bg-sakit"; cellText = "S"; }
                        else if (status === 'I') { cellClass = "bg-izin"; cellText = "I"; }
                    } else {
                        // Kalau TIDAK ada data absen (Kosong)
                        if (isLiburNasional) {
                            // Cek Libur Nasional Dulu
                            cellClass = "bg-red-900/40 text-red-500 font-bold"; 
                            cellText = "L"; // Libur
                        } else if (isWeekend) {
                            // Baru Cek Weekend
                            cellClass = "bg-weekend"; 
                            cellText = "";
                        } else {
                            // Kalau Hari Biasa & Gak Libur -> Cek Tanggal
                            const cellDate = new Date(thn, bln-1, d);
                            if(cellDate < new Date()) { 
                                // Tanggal sudah lewat -> ALPHA
                                totalAlpha++; 
                                cellClass = "bg-alpha"; 
                                cellText = "A"; 
                            } else {
                                // Tanggal belum lewat -> Strip
                                cellText = "-";
                            }
                        }
                    }
                    rowHTML += `<td class="p-2 border border-slate-700 text-center ${cellClass}" title="${isLiburNasional || ''}">${cellText}</td>`;
                }
                rowHTML += `<td class="p-2 border border-slate-700 font-bold text-emerald-400">${r.counts.h}</td><td class="p-2 border border-slate-700 font-bold text-blue-400">${r.counts.s}</td><td class="p-2 border border-slate-700 font-bold text-yellow-400">${r.counts.i}</td><td class="p-2 border border-slate-700 font-bold text-red-400">${totalAlpha}</td></tr>`;
                tbody.innerHTML += rowHTML;
            });
        }

        // --- 4. HARI LIBUR & CACHE ---
        function loadHariLibur() {
            const q = query(collection(db, "hari_libur"), orderBy("tanggal", "asc"));
            onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('tbody-libur'); 
                tbody.innerHTML = '';
                cacheHariLibur = {}; // Reset Cache

                if(snapshot.empty) { tbody.innerHTML = '<tr><td colspan="3" class="p-4 text-center italic">Tidak ada jadwal libur.</td></tr>'; return; }
                
                snapshot.forEach(doc => {
                    const d = doc.data();
                    // Simpan ke Cache Global { '2025-12-25': 'Natal' }
                    cacheHariLibur[d.tanggal] = d.keterangan;

                    const tglIndo = d.tanggal.split('-').reverse().join('-');
                    const badge = new Date(d.tanggal) < new Date() ? '<span class="text-xs bg-slate-800 px-2 py-1 rounded text-slate-500">Lewat</span>' : '<span class="text-xs bg-blue-900 px-2 py-1 rounded text-blue-300">Aktif</span>';
                    
                    tbody.innerHTML += `
                        <tr class="hover:bg-slate-800 border-b border-slate-800">
                            <td class="p-3 font-mono text-white">${tglIndo} ${badge}</td>
                            <td class="p-3 text-slate-300 font-bold">${d.keterangan}</td>
                            <td class="p-3 text-right">
                                <button onclick="hapusLibur('${doc.id}')" class="bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white p-2 rounded transition">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </td>
                        </tr>`;
                });
                lucide.createIcons();
            });
        }

        window.simpanLibur = async () => {
            const tgl = document.getElementById('inputTglLibur').value;
            const ket = document.getElementById('inputKetLibur').value;
            if(!tgl || !ket) return Swal.fire('Gagal', 'Lengkapi data!', 'warning');
            try { 
                await addDoc(collection(db, "hari_libur"), { tanggal: tgl, keterangan: ket, dibuat_pada: new Date().toISOString() }); 
                Swal.fire('Sukses', 'Jadwal ditambahkan.', 'success'); 
                document.getElementById('inputTglLibur').value = ''; 
                document.getElementById('inputKetLibur').value = ''; 
            } catch(e) { Swal.fire('Error', e.message, 'error'); } 
        }
        window.hapusLibur = async (id) => Swal.fire({ title: 'Hapus?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', background: '#1e293b', color:'#fff' }).then(async (r) => { if(r.isConfirmed) await deleteDoc(doc(db, "hari_libur", id)); });

        // --- 5. KELOLA MAPEL (FIXED) ---
        function loadMapel() {
            const q = query(collection(db, "mata_pelajaran"), orderBy("nama", "asc"));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('list-mapel'); 
                list.innerHTML = '';
                if(snapshot.empty) { list.innerHTML = '<li class="text-center text-slate-500 italic">Belum ada mapel.</li>'; return; }
                
                snapshot.forEach(doc => {
                    list.innerHTML += `
                        <li class="flex justify-between items-center bg-slate-800 p-3 rounded-lg border border-slate-700">
                            <span class="text-white font-bold">${doc.data().nama}</span>
                            <button onclick="hapusMapel('${doc.id}')" class="text-red-500 hover:text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </li>`;
                });
                lucide.createIcons();
            });
        }

        // FUNGSI INI SEKARANG EXPORT KE WINDOW BIAR BISA DIPANGGIL HTML
        window.tambahMapel = async () => {
            const nama = document.getElementById('inputNamaMapel').value;
            if(!nama) return Swal.fire('Eits', 'Nama mapel wajib diisi.', 'warning');
            try { 
                await addDoc(collection(db, "mata_pelajaran"), { nama: nama }); 
                document.getElementById('inputNamaMapel').value = ''; 
                Swal.fire('Sip', 'Mapel ditambahkan', 'success'); 
            } catch(e) { 
                console.error(e); // Debug
                Swal.fire('Error', 'Gagal simpan mapel: ' + e.message, 'error'); 
            }
        }
        
        window.hapusMapel = async (id) => Swal.fire({title:'Hapus Mapel?', showCancelButton:true, confirmButtonColor:'#d33', background: '#1e293b', color:'#fff'}).then(async(r)=>{ if(r.isConfirmed) await deleteDoc(doc(db,"mata_pelajaran",id)); });

        // --- 6. UTILS LAINNYA ---
        function pantauKBM() {
            const todayStr = new Date().toLocaleDateString('fr-CA');
            document.getElementById('tgl-kbm').innerText = todayStr;
            const q = query(collection(db, "jurnal_guru"), where("tanggal", "==", todayStr));
            onSnapshot(q, (snap) => {
                const tbody = document.getElementById('tbody-kbm'); tbody.innerHTML = '';
                if(snap.empty) { tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center italic text-slate-500">Belum ada jurnal masuk hari ini.</td></tr>'; return; }
                snap.forEach(doc => {
                    const d = doc.data();
                    const fotoHtml = d.foto_bukti ? `<img src="${d.foto_bukti}" class="h-10 w-10 rounded object-cover cursor-pointer border border-slate-600 mx-auto" onclick="Swal.fire({imageUrl: '${d.foto_bukti}', showConfirmButton: false, background: 'transparent'})">` : '<span class="text-xs text-slate-600">-</span>';
                    tbody.innerHTML += `<tr class="hover:bg-slate-800 border-b border-slate-800"><td class="p-4 font-mono text-blue-400">${d.jam_lapor || '-'}</td><td class="p-4 font-bold text-white">${d.nama_guru}</td><td class="p-4"><div class="text-emerald-400 font-bold">${d.kelas}</div><div class="text-xs text-slate-500">${d.mapel}</div></td><td class="p-4 text-sm text-slate-300">${d.materi}</td><td class="p-4 text-center">${fotoHtml}</td></tr>`;
                });
            });
        }

        // --- GRID KELAS & MODAL ---
        function renderGridKelas() {
            const container = document.getElementById('grid-kelas-container'); container.innerHTML = '';
            Object.keys(mapKelas).sort().forEach(kls => {
                let hadir = 0; const total = mapKelas[kls].length;
                mapKelas[kls].forEach(s => { if(cacheAbsenHariIni[s.nisn]) hadir++; });
                const pct = total > 0 ? (hadir/total)*100 : 0;
                let color = pct === 100 ? 'border-emerald-500 text-emerald-400' : (pct >= 50 ? 'border-blue-500 text-blue-400' : 'border-red-500 text-red-400');
                container.innerHTML += `<div onclick="bukaDetailKelas('${kls}')" class="bg-slate-900 border ${color.split(' ')[0]} p-4 rounded-xl cursor-pointer hover:bg-slate-800 transition shadow-lg"><div class="flex justify-between items-start mb-2"><h4 class="font-bold text-white text-sm">${kls}</h4><span class="text-xs font-mono bg-slate-950 px-2 py-1 rounded text-slate-300">${total}</span></div><div class="text-2xl font-black ${color.split(' ')[1]}">${hadir}</div><p class="text-[10px] text-slate-500 uppercase font-bold">Data Masuk</p></div>`;
            });
        }

        window.bukaDetailKelas = (kls) => {
            const tbody = document.getElementById('tbody-modal-kelas'); document.getElementById('judul-modal-kelas').innerText = `Data Kelas ${kls}`; tbody.innerHTML = '';
            mapKelas[kls].sort((a,b)=>a.nama.localeCompare(b.nama)).forEach((s, idx) => {
                const data = cacheAbsenHariIni[s.nisn]; const profil = mapProfilSiswa[s.nisn] || {}; 
                const status = data ? `<span class="bg-emerald-900 text-emerald-400 px-2 py-1 rounded text-xs font-bold">${data.status_terakhir}</span>` : `<span class="bg-red-900 text-red-400 px-2 py-1 rounded text-xs font-bold">Alpha</span>`;
                const fotoSrc = profil.foto_profil || `https://ui-avatars.com/api/?name=${s.nama}&background=random`;
                let btnWA = `<span class="text-slate-600 text-xs">-</span>`;
                if (profil.wa_siswa || profil.wa_ortu) {
                    btnWA = `<div class="flex gap-1">`;
                    if(profil.wa_siswa) btnWA += `<a href="https://wa.me/${profil.wa_siswa}" target="_blank" class="bg-green-600 hover:bg-green-500 text-white p-1.5 rounded transition"><i data-lucide="message-circle" class="w-3 h-3"></i></a>`;
                    if(profil.wa_ortu) btnWA += `<a href="https://wa.me/${profil.wa_ortu}" target="_blank" class="bg-blue-600 hover:bg-blue-500 text-white p-1.5 rounded transition"><i data-lucide="user-check" class="w-3 h-3"></i></a>`;
                    btnWA += `</div>`;
                }
                const btnReset = `<button onclick="resetPassword('${s.username}', '${s.nama}')" class="text-xs bg-slate-700 hover:bg-red-600 text-slate-300 hover:text-white px-2 py-1 rounded border border-slate-600 transition">Reset</button>`;
                tbody.innerHTML += `<tr class="hover:bg-slate-700/50 border-b border-slate-700 last:border-0 transition"><td class="p-3 text-slate-500 text-center">${idx+1}</td><td class="p-3"><div class="flex items-center gap-3"><img src="${fotoSrc}" class="w-8 h-8 rounded-full object-cover border border-slate-600 cursor-pointer" onclick="Swal.fire({imageUrl: '${fotoSrc}', showConfirmButton: false, background: 'transparent'})"><div><div class="font-bold text-white text-sm">${s.nama}</div><div class="font-mono text-slate-500 text-[10px]">${s.nisn}</div></div></div></td><td class="p-3">${status}</td><td class="p-3">${btnWA}</td><td class="p-3 text-right">${btnReset}</td></tr>`;
            });
            document.getElementById('modal-kelas').classList.add('active'); lucide.createIcons();
        }
        window.tutupModalKelas = () => document.getElementById('modal-kelas').classList.remove('active');
        window.resetPassword = async (nisn, nama) => {
            const tanya = await Swal.fire({ title: 'Reset Password?', text: `Password ${nama} akan kembali menjadi NISN (${nisn}).`, icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya', background: '#1e293b', color: '#fff' });
            if (tanya.isConfirmed) { try { await setDoc(doc(db, "users", nisn), { password: nisn }, { merge: true }); Swal.fire({title: 'Tereset!', icon: 'success', background: '#1e293b', color: '#fff', timer: 1500, showConfirmButton: false}); } catch(e) { Swal.fire('Gagal', e.message, 'error'); } }
        }

        // --- MBG & SETTINGS ---
        function cekTingkat(namaKelas, tingkatTarget) { const k = namaKelas.toUpperCase().trim(); if (tingkatTarget === 'XII') return k.startsWith('XII') || k.startsWith('12'); if (tingkatTarget === 'XI') return (k.startsWith('XI') || k.startsWith('11')) && !k.startsWith('XII'); if (tingkatTarget === 'X') return (k.startsWith('X') || k.startsWith('10')) && !k.startsWith('XI') && !k.startsWith('XII'); return false; }
        function hitungMBG(tingkat) { let tot=0, had=0; for(const kls in mapKelas) { if(cekTingkat(kls, tingkat)) { mapKelas[kls].forEach(s => { tot++; if(cacheAbsenHariIni[s.nisn]) { const st = cacheAbsenHariIni[s.nisn].status_terakhir; if(st.includes("Masuk") || st.includes("Hadir") || st.includes("Pulang")) had++; } }); } } const elHadir = document.getElementById(`mbg-${tingkat.toLowerCase()}-hadir`); const elSisa = document.getElementById(`mbg-${tingkat.toLowerCase()}-sisa`); if(elHadir) elHadir.innerText = had; if(elSisa) elSisa.innerText = tot - had; }
        window.previewMBG = (tingkat) => { if(Object.keys(mapKelas).length === 0) { Swal.fire('Data Belum Siap', 'Tunggu sebentar...', 'info'); return; } document.getElementById('container-tabel-mbg').classList.remove('hidden'); document.getElementById('judul-tabel-mbg').innerText = `Laporan Logistik Kelas ${tingkat}`; const tbody = document.getElementById('tbody-mbg'); tbody.innerHTML = ''; let grandTotal = 0; let grandHadir = 0; let grandSisa = 0; Object.keys(mapKelas).sort().forEach(kls => { if (cekTingkat(kls, tingkat)) { let totalSiswa = mapKelas[kls].length; let hadirCount = 0; mapKelas[kls].forEach(s => { if (cacheAbsenHariIni[s.nisn]) { const st = cacheAbsenHariIni[s.nisn].status_terakhir; if(st.includes("Masuk") || st.includes("Hadir") || st.includes("Pulang")) hadirCount++; } }); let sisaCount = totalSiswa - hadirCount; grandTotal += totalSiswa; grandHadir += hadirCount; grandSisa += sisaCount; tbody.innerHTML += `<tr class="border-b hover:bg-slate-50"><td class="border p-2 font-bold">${kls}</td><td class="border p-2 text-center">${totalSiswa}</td><td class="border p-2 text-center font-bold text-green-600 bg-green-50">${hadirCount}</td><td class="border p-2 text-center font-bold text-red-600 bg-red-50">${sisaCount}</td></tr>`; } }); document.getElementById('mbg-grand-total').innerText = grandTotal; document.getElementById('mbg-grand-hadir').innerText = grandHadir; document.getElementById('mbg-grand-sisa').innerText = grandSisa; }

        async function loadSettings() { onSnapshot(doc(db, "pengaturan", "sekolah"), (docSnap) => { if (docSnap.exists()) { const d = docSnap.data(); document.getElementById('toggleGPS').checked = d.validasi_gps_aktif; document.getElementById('inputLat').value = d.lokasi_lat || "-7.6739830"; document.getElementById('inputLng').value = d.lokasi_lng || "109.6319560"; document.getElementById('inputRadius').value = d.radius_meter || 50; updateLabelRadius(); updateLabelStatus(); } }); }
        window.simpanConfig = async () => { const btn = document.getElementById('btnSaveConfig'); btn.innerHTML = `<i class="animate-spin" data-lucide="loader-2"></i> Menyimpan...`; lucide.createIcons(); try { await setDoc(doc(db, "pengaturan", "sekolah"), { lokasi_lat: parseFloat(document.getElementById('inputLat').value), lokasi_lng: parseFloat(document.getElementById('inputLng').value), radius_meter: parseInt(document.getElementById('inputRadius').value), validasi_gps_aktif: document.getElementById('toggleGPS').checked }, { merge: true }); Swal.fire({title: 'Berhasil!', icon: 'success', background: '#1e293b', color: '#fff'}); } catch(e) { Swal.fire('Error', e.message, 'error'); } finally { btn.innerHTML = `<i data-lucide="save"></i> SIMPAN PENGATURAN`; lucide.createIcons(); } }

        window.simpanMenuBaru = async () => { const judul = document.getElementById('menuJudul').value; const icon = document.getElementById('menuIcon').value || "üîó"; const link = document.getElementById('menuLink').value; const isHighlight = document.getElementById('menuWarna').checked; if(!judul || !link) return Swal.fire('Error', 'Lengkapi data.', 'warning'); await addDoc(collection(db, "menu_siswa"), { judul, icon, link, highlight: isHighlight, created_at: new Date().toISOString() }); Swal.fire('Sukses', 'Menu tersimpan.', 'success'); document.getElementById('menuJudul').value = ''; document.getElementById('menuLink').value = ''; }
        function loadMenuManager() { onSnapshot(query(collection(db, "menu_siswa"), orderBy("created_at", "asc")), (snap) => { const tb = document.getElementById('tbody-menu-list'); tb.innerHTML = ''; if(snapshot.empty) { tb.innerHTML = '<tr><td colspan="4" class="p-4 text-center italic">Belum ada tombol.</td></tr>'; return; } snap.forEach(d => tb.innerHTML += `<tr class="hover:bg-slate-800"><td class="p-3 text-2xl">${d.data().icon}</td><td class="p-3 text-white">${d.data().judul}</td><td class="p-3 text-xs font-mono">${d.data().link}</td><td class="p-3 text-right"><button onclick="hapusMenu('${d.id}')" class="text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`); lucide.createIcons(); }); }
        window.hapusMenu = async(id) => Swal.fire({title:'Hapus?', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33'}).then(async(r)=>{ if(r.isConfirmed) await deleteDoc(doc(db,"menu_siswa",id)); });

        window.prosesImport = async (tipe) => { const file = document.getElementById(tipe === 'siswa' ? 'fileSiswa' : 'fileGuru').files[0]; if(!file) return Swal.fire('Error', 'Pilih file excel.', 'error'); const reader = new FileReader(); reader.onload = async (e) => { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'}); const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1}); document.getElementById('loading').style.display = 'flex'; let sukses = 0; for(let i=1; i<jsonData.length; i++) { const row = jsonData[i]; if(!row[0]) continue; try { let username = String(row[1]).trim().replace(/[^a-zA-Z0-9]/g, ''); let userData = tipe === 'siswa' ? { nama: row[0], username, password: String(row[2] || "123456"), kelas: String(row[3] || "-").toUpperCase(), role: 'siswa' } : { nama: row[0], username, password: String(row[2] || "123456"), role: String(row[3] || 'guru').toLowerCase(), wali_kelas: String(row[4] || "-").toUpperCase() }; await setDoc(doc(db, "users", username), userData, {merge: true}); sukses++; } catch(err) {} } document.getElementById('loading').style.display = 'none'; Swal.fire('Selesai', `Berhasil import ${sukses} data.`, 'success'); if(tipe === 'siswa') tarikDataSiswa(); }; reader.readAsArrayBuffer(file); }

        window.nav = (v) => { document.querySelectorAll('[id^="view-"]').forEach(e => e.classList.add('hidden')); document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active')); document.getElementById('view-'+v).classList.remove('hidden'); document.getElementById('nav-'+v).classList.add('active'); }
        function setupDropdown() { const today = new Date(); const blnNames = ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agt","Sep","Okt","Nov","Des"]; const selBulan = document.getElementById('pilih-bulan'); blnNames.forEach((b, i) => { let opt = new Option(b, i); if(i===today.getMonth()) opt.selected=true; selBulan.add(opt); }); const selTahun = document.getElementById('pilih-tahun'); for(let y=today.getFullYear()-1; y<=today.getFullYear()+1; y++) selTahun.add(new Option(y, y)); }
        window.downloadExcel = (id) => { const table = document.getElementById(id); let html = table.outerHTML.replace(/<table/g, '<table border="1"'); const link = document.createElement("a"); link.href = 'data:application/vnd.ms-excel;charset=utf-8,' + encodeURIComponent(html); link.download = `REKAP_${new Date().getTime()}.xls`; link.click(); }
        window.logout = () => { localStorage.clear(); window.location.href='login_admin.html'; }
        window.updateLabelRadius = () => document.getElementById('labelRadius').innerText = document.getElementById('inputRadius').value + " Meter";
        window.updateLabelStatus = () => { const isOkn = document.getElementById('toggleGPS').checked; const badge = document.getElementById('statusGPSBadge'); badge.innerText = isOkn ? "MODE DISIPLIN: AKTIF" : "MODE DARURAT (BEBAS)"; badge.className = isOkn ? "inline-block px-4 py-2 rounded-lg text-xs font-black uppercase tracking-widest bg-emerald-500/20 text-emerald-400 border border-emerald-500/50" : "inline-block px-4 py-2 rounded-lg text-xs font-black uppercase tracking-widest bg-red-500/20 text-red-400 border border-red-500/50"; }
        setInterval(() => { document.getElementById('jam-real').innerText = new Date().toLocaleTimeString('id-ID'); }, 1000);
        
        // --- GLOBAL EXPORT ---
        // (Biar fungsi bisa dipanggil onclick di HTML)
        window.updateLabelRadius = updateLabelRadius; 
        window.updateLabelStatus = updateLabelStatus; 
        window.simpanConfig = simpanConfig; 
        window.bukaDetailKelas = bukaDetailKelas; 
        window.tutupModalKelas = tutupModalKelas; 
        window.hapusMenu = hapusMenu; 
        window.hapusLibur = hapusLibur; 
        window.previewMBG = previewMBG; 
        window.simpanMenuBaru = simpanMenuBaru; 
        window.simpanLibur = simpanLibur; 
        window.prosesImport = prosesImport; 
        window.loadRekap = loadRekap; 
        window.nav = nav; 
        window.logout = logout; 
        window.downloadExcel = downloadExcel; 
        window.resetPassword = resetPassword; 
        window.tambahMapel = tambahMapel; 
        window.hapusMapel = hapusMapel;
    </script>
</body>
</html>
