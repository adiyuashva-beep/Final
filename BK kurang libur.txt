<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Kesiswaan (BK) - SiGanteng</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .nav-item.active { background: rgba(16, 185, 129, 0.1); border-right: 3px solid #10b981; color: #34d399; }
        
        /* Table Sticky Header & Column */
        .table-sticky th { position: sticky; top: 0; z-index: 30; background: #1e293b; }
        .table-sticky td:first-child, .table-sticky th:first-child { position: sticky; left: 0; z-index: 40; background: #1e293b; border-right: 1px solid #334155; }
        .table-sticky td:nth-child(2), .table-sticky th:nth-child(2) { position: sticky; left: 40px; z-index: 40; background: #1e293b; border-right: 1px solid #334155; }

        .bg-weekend { background-color: #334155; color: #475569; }
        .bg-hadir { background-color: #064e3b; color: #a7f3d0; font-size: 0.75rem; vertical-align: middle; }
        .bg-dispen { background-color: #581c87; color: #e9d5ff; font-weight: bold; vertical-align: middle; }
        .bg-sakit { background-color: #1e3a8a; color: #bfdbfe; font-weight: bold; vertical-align: middle; }
        .bg-izin { background-color: #713f12; color: #fef08a; font-weight: bold; vertical-align: middle; }
        .bg-alpha { background-color: #7f1d1d; color: #fca5a5; font-weight: bold; vertical-align: middle; }

        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-sm">

    <aside class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col hidden md:flex">
        <div class="p-6">
            <h1 class="font-black text-2xl tracking-tighter text-emerald-500">SiGanteng</h1>
            <p class="text-xs text-slate-500 tracking-widest uppercase mt-1">Panel Kesiswaan (BK)</p>
        </div>

        <nav class="flex-1 space-y-1 px-3 mt-4 overflow-y-auto hide-scroll">
            <button onclick="nav('dashboard')" id="nav-dashboard" class="nav-item active w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard Harian
            </button>
            <button onclick="nav('rekap')" id="nav-rekap" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition">
                <i data-lucide="calendar-days" class="w-5 h-5"></i> Rekap Absensi Detail
            </button>
            <button onclick="nav('dispen')" id="nav-dispen" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition">
                <i data-lucide="file-check-2" class="w-5 h-5"></i> Kelola Dispensasi (D)
            </button>
            <button onclick="nav('mbg')" id="nav-mbg" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition">
                <i data-lucide="utensils" class="w-5 h-5"></i> Laporan MBG
            </button>
        </nav>

        <div class="p-4 border-t border-slate-800">
            <button onclick="logout()" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-500/10 text-red-500 rounded-lg hover:bg-red-500 hover:text-white transition font-bold">
                <i data-lucide="log-out" class="w-4 h-4"></i> Keluar
            </button>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto bg-slate-950 relative p-4 md:p-8">
        
        <div class="md:hidden flex justify-between items-center mb-6">
            <h1 class="font-bold text-lg text-emerald-500">Kesiswaan BK</h1>
            <button onclick="logout()" class="text-red-500"><i data-lucide="log-out"></i></button>
        </div>

        <div id="view-dashboard" class="space-y-6 fade-in">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
                <div>
                    <h2 class="text-3xl font-bold text-white">Monitoring Siswa</h2>
                    <p class="text-slate-400 text-sm">Realtime Update: <span id="jam-real" class="font-mono text-emerald-400">...</span></p>
                </div>
                <div class="flex gap-2">
                    <button onclick="tarikDataSiswa(true)" class="bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 text-xs transition border border-slate-700">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i> Refresh Data Siswa
                    </button>
                    <button onclick="window.open('monitor.html', '_blank')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 text-xs shadow-lg shadow-indigo-500/20 active:scale-95 transition">
                        <i data-lucide="tv" class="w-4 h-4"></i> Layar TV
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-slate-900 p-5 rounded-2xl border border-slate-800"><p class="text-slate-500 text-xs font-bold uppercase">Hadir</p><h3 class="text-3xl font-black text-emerald-400 mt-1" id="stat-hadir">0</h3></div>
                <div class="bg-slate-900 p-5 rounded-2xl border border-slate-800"><p class="text-slate-500 text-xs font-bold uppercase">Izin / Sakit</p><h3 class="text-3xl font-black text-blue-400 mt-1" id="stat-izin">0</h3></div>
                <div class="bg-slate-900 p-5 rounded-2xl border border-slate-800"><p class="text-slate-500 text-xs font-bold uppercase">Alpha / Belum</p><h3 class="text-3xl font-black text-red-400 mt-1" id="stat-alpha">0</h3></div>
                <div class="bg-slate-900 p-5 rounded-2xl border border-slate-800"><p class="text-slate-500 text-xs font-bold uppercase">Total Siswa</p><h3 class="text-3xl font-black text-white mt-1" id="stat-total">0</h3></div>
            </div>

            <div class="bg-slate-900 rounded-2xl border border-slate-800 overflow-hidden mt-6">
                <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                    <h3 class="font-bold text-white">Log Aktivitas Terbaru</h3>
                    <span class="text-xs text-slate-500">Live Today</span>
                </div>
                <div class="overflow-x-auto max-h-96">
                    <table class="w-full text-left text-slate-400">
                        <thead class="bg-slate-950 text-xs uppercase font-bold text-slate-500 sticky top-0">
                            <tr><th class="p-4">Jam</th><th class="p-4">Nama Siswa</th><th class="p-4">Kelas</th><th class="p-4">Status</th></tr>
                        </thead>
                        <tbody id="tabel-live" class="divide-y divide-slate-800"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-rekap" class="hidden space-y-6 fade-in">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4 mb-4">
                <div>
                    <h2 class="text-3xl font-bold text-white">Rekapitulasi Detail</h2>
                    <p class="text-xs text-slate-400 mt-1">Laporan Jam Masuk & Pulang Lengkap</p>
                </div>
                <div class="flex flex-wrap gap-2">
                    <select id="pilih-bulan" class="bg-slate-800 text-white text-xs rounded-lg px-3 py-2 outline-none border border-slate-700"></select>
                    <select id="pilih-tahun" class="bg-slate-800 text-white text-xs rounded-lg px-3 py-2 outline-none border border-slate-700"></select>
                    <select id="pilih-kelas" class="bg-slate-800 text-white text-xs rounded-lg px-3 py-2 outline-none border border-slate-700">
                        <option value="">- Pilih Kelas -</option>
                    </select>
                    <button onclick="loadRekap()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-xs font-bold">Tampilkan</button>
                    <button onclick="downloadExcel('tabel-rekap')" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg text-xs font-bold" title="Download Excel"><i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Excel Lengkap</button>
                </div>
            </div>
            
            <div class="flex-1 bg-slate-900 rounded-2xl border border-slate-800 overflow-auto relative h-[70vh]">
                <table id="tabel-rekap" class="w-full text-center text-[10px] border-collapse table-sticky whitespace-nowrap">
                    <thead class="text-slate-300 font-bold" id="thead-rekap"></thead>
                    <tbody id="tbody-rekap" class="text-slate-400 divide-y divide-slate-800"></tbody>
                </table>
            </div>
        </div>

        <div id="view-dispen" class="hidden space-y-6 fade-in">
            <h2 class="text-3xl font-bold text-white">Kelola Dispensasi (D)</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-slate-900 p-6 rounded-2xl border border-slate-800">
                    <h3 class="font-bold text-white mb-4">Input Dispen Baru</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-slate-500 uppercase font-bold">Cari Siswa</label>
                            <input type="text" id="inputCariSiswa" onkeyup="cariSiswaLokal()" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 mt-1" placeholder="Ketik nama siswa...">
                            <div id="hasilCariSiswa" class="hidden bg-slate-800 border border-slate-700 mt-1 rounded-lg max-h-40 overflow-y-auto absolute w-60 z-50 shadow-xl"></div>
                        </div>
                        <input type="hidden" id="inputNisnSiswa">
                        <input type="hidden" id="inputKelasSiswa">
                        
                        <div>
                            <label class="text-xs text-slate-500 uppercase font-bold">Siswa Terpilih</label>
                            <input type="text" id="displayNamaSiswa" class="w-full bg-slate-950 text-emerald-400 p-3 rounded-lg border border-slate-700 mt-1 font-bold" readonly placeholder="-">
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <div><label class="text-xs text-slate-500 uppercase font-bold">Tgl Mulai</label><input type="date" id="inputStart" class="w-full bg-slate-800 text-white p-2 rounded-lg border border-slate-700 mt-1"></div>
                            <div><label class="text-xs text-slate-500 uppercase font-bold">Tgl Selesai</label><input type="date" id="inputEnd" class="w-full bg-slate-800 text-white p-2 rounded-lg border border-slate-700 mt-1"></div>
                        </div>

                        <div>
                            <label class="text-xs text-slate-500 uppercase font-bold">Keterangan</label>
                            <select id="inputAlasan" class="w-full bg-slate-800 text-white p-3 rounded-lg border border-slate-700 mt-1">
                                <option value="Lomba Akademik">Lomba Akademik</option>
                                <option value="Lomba Non-Akademik">Lomba Non-Akademik</option>
                                <option value="Tugas Sekolah">Tugas Sekolah (OSIS/Panitia)</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>

                        <div>
                            <label class="text-xs text-slate-500 uppercase font-bold">Upload Surat (Foto/PDF)</label>
                            <input type="file" id="inputBuktiSurat" class="w-full bg-slate-800 text-slate-400 text-xs p-2 rounded-lg border border-slate-700 mt-1 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 cursor-pointer">
                            <p class="text-[9px] text-slate-500 mt-1 italic">*Maksimal 2MB</p>
                        </div>

                        <button onclick="simpanDispen()" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-lg transition">Simpan Dispensasi</button>
                    </div>
                </div>

                <div class="md:col-span-2 bg-slate-900 p-6 rounded-2xl border border-slate-800">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-white">Daftar Dispensasi Aktif Bulan Ini</h3>
                        <button onclick="loadDispen()" class="text-xs bg-slate-800 px-3 py-1 rounded text-white"><i data-lucide="refresh-cw" class="w-3 h-3"></i></button>
                    </div>
                    <div class="overflow-y-auto max-h-[500px]">
                        <table class="w-full text-left text-sm text-slate-400">
                            <thead class="bg-slate-950 text-xs uppercase font-bold text-slate-500 sticky top-0">
                                <tr><th class="p-3">Siswa</th><th class="p-3">Tanggal</th><th class="p-3">Keterangan</th><th class="p-3 text-right">Aksi</th></tr>
                            </thead>
                            <tbody id="tbody-dispen" class="divide-y divide-slate-800"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-mbg" class="hidden space-y-6 fade-in">
             <div class="flex items-center justify-between">
                <h2 class="text-3xl font-bold text-white">Laporan MBG</h2>
                <div class="text-xs text-slate-500 bg-slate-900 border border-slate-800 px-3 py-1 rounded-lg">Data Hari Ini</div>
             </div>
             
             <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-slate-900 rounded-2xl border border-slate-800 p-6 relative overflow-hidden group hover:border-blue-500 transition cursor-pointer" onclick="previewMBG('X')">
                    <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20"><i data-lucide="utensils" class="w-24 h-24 text-blue-500"></i></div>
                    <h3 class="text-xl font-black text-white">KELAS X</h3>
                    <p class="text-xs text-slate-400 mt-2">Lihat Rincian</p>
                </div>
                <div class="bg-slate-900 rounded-2xl border border-slate-800 p-6 relative overflow-hidden group hover:border-green-500 transition cursor-pointer" onclick="previewMBG('XI')">
                    <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20"><i data-lucide="utensils" class="w-24 h-24 text-green-500"></i></div>
                    <h3 class="text-xl font-black text-white">KELAS XI</h3>
                    <p class="text-xs text-slate-400 mt-2">Lihat Rincian</p>
                </div>
                <div class="bg-slate-900 rounded-2xl border border-slate-800 p-6 relative overflow-hidden group hover:border-orange-500 transition cursor-pointer" onclick="previewMBG('XII')">
                    <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20"><i data-lucide="utensils" class="w-24 h-24 text-orange-500"></i></div>
                    <h3 class="text-xl font-black text-white">KELAS XII</h3>
                    <p class="text-xs text-slate-400 mt-2">Lihat Rincian</p>
                </div>
             </div>

             <div id="container-tabel-mbg" class="hidden bg-white text-slate-900 rounded-2xl p-6 shadow-xl mt-6 border border-slate-700">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg text-slate-800" id="judul-tabel-mbg">Detail Logistik</h3>
                    <button onclick="downloadExcel('tabel-mbg-detail')" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-2"><i data-lucide="printer" class="w-4 h-4"></i> Download Cetak</button>
                </div>
                <div class="overflow-x-auto">
                    <table id="tabel-mbg-detail" class="w-full text-sm border border-slate-300">
                        <thead class="bg-slate-100">
                            <tr><th class="border p-3 text-left w-32">KELAS</th><th class="border p-3 text-center w-32">TOTAL SISWA</th><th class="border p-3 bg-green-100 text-green-800 text-center font-black text-lg">JATAH MAKAN</th><th class="border p-3 bg-red-100 text-red-800 text-center">SISA</th></tr>
                        </thead>
                        <tbody id="tbody-mbg" class="text-slate-700 text-center"></tbody>
                        <tfoot class="bg-slate-800 text-white font-bold">
                            <tr><td class="border border-slate-600 p-3 text-right">TOTAL</td><td class="border border-slate-600 p-3 text-center" id="mbg-grand-total">0</td><td class="border border-slate-600 p-3 text-center bg-green-900 text-green-300 text-xl" id="mbg-grand-hadir">0</td><td class="border border-slate-600 p-3 text-center bg-red-900 text-red-300" id="mbg-grand-sisa">0</td></tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <div id="loading" class="fixed inset-0 bg-slate-900 flex flex-col items-center justify-center z-50 text-white">
        <div class="w-12 h-12 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="font-bold animate-pulse">Memuat Data...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        // PENTING: TAMBAHKAN uploadBytes DI IMPORT STORAGE
        import { getFirestore, collection, query, where, getDocs, getDoc, onSnapshot, doc, setDoc, addDoc, deleteDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL, uploadBytes } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

        const firebaseConfig = { apiKey: "AIzaSyBXWR-_aJyoMrUjTeNQYlcPD8p3eu58yOo", authDomain: "siganteng-absensi.firebaseapp.com", databaseURL: "https://siganteng-absensi-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "siganteng-absensi", storageBucket: "siganteng-absensi.firebasestorage.app", messagingSenderId: "917873420012", appId: "1:917873420012:web:0fe1a9eddc5f94959ba7c9" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let listSiswa = []; let mapKelas = {}; let cacheAbsenHariIni = {}; let cacheHariLibur = {}; 
        let cacheDispen = {}; 

        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            
            // SAFETY CHECK: Pastikan elemen ada sebelum diakses
            const elBulan = document.getElementById('pilih-bulan');
            if(elBulan) setupDropdown();
            
            try {
                await tarikDataSiswa(); 
                pantauRealtime();
                loadHariLibur(); 
                loadDispen();
            } catch (e) {
                console.error("Error init:", e);
            } finally {
                // FORCE CLOSE LOADING
                if(document.getElementById('loading')) document.getElementById('loading').style.display = 'none';
            }
        });

        // 1. DATA SISWA (CACHE ROBUST)
        window.tarikDataSiswa = async (forceRefresh = false) => {
            const cacheKey = 'master_siswa_cache_bk_v2'; 
            
            try {
                const cachedData = localStorage.getItem(cacheKey); 
                if (!forceRefresh && cachedData) {
                    const parsed = JSON.parse(cachedData);
                    listSiswa = parsed.listSiswa || [];
                    mapKelas = parsed.mapKelas || {};
                    updateUIKelas();
                    return;
                }
            } catch (e) {
                console.log("Cache rusak, download ulang...");
                localStorage.removeItem(cacheKey);
            }

            try {
                if(forceRefresh) document.getElementById('loading').style.display = 'flex';
                const q = query(collection(db, "users"), where("role", "==", "siswa")); 
                const snap = await getDocs(q);
                
                listSiswa = []; mapKelas = {};
                snap.forEach(doc => {
                    const s = doc.data();
                    if(s.kelas && s.kelas !== '-') {
                        const nisn = String(s.username).replace(/[^a-zA-Z0-9]/g, '').trim(); 
                        const kls = String(s.kelas).trim().toUpperCase();
                        const obj = { nama: s.nama, nisn: nisn, kelas: kls };
                        listSiswa.push(obj);
                        if(!mapKelas[kls]) mapKelas[kls] = [];
                        mapKelas[kls].push(obj);
                    }
                });
                
                localStorage.setItem(cacheKey, JSON.stringify({listSiswa, mapKelas})); 
                updateUIKelas();
                
                if(forceRefresh) { 
                    document.getElementById('loading').style.display = 'none'; 
                    Swal.fire('Sip','Data siswa diperbarui','success'); 
                }
            } catch (e) { 
                console.log("Error tarik siswa:", e); 
                if(forceRefresh) document.getElementById('loading').style.display = 'none';
            }
        }

        function updateUIKelas() {
            const sel = document.getElementById('pilih-kelas');
            if(!sel) return;
            sel.innerHTML = '<option value="">- Pilih Kelas -</option>';
            Object.keys(mapKelas).sort().forEach(k => sel.add(new Option(k, k)));
            
            const statEl = document.getElementById('stat-total');
            if(statEl) statEl.innerText = listSiswa.length;
        }

        // 2. KELOLA DISPENSASI (DENGAN UPLOAD SURAT)
        window.cariSiswaLokal = () => {
            const val = document.getElementById('inputCariSiswa').value.toLowerCase();
            const resDiv = document.getElementById('hasilCariSiswa');
            resDiv.innerHTML = '';
            if(val.length < 3) { resDiv.classList.add('hidden'); return; }
            
            const results = listSiswa.filter(s => (s.nama && s.nama.toLowerCase().includes(val)) || (s.nisn && s.nisn.includes(val))).slice(0, 5);
            if(results.length > 0) {
                resDiv.classList.remove('hidden');
                results.forEach(s => {
                    resDiv.innerHTML += `<div onclick="pilihSiswaDispen('${s.nisn}', '${s.nama}', '${s.kelas}')" class="p-2 hover:bg-slate-700 cursor-pointer text-xs text-white border-b border-slate-700">${s.nama} (${s.kelas})</div>`;
                });
            } else {
                resDiv.innerHTML = '<div class="p-2 text-xs text-slate-400">Tidak ditemukan</div>';
                resDiv.classList.remove('hidden');
            }
        }

        window.pilihSiswaDispen = (nisn, nama, kelas) => {
            document.getElementById('inputNisnSiswa').value = nisn;
            document.getElementById('displayNamaSiswa').value = `${nama} (${kelas})`;
            document.getElementById('inputKelasSiswa').value = kelas;
            document.getElementById('hasilCariSiswa').classList.add('hidden');
            document.getElementById('inputCariSiswa').value = '';
        }

        window.simpanDispen = async () => {
            const nisn = document.getElementById('inputNisnSiswa').value;
            const nama = document.getElementById('displayNamaSiswa').value;
            const kelas = document.getElementById('inputKelasSiswa').value;
            const start = document.getElementById('inputStart').value;
            const end = document.getElementById('inputEnd').value;
            const alasan = document.getElementById('inputAlasan').value;
            
            // AMBIL FILE DARI INPUT
            const fileInput = document.getElementById('inputBuktiSurat');
            const file = fileInput.files[0];

            if(!nisn || !start || !end) return Swal.fire('Lengkapi Data', 'Pilih siswa dan tanggal dulu', 'warning');
            
            // Tampilkan Loading
            Swal.fire({ title: 'Menyimpan...', didOpen: () => Swal.showLoading() });

            try {
                let urlSurat = "-"; // Default

                // UPLOAD FILE KE STORAGE JIKA ADA
                if (file) {
                    const namaFile = `${nisn}_${Date.now()}_${file.name}`;
                    const storageRef = ref(storage, `surat_dispen/${namaFile}`);
                    const snapshot = await uploadBytes(storageRef, file);
                    urlSurat = await getDownloadURL(snapshot.ref);
                }

                // SIMPAN KE FIRESTORE
                await addDoc(collection(db, "dispensasi"), {
                    nisn, nama, kelas, start, end, alasan,
                    link_surat: urlSurat, 
                    created_at: new Date().toISOString()
                });

                Swal.fire('Berhasil', 'Dispensasi & Surat dicatat', 'success');
                
                // Reset form
                document.getElementById('inputNisnSiswa').value = '';
                document.getElementById('displayNamaSiswa').value = '';
                document.getElementById('inputBuktiSurat').value = ''; // Reset file input
                
            } catch(e) { 
                console.error(e);
                Swal.fire('Error', e.message, 'error'); 
            }
        }

        function loadDispen() {
            try {
                const q = query(collection(db, "dispensasi"), orderBy("created_at", "desc"), limit(50));
                onSnapshot(q, (snap) => {
                    const tbody = document.getElementById('tbody-dispen');
                    if(!tbody) return;
                    tbody.innerHTML = '';
                    cacheDispen = {}; 
                    snap.forEach(doc => {
                        const d = doc.data();
                        const id = doc.id;
                        
                        if(!cacheDispen[d.nisn]) cacheDispen[d.nisn] = [];
                        cacheDispen[d.nisn].push({start: d.start, end: d.end});

                        // TOMBOL LIHAT SURAT (Jika ada linknya)
                        let btnSurat = d.link_surat && d.link_surat !== "-" 
                            ? `<a href="${d.link_surat}" target="_blank" class="text-blue-400 hover:text-blue-300 mr-2 bg-blue-500/10 p-1 rounded" title="Lihat Surat"><i data-lucide="file-text" class="w-4 h-4"></i></a>` 
                            : `<span class="text-slate-600 mr-2 cursor-not-allowed p-1" title="Tanpa Surat"><i data-lucide="file-minus" class="w-4 h-4"></i></span>`;

                        tbody.innerHTML += `
                            <tr class="border-b border-slate-800 hover:bg-slate-800">
                                <td class="p-3 text-white font-bold">${d.nama}</td>
                                <td class="p-3 font-mono text-xs text-blue-400">${d.start} s.d ${d.end}</td>
                                <td class="p-3 text-xs">${d.alasan}</td>
                                <td class="p-3 text-right flex justify-end items-center">
                                    ${btnSurat}
                                    <button onclick="hapusDispen('${id}')" class="text-red-500 hover:text-red-400 p-1 hover:bg-red-500/10 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </td>
                            </tr>
                        `;
                    });
                    lucide.createIcons();
                });
            } catch(e) { console.log("Dispen error:", e); }
        }
        window.hapusDispen = async (id) => { if(confirm("Hapus data dispen ini?")) await deleteDoc(doc(db, "dispensasi", id)); }

        // 3. REKAP BULANAN
        window.loadRekap = async () => {
            const bln = parseInt(document.getElementById('pilih-bulan').value) + 1;
            const thn = document.getElementById('pilih-tahun').value;
            const kls = document.getElementById('pilih-kelas').value;
            if(!kls) return Swal.fire('Pilih Kelas', 'Silakan pilih kelas siswa dulu.', 'warning');
            
            const blnStr = bln < 10 ? '0' + bln : bln;
            const daysInMonth = new Date(thn, bln, 0).getDate();
            let headerHTML = '<tr><th class="p-2 w-10 border border-slate-700">No</th><th class="p-2 border border-slate-700 min-w-[200px] text-left">Nama Lengkap</th><th class="p-2 border border-slate-700">NISN</th>';
            for(let d=1; d<=daysInMonth; d++) {
                const dStr = d < 10 ? '0' + d : d;
                const cekTgl = `${thn}-${blnStr}-${dStr}`; 
                const isMerah = cacheHariLibur[cekTgl];
                const dayOfWeek = new Date(thn, bln-1, d).getDay();
                let bgHead = (dayOfWeek === 0 || dayOfWeek === 6 || isMerah) ? 'bg-red-900/50 text-red-200' : 'bg-slate-900';
                headerHTML += `<th class="p-2 border border-slate-700 ${bgHead} w-10 text-center" title="${isMerah || ''}">${d}</th>`;
            }
            headerHTML += '<th class="p-2 border border-slate-700 bg-emerald-900">H</th><th class="p-2 border border-slate-700 bg-purple-900">D</th><th class="p-2 border border-slate-700 bg-blue-900">S</th><th class="p-2 border border-slate-700 bg-yellow-900">I</th><th class="p-2 border border-slate-700 bg-red-900">A</th></tr>';
            document.getElementById('thead-rekap').innerHTML = headerHTML;

            const tbody = document.getElementById('tbody-rekap');
            tbody.innerHTML = '<tr><td colspan="40" class="p-4 text-center"><i class="animate-spin" data-lucide="loader"></i> Mengambil data...</td></tr>';
            
            let targetUsers = mapKelas[kls] || [];
            if(targetUsers.length === 0) { tbody.innerHTML = '<tr><td colspan="40" class="p-4 text-center">Data siswa tidak ditemukan.</td></tr>'; return; }
            
            const startStr = `${thn}-${blnStr}-01`; 
            const endStr = `${thn}-${blnStr}-${daysInMonth}`;
            
            const qAbsen = query(collection(db, "absensi"), where("tanggal", ">=", startStr), where("tanggal", "<=", endStr));
            const snapAbsen = await getDocs(qAbsen);
            
            let dataMap = {};
            targetUsers.forEach(u => { 
                const cleanNISN = String(u.nisn).replace(/[^a-zA-Z0-9]/g, '').trim(); 
                dataMap[cleanNISN] = { nama: u.nama, att: {}, counts: {h:0, d:0, s:0, i:0, a:0} }; 
            });
            
            snapAbsen.forEach(doc => {
                const d = doc.data();
                const tgl = parseInt(d.tanggal.split('-')[2]); 
                const docNISN = String(d.nisn).replace(/[^a-zA-Z0-9]/g, '').trim();
                
                if(dataMap[docNISN]) {
                    let jamMasuk = d.jam_masuk ? new Date(d.jam_masuk.seconds*1000).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'}) : "-";
                    let jamPulang = d.jam_pulang ? new Date(d.jam_pulang.seconds*1000).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'}) : "-";
                    dataMap[docNISN].att[tgl] = { status: d.status_terakhir, time: `${jamMasuk}<br>${jamPulang}` };
                }
            });
            
            tbody.innerHTML = '';
            targetUsers.sort((a,b) => a.nama.localeCompare(b.nama)).forEach((u, idx) => {
                const cleanNISN = String(u.nisn).replace(/[^a-zA-Z0-9]/g, '').trim();
                const r = dataMap[cleanNISN];
                if(!r) return; 

                let rowHTML = `<tr class="hover:bg-slate-800 border-b border-slate-800"><td class="p-2 border border-slate-700 text-center">${idx+1}</td><td class="p-2 border border-slate-700 text-left font-bold text-slate-300 sticky left-0 bg-slate-900 border-r">${r.nama}</td><td class="p-2 border border-slate-700 text-center font-mono text-xs text-slate-500 bg-slate-900 sticky left-[150px]">${u.nisn}</td>`;
                let totalAlpha = 0;
                
                for(let d=1; d<=daysInMonth; d++) {
                    const dStr = d < 10 ? '0' + d : d;
                    const dateStr = `${thn}-${blnStr}-${dStr}`;
                    const dayOfWeek = new Date(thn, bln-1, d).getDay();
                    const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
                    const isLiburNasional = cacheHariLibur[dateStr];
                    
                    let isDispen = false;
                    if(cacheDispen[cleanNISN]) {
                        isDispen = cacheDispen[cleanNISN].some(range => dateStr >= range.start && dateStr <= range.end);
                    }

                    const dataHarian = r.att[d];
                    let cellClass = ""; let cellText = "";

                    if(isDispen) {
                        cellClass = "bg-dispen"; cellText = "D"; r.counts.d++;
                    } else if (dataHarian) { 
                        const st = dataHarian.status;
                        if (st.includes("Masuk") || st.includes("Hadir") || st.includes("Pulang")) { 
                            cellClass = "bg-hadir"; cellText = dataHarian.time; r.counts.h++; 
                        } 
                        else if (st.includes("Sakit")) { cellClass = "bg-sakit"; cellText = "S"; r.counts.s++; } 
                        else if (st.includes("Izin")) { cellClass = "bg-izin"; cellText = "I"; r.counts.i++; } 
                    } else { 
                        if (isLiburNasional) { cellClass = "bg-red-900/40 text-red-500 font-bold"; cellText = "L"; } 
                        else if (isWeekend) { cellClass = "bg-weekend"; cellText = ""; } 
                        else { 
                            const cellDate = new Date(thn, bln-1, d); 
                            const today = new Date();
                            if(cellDate < today.setHours(0,0,0,0)) { totalAlpha++; cellClass = "bg-alpha"; cellText = "A"; } 
                            else { cellText = "-"; } 
                        } 
                    }
                    rowHTML += `<td class="p-1 border border-slate-700 text-center ${cellClass} leading-tight text-[9px]">${cellText}</td>`;
                }
                rowHTML += `<td class="p-2 border border-slate-700 font-bold text-emerald-400">${r.counts.h}</td><td class="p-2 border border-slate-700 font-bold text-purple-400">${r.counts.d}</td><td class="p-2 border border-slate-700 font-bold text-blue-400">${r.counts.s}</td><td class="p-2 border border-slate-700 font-bold text-yellow-400">${r.counts.i}</td><td class="p-2 border border-slate-700 font-bold text-red-400">${totalAlpha}</td></tr>`;
                tbody.innerHTML += rowHTML;
            });
        }

        // OTHER FUNCTIONS
        function pantauRealtime() { const todayStr = new Date().toLocaleDateString('fr-CA'); const q = query(collection(db, "absensi"), where("tanggal", "==", todayStr)); onSnapshot(q, (snap) => { let hadir=0, izin=0; let log=[]; snap.forEach(doc => { const d=doc.data(); if(d.status_terakhir.includes("Masuk")||d.status_terakhir.includes("Hadir")) hadir++; else if(d.status_terakhir.includes("Sakit")||d.status_terakhir.includes("Izin")) izin++; log.push(d); }); document.getElementById('stat-hadir').innerText=hadir; document.getElementById('stat-izin').innerText=izin; document.getElementById('stat-alpha').innerText=listSiswa.length-(hadir+izin); const tbl=document.getElementById('tabel-live'); if(tbl){ tbl.innerHTML=''; log.sort((a,b)=>(b.jam_masuk?b.jam_masuk.seconds:0)-(a.jam_masuk?a.jam_masuk.seconds:0)).slice(0,20).forEach(d=>{ tbl.innerHTML+=`<tr class="border-b border-slate-800 hover:bg-slate-800"><td class="p-4 text-emerald-400 font-mono">${d.jam_masuk?new Date(d.jam_masuk.seconds*1000).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'}):'-'}</td><td class="p-4 text-white">${d.nama}</td><td class="p-4">${d.kelas}</td><td class="p-4">${d.status_terakhir}</td></tr>`; }); } if(!document.getElementById('container-tabel-mbg').classList.contains('hidden')){ const judul=document.getElementById('judul-tabel-mbg').innerText; if(judul.includes("KELAS X")) previewMBG('X'); else if(judul.includes("XI")) previewMBG('XI'); else if(judul.includes("XII")) previewMBG('XII'); } }); }
        function loadHariLibur() { const q = query(collection(db, "hari_libur"), orderBy("tanggal", "asc")); onSnapshot(q, (snap) => { cacheHariLibur = {}; snap.forEach(doc => { const d=doc.data(); cacheHariLibur[d.tanggal] = d.keterangan; }); }); }
        window.simpanLibur = async () => { const tgl = document.getElementById('inputTglLibur').value; const ket = document.getElementById('inputKetLibur').value; if(!tgl || !ket) return Swal.fire('Gagal','','warning'); await addDoc(collection(db, "hari_libur"), { tanggal: tgl, keterangan: ket }); Swal.fire('Sukses','','success'); }
        window.downloadExcel = (id) => { const t=document.getElementById(id); const l=document.createElement("a"); l.href='data:application/vnd.ms-excel;charset=utf-8,'+encodeURIComponent(t.outerHTML.replace(/<table/g,'<table border="1"').replace(/<br>/g, ' - ')); l.download="REKAP_BK_DETAIL.xls"; l.click(); }
        window.nav = (v) => { document.querySelectorAll('[id^="view-"]').forEach(e => e.classList.add('hidden')); document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active')); document.getElementById('view-'+v).classList.remove('hidden'); document.getElementById('nav-'+v).classList.add('active'); }
        window.logout = () => { localStorage.clear(); window.location.href='index.html'; }
        function setupDropdown() { const d=new Date(); const m=["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agt","Sep","Okt","Nov","Des"]; m.forEach((b,i)=>{let o=new Option(b,i); if(i===d.getMonth())o.selected=true; document.getElementById('pilih-bulan').add(o);}); for(let y=d.getFullYear()-1;y<=d.getFullYear()+1;y++) document.getElementById('pilih-tahun').add(new Option(y,y)); }
        window.previewMBG = (tingkat) => { const tbody = document.getElementById('tbody-mbg'); tbody.innerHTML = ''; let gt=0,gh=0,gs=0; Object.keys(mapKelas).sort((a,b)=>a.localeCompare(b,undefined,{numeric:true})).forEach(k=>{ if((tingkat=='X'&&k.startsWith('X')&&!k.startsWith('XI')&&!k.startsWith('XII')) || (tingkat=='XI'&&k.startsWith('XI')&&!k.startsWith('XII')) || (tingkat=='XII'&&k.startsWith('XII'))) { let tot=mapKelas[k].length; let had=0; mapKelas[k].forEach(s=>{ let cn=String(s.nisn).replace(/[^a-zA-Z0-9]/g,''); if(cacheAbsenHariIni[cn] && (cacheAbsenHariIni[cn].status_terakhir.includes("Masuk")||cacheAbsenHariIni[cn].status_terakhir.includes("Hadir"))) had++; }); let sisa=tot-had; gt+=tot; gh+=had; gs+=sisa; tbody.innerHTML+=`<tr class="border-b hover:bg-slate-50"><td class="border p-2 text-left font-bold">${k}</td><td class="border p-2 font-bold text-center">${tot}</td><td class="border p-2 bg-green-100 text-green-700 font-bold text-center text-lg">${had}</td><td class="border p-2 bg-red-100 text-red-600 font-bold text-center">${sisa}</td></tr>`; } }); document.getElementById('mbg-grand-total').innerText=gt; document.getElementById('mbg-grand-hadir').innerText=gh; document.getElementById('mbg-grand-sisa').innerText=gs; document.getElementById('container-tabel-mbg').classList.remove('hidden'); document.getElementById('judul-tabel-mbg').innerText = `Detail Logistik - KELAS ${tingkat}`; }
        setInterval(() => { const el = document.getElementById('jam-real'); if(el) el.innerText = new Date().toLocaleTimeString('id-ID'); }, 1000);
    </script>
</body>
</html>