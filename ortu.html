<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Laporan Wali Murid - SiGanteng</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo.png">
    <meta name="theme-color" content="#0f172a">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .glass-header { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        .row-libur { background-color: #f8fafc; color: #94a3b8; }
        .row-alpha { background-color: #fef2f2; color: #ef4444; }
        .avatar-absen { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 2px solid #e2e8f0; transition: transform 0.2s; cursor: pointer; background: #fff; }
        .avatar-absen:hover { transform: scale(2.5); border-color: #3b82f6; z-index: 50; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col pb-10">

    <header class="glass-header p-6 pb-20 rounded-b-[3rem] shadow-2xl relative z-10">
        <div class="flex justify-between items-center mb-6">
            <div>
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-[0.2em]">Laporan Presensi</p>
                <h1 class="text-2xl font-black text-white">SiGanteng <span class="text-blue-500">Family</span></h1>
            </div>
            <button onclick="logout()" class="bg-white/10 p-2 rounded-full text-white hover:bg-red-500 transition"><i data-lucide="log-out" class="w-5 h-5"></i></button>
        </div>

        <div class="flex items-center gap-4">
            <div class="w-14 h-14 rounded-2xl p-1 bg-white/10 backdrop-blur-md border border-white/20">
                <img id="foto-anak" src="" class="w-full h-full rounded-xl object-cover bg-slate-800" onerror="this.src='https://ui-avatars.com/api/?background=random&color=fff'">
            </div>
            <div>
                <h2 id="nama-anak" class="text-lg font-bold text-white leading-tight">...</h2>
                <div class="flex items-center gap-2 mt-1">
                    <span id="kelas-anak" class="text-[10px] font-black bg-blue-600 text-white px-2 py-0.5 rounded-md uppercase">...</span>
                    <span id="nisn-anak" class="text-[10px] font-mono text-slate-400 tracking-wider">...</span>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 px-4 -mt-12 relative z-20 space-y-6">

        <div class="bg-white p-5 rounded-[2rem] shadow-xl border border-slate-100 flex items-center justify-between relative overflow-hidden">
            <div class="absolute -right-5 -bottom-5 opacity-5"><i data-lucide="calendar-check" class="w-24 h-24"></i></div>
            <div>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Status Hari Ini</p>
                <h3 id="status-hari-ini" class="text-xl font-black text-slate-800">MEMUAT...</h3>
            </div>
            <div id="icon-hari-ini" class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center">
                <i data-lucide="loader" class="w-6 h-6 animate-spin text-slate-400"></i>
            </div>
        </div>

        <div id="section-menu-dinamis" class="hidden">
            <h3 class="font-bold text-slate-700 text-xs mb-2 ml-1 flex items-center gap-2">
                <i data-lucide="grid" class="w-3 h-3 text-blue-500"></i> Layanan Wali Murid
            </h3>
            <div id="grid-menu-dinamis" class="grid grid-cols-2 gap-3"></div>
        </div>

        <div class="bg-white p-5 rounded-[2rem] shadow-lg border border-slate-100">
            <div class="flex items-center gap-2 mb-4 border-b border-slate-50 pb-2">
                <i data-lucide="book-open" class="w-4 h-4 text-emerald-500"></i>
                <h3 class="font-black text-slate-700 text-xs uppercase tracking-widest">Pembelajaran Hari Ini</h3>
            </div>
            <div id="container-kbm" class="space-y-3">
                <div class="text-center text-slate-400 text-xs italic py-4">Memuat data KBM...</div>
            </div>
        </div>

        <div class="flex gap-2">
            <select id="filter-bulan" onchange="loadLaporanBulanan()" class="flex-1 bg-white border border-slate-200 text-xs font-bold text-slate-700 rounded-xl px-3 py-3 outline-none shadow-sm"></select>
            <select id="filter-tahun" onchange="loadLaporanBulanan()" class="w-24 bg-white border border-slate-200 text-xs font-bold text-slate-700 rounded-xl px-3 py-3 outline-none shadow-sm"></select>
        </div>

        <div class="bg-white rounded-[1.5rem] shadow-lg border border-slate-100 overflow-hidden">
            <div class="p-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-black text-slate-700 text-xs uppercase tracking-widest flex items-center gap-2">
                    <i data-lucide="file-text" class="w-4 h-4 text-blue-500"></i> Rekap Absensi
                </h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-white text-[9px] font-black text-slate-400 uppercase tracking-wider border-b border-slate-100">
                        <tr>
                            <th class="p-3 w-10 text-center">Tgl</th>
                            <th class="p-3 w-12 text-center">Bukti</th>
                            <th class="p-3">Waktu / Status</th>
                            <th class="p-3">Ket</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-laporan" class="text-xs font-medium text-slate-600 divide-y divide-slate-50"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, collection, query, where, getDocs, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXWR-_aJyoMrUjTeNQYlcPD8p3eu58yOo",
            authDomain: "siganteng-absensi.firebaseapp.com",
            databaseURL: "https://siganteng-absensi-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "siganteng-absensi",
            storageBucket: "siganteng-absensi.firebasestorage.app",
            messagingSenderId: "917873420012",
            appId: "1:917873420012:web:0fe1a9eddc5f94959ba7c9"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let userAnak = null;
        let cacheHariLibur = {};

        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            setupFilterTanggal();
            const dataLokal = localStorage.getItem('userSiswa');
            if (dataLokal) {
                userAnak = JSON.parse(dataLokal);
                initHeader();
                pantauHariIni();
                loadMenuDinamis();
                await loadHariLibur();
                loadLaporanBulanan();
                loadKBMHariIni();
            } else { window.location.href = 'index.html'; }
        });

        // 1. HEADER & PROFIL (Pakai Cache getDoc biar hemat, bukan onSnapshot)
        function initHeader() {
            document.getElementById('nama-anak').innerText = userAnak.nama;
            document.getElementById('kelas-anak').innerText = userAnak.kelas;
            document.getElementById('nisn-anak').innerText = userAnak.nisn || userAnak.username;
            const nisn = String(userAnak.username || userAnak.nisn);
            
            // Cek Cache Lokal Dulu untuk Foto Anak
            const cachedFoto = localStorage.getItem(`foto_anak_${nisn}`);
            if(cachedFoto) {
                document.getElementById('foto-anak').src = cachedFoto;
            } else {
                document.getElementById('foto-anak').src = `https://ui-avatars.com/api/?name=${userAnak.nama}&background=3b82f6&color=fff&bold=true`;
                // Ambil dari server sekali
                getDoc(doc(db, "siswa", nisn)).then(snap => {
                    if(snap.exists() && snap.data().foto_profil) {
                        localStorage.setItem(`foto_anak_${nisn}`, snap.data().foto_profil);
                        document.getElementById('foto-anak').src = snap.data().foto_profil;
                    }
                });
            }
        }

        // 2. LAPORAN BULANAN (FILTER SERVER SIDE)
        window.loadLaporanBulanan = async () => {
            const tbody = document.getElementById('tbody-laporan');
            tbody.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-slate-400"><i data-lucide="loader-2" class="animate-spin w-6 h-6 inline"></i> Memuat data...</td></tr>';
            lucide.createIcons();

            const bln = parseInt(document.getElementById('filter-bulan').value);
            const thn = parseInt(document.getElementById('filter-tahun').value);
            const nisn = String(userAnak.username || userAnak.nisn);
            const daysInMonth = new Date(thn, bln, 0).getDate();
            const strBln = bln < 10 ? '0' + bln : bln;
            
            // Range Tanggal
            const start = `${thn}-${strBln}-01`;
            const end = `${thn}-${strBln}-${daysInMonth}`;
            
            try {
                // ðŸ”¥ KUNCI HEMAT: Filter Tanggal di Server (bukan client)
                const q = query(
                    collection(db, "absensi"), 
                    where("nisn", "==", nisn),
                    where("tanggal", ">=", start),
                    where("tanggal", "<=", end)
                );
                
                const snap = await getDocs(q);
                let dataMap = {};
                snap.forEach(doc => {
                    const d = doc.data();
                    dataMap[parseInt(d.tanggal.split('-')[2])] = d;
                });

                renderTabel(dataMap, daysInMonth, thn, bln, strBln);
                
            } catch (err) { 
                console.error(err);
                // Jika error index (biasanya karena range query), fallback ke client filter sementara
                if(err.message.includes("index")) {
                    console.log("Fallback: Client filter (Please create index in Firebase Console)");
                    // Fallback query lama (sementara)
                    const qOld = query(collection(db, "absensi"), where("nisn", "==", nisn));
                    const snapOld = await getDocs(qOld);
                    let dataMap = {};
                    snapOld.forEach(doc => {
                        const d = doc.data();
                        if (d.tanggal >= start && d.tanggal <= end) dataMap[parseInt(d.tanggal.split('-')[2])] = d;
                    });
                    renderTabel(dataMap, daysInMonth, thn, bln, strBln);
                } else {
                    tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500 text-xs">Gagal: ${err.message}</td></tr>`;
                }
            }
        };

        function renderTabel(dataMap, daysInMonth, thn, bln, strBln) {
            const tbody = document.getElementById('tbody-laporan');
            tbody.innerHTML = '';
            const todayZero = new Date(); todayZero.setHours(0,0,0,0);

            for(let i = 1; i <= daysInMonth; i++) {
                const currentDate = new Date(thn, bln - 1, i);
                const isWeekend = (currentDate.getDay() === 0 || currentDate.getDay() === 6);
                const tglStr = `${thn}-${strBln}-${i < 10 ? '0'+i : i}`;
                const liburNasional = cacheHariLibur[tglStr];

                const data = dataMap[i];
                let rowClass = "border-b border-slate-50";
                let tglHtml = `<span class="block font-bold text-lg leading-none text-slate-700">${i}</span>`;
                let fotoHtml = `<div class="w-8 h-8 rounded-full bg-slate-100 mx-auto"></div>`;
                let jamHtml = `<span class="text-slate-300">-</span>`;
                let ketHtml = `<span class="text-slate-300">-</span>`;

                if (liburNasional) {
                    rowClass = "bg-purple-50 border-b border-purple-100";
                    tglHtml = `<span class="block font-bold text-lg leading-none text-purple-600">${i}</span>`;
                    ketHtml = `<span class="text-[9px] font-bold text-purple-500 bg-purple-100 px-2 py-0.5 rounded uppercase">${liburNasional}</span>`;
                } else if (isWeekend) {
                    rowClass = "row-libur border-b border-slate-100";
                    ketHtml = `<span class="text-[9px] font-bold text-slate-400 bg-slate-200 px-2 py-0.5 rounded">LIBUR</span>`;
                }

                if (data) {
                    const st = data.status_terakhir;
                    const jMasuk = data.jam_masuk ? formatTime(data.jam_masuk.toDate()) : '-';
                    const jPulang = data.jam_pulang ? formatTime(data.jam_pulang.toDate()) : '-';
                    
                    let urlFoto = data.foto_masuk;
                    if(st.includes("Sakit") || st.includes("Izin")) urlFoto = data.foto_bukti;
                    
                    if(urlFoto) {
                        if(urlFoto.includes("ui-avatars")) fotoHtml = `<img src="${urlFoto}" class="w-8 h-8 rounded-full mx-auto opacity-50">`;
                        else fotoHtml = `<img src="${urlFoto}" class="avatar-absen shadow-sm" onclick="lihatFoto('${urlFoto}','${data.tanggal} - ${st}')">`;
                    }

                    if(st.includes("Hadir") || st.includes("Masuk") || st.includes("Pulang") || st.includes("Kembali")) {
                        jamHtml = `<div class="flex flex-col"><span class="text-emerald-600 font-bold">${jMasuk}</span><span class="text-blue-600 font-bold text-[10px]">${jPulang}</span></div>`;
                        ketHtml = `<span class="text-emerald-500 font-bold text-xs">HADIR</span>`;
                    } else if(st.includes("Sakit")) {
                        jamHtml = `<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded font-bold text-[10px]">SAKIT</span>`;
                        ketHtml = `<span class="text-blue-500 font-bold text-[10px]">SURAT</span>`;
                    } else if(st.includes("Izin")) {
                        jamHtml = `<span class="bg-orange-100 text-orange-700 px-2 py-1 rounded font-bold text-[10px]">IZIN</span>`;
                        ketHtml = `<span class="text-orange-500 font-bold text-[10px]">SURAT</span>`;
                    }
                    if(data.riwayat_kegiatan) {
                        data.riwayat_kegiatan.forEach(log => {
                            if(log.includes("Izin Keluar")) {
                                ketHtml += `<div class="text-[9px] text-red-500 font-bold bg-red-50 px-2 py-1 rounded leading-tight mt-1">Keluar: ${log.split(' - ')[0]}</div>`;
                            }
                        });
                    }
                } else if (!isWeekend && !liburNasional && currentDate < todayZero) {
                    rowClass = "row-alpha border-b border-red-100";
                    tglHtml = `<span class="block font-bold text-lg leading-none text-red-500">${i}</span>`;
                    jamHtml = `<span class="text-red-300 font-bold">-</span>`;
                    ketHtml = `<span class="text-red-500 font-bold text-[9px] bg-red-100 px-2 py-0.5 rounded">ALPHA</span>`;
                }
                tbody.innerHTML += `<tr class="${rowClass}"><td class="p-3 text-center align-middle">${tglHtml}</td><td class="p-3 text-center align-middle">${fotoHtml}</td><td class="p-3 align-middle">${jamHtml}</td><td class="p-3 align-middle">${ketHtml}</td></tr>`;
            }
        }

        // FUNGSI LAIN (SAMA)
        function loadMenuDinamis() { const q = query(collection(db, "menu_dinamis"), orderBy("created_at", "asc")); onSnapshot(q, (snap) => { const c = document.getElementById('grid-menu-dinamis'); const sec = document.getElementById('section-menu-dinamis'); c.innerHTML = ''; let adaData = false; snap.forEach(d => { const data = d.data(); if (data.target === 'ortu' || data.target === 'umum') { adaData = true; const style = data.highlight ? "bg-indigo-50 border-indigo-200 text-indigo-700" : "bg-white border-slate-100 text-slate-700"; c.innerHTML += `<a href="${data.link}" class="p-4 ${style} border rounded-2xl text-center flex flex-col items-center gap-2 active:scale-95 transition shadow-sm"><div class="text-2xl">${data.icon}</div><span class="text-[10px] font-bold uppercase tracking-tighter">${data.judul}</span></a>`; } }); if(adaData) sec.classList.remove('hidden'); else sec.classList.add('hidden'); }); }
        function setupFilterTanggal() { const selBulan = document.getElementById('filter-bulan'); const namabulan = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"]; const currentMonth = new Date().getMonth(); namabulan.forEach((nm, i) => { let opt = new Option(nm, i + 1); if(i === currentMonth) opt.selected = true; selBulan.add(opt); }); const selTahun = document.getElementById('filter-tahun'); const currentYear = new Date().getFullYear(); for(let y = currentYear - 1; y <= currentYear + 1; y++) { let opt = new Option(y, y); if(y === currentYear) opt.selected = true; selTahun.add(opt); } }
        async function loadHariLibur() { try { const q = query(collection(db, "hari_libur")); const snap = await getDocs(q); cacheHariLibur = {}; snap.forEach(doc => { cacheHariLibur[doc.data().tanggal] = doc.data().keterangan; }); } catch(e) {} }
        function loadKBMHariIni() { const todayStr = new Date().toLocaleDateString('fr-CA'); const container = document.getElementById('container-kbm'); const q = query(collection(db, "jurnal_guru"), where("kelas", "==", userAnak.kelas), where("tanggal", "==", todayStr), orderBy("waktu", "desc")); onSnapshot(q, (snap) => { container.innerHTML = ''; if(snap.empty) { container.innerHTML = '<div class="text-center text-slate-400 text-xs italic py-4">Belum ada KBM masuk hari ini.</div>'; return; } snap.forEach(doc => { const d = doc.data(); const jam = d.waktu ? new Date(d.waktu.toDate()).toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}) : '-'; const img = d.foto_bukti ? `<img src="${d.foto_bukti}" class="w-10 h-10 rounded-lg object-cover ml-auto border border-slate-100 cursor-pointer" onclick="lihatFoto('${d.foto_bukti}', 'Bukti KBM - ${d.mapel}')">` : ''; container.innerHTML += `<div class="flex items-start gap-3 p-3 bg-slate-50 rounded-xl border border-slate-100 fade-in"><div class="bg-indigo-100 text-indigo-600 text-[10px] font-bold px-2 py-1 rounded mt-1">${jam}</div><div class="flex-1"><h4 class="font-bold text-slate-700 text-xs leading-tight">${d.mapel}</h4><div class="text-[10px] text-slate-500 font-bold mb-1">${d.nama_guru}</div><p class="text-[10px] text-slate-400 leading-snug">"${d.materi}"</p></div>${img}</div>`; }); }); }
        function pantauHariIni() { const todayStr = new Date().toLocaleDateString('fr-CA'); const nisn = String(userAnak.username || userAnak.nisn); const statusEl = document.getElementById('status-hari-ini'); const iconEl = document.getElementById('icon-hari-ini'); onSnapshot(doc(db, "absensi", `${todayStr}_${nisn}`), (docSnap) => { if (docSnap.exists()) { const st = docSnap.data().status_terakhir; statusEl.innerText = st.toUpperCase(); if(st.includes("Masuk") || st.includes("Hadir") || st.includes("Kembali")) { statusEl.className = "text-xl font-black text-emerald-600"; iconEl.className = "w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600"; iconEl.innerHTML = `<i data-lucide="check-circle" class="w-6 h-6"></i>`; } else if(st.includes("Pulang")) { statusEl.className = "text-xl font-black text-blue-600"; iconEl.className = "w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600"; iconEl.innerHTML = `<i data-lucide="home" class="w-6 h-6"></i>`; } else { statusEl.className = "text-xl font-black text-orange-600"; iconEl.className = "w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center text-orange-600"; iconEl.innerHTML = `<i data-lucide="alert-circle" class="w-6 h-6"></i>`; } } else { if(cacheHariLibur[todayStr]) { statusEl.innerText = "LIBUR: " + cacheHariLibur[todayStr].toUpperCase(); statusEl.className = "text-xl font-black text-purple-600"; iconEl.className = "w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center text-purple-600"; iconEl.innerHTML = `<i data-lucide="calendar-off" class="w-6 h-6"></i>`; } else { statusEl.innerText = "BELUM ABSEN"; statusEl.className = "text-xl font-black text-slate-400"; iconEl.className = "w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center text-slate-400"; iconEl.innerHTML = `<i data-lucide="clock" class="w-6 h-6"></i>`; } } lucide.createIcons(); }); }
        function formatTime(date) { return date.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}).replace('.', ':'); }
        window.lihatFoto = (url, caption) => { Swal.fire({ imageUrl: url, imageAlt: 'Bukti', text: caption, showConfirmButton: false, width: 'auto', padding: '1em', background: '#fff', showCloseButton: true }); }
        window.logout = () => { localStorage.clear(); window.location.href='index.html'; }
    </script>
</body>
</html>
