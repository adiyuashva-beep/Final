<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Panel Karyawan - SiGanteng</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .glass-header { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); }
        .fade-in { animation: fadeIn 0.8s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-slate-800 min-h-screen flex flex-col pb-24">

    <header class="glass-header p-6 pb-24 rounded-b-[2.5rem] shadow-xl relative z-10 text-white">
        <div class="flex justify-between items-start mb-6">
            <div>
                <p class="text-slate-300 text-[10px] font-bold uppercase tracking-[0.2em]">Panel Staff & Tendik</p>
                <h1 class="text-2xl font-black">SiGanteng <span class="text-orange-400">Team</span></h1>
            </div>
            <button onclick="logout()" class="bg-white/10 p-2 rounded-full hover:bg-red-500 transition"><i data-lucide="log-out" class="w-5 h-5"></i></button>
        </div>

        <div class="flex items-center gap-4">
            <div class="relative group cursor-pointer active:scale-95 transition" onclick="bukaKameraProfil()">
                <div class="w-16 h-16 rounded-2xl bg-white p-1 shadow-lg">
                    <img id="foto-profil" src="" class="w-full h-full rounded-xl object-cover" onerror="this.src='https://ui-avatars.com/api/?background=random&color=fff'">
                </div>
                <div class="absolute -bottom-2 -right-2 bg-blue-600 text-white p-1.5 rounded-lg border-2 border-white shadow-sm">
                    <i data-lucide="camera" class="w-3 h-3"></i>
                </div>
            </div>
            <div>
                <h2 id="nama-user" class="text-lg font-bold leading-tight">...</h2>
                <p id="nip-user" class="text-xs font-mono text-slate-300 mt-1">...</p>
                <div class="mt-2 inline-block bg-emerald-500 text-white text-[9px] font-black px-2 py-0.5 rounded uppercase">PEJUANG NIP</div>
            </div>
        </div>
    </header>

    <main class="flex-1 px-5 -mt-16 relative z-20 space-y-6">

        <div class="bg-white p-6 rounded-[2rem] shadow-lg border border-slate-100">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-slate-700 text-sm uppercase tracking-widest">Presensi Harian</h3>
                <div id="status-absen" class="text-[10px] font-bold bg-slate-100 text-slate-500 px-3 py-1 rounded-full">Belum Absen</div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <button onclick="prosesAbsen('Masuk')" class="bg-emerald-50 border border-emerald-100 p-4 rounded-2xl flex flex-col items-center gap-2 active:scale-95 transition">
                    <div class="bg-emerald-500 text-white p-2 rounded-full"><i data-lucide="log-in" class="w-5 h-5"></i></div>
                    <span class="text-xs font-bold text-emerald-700">DATANG</span>
                </button>
                <button onclick="prosesAbsen('Pulang')" class="bg-slate-50 border border-slate-200 p-4 rounded-2xl flex flex-col items-center gap-2 active:scale-95 transition">
                    <div class="bg-slate-700 text-white p-2 rounded-full"><i data-lucide="log-out" class="w-5 h-5"></i></div>
                    <span class="text-xs font-bold text-slate-700">PULANG</span>
                </button>
            </div>
            <div id="jarakBox" class="mt-4 text-center text-[10px] font-mono text-slate-400">Menunggu GPS...</div>
        </div>

        <div class="bg-gradient-to-br from-indigo-500 to-purple-600 p-8 rounded-[2rem] shadow-xl text-center text-white fade-in relative overflow-hidden">
            <div class="absolute top-0 right-0 opacity-10 transform translate-x-10 -translate-y-10">
                <i data-lucide="coffee" class="w-40 h-40"></i>
            </div>
            
            <div class="relative z-10">
                <div class="bg-white/20 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 backdrop-blur-sm shadow-lg">
                    <span class="text-3xl">ðŸ˜Ž</span>
                </div>
                
                <h3 class="text-2xl font-black mb-2">MODE SANTUY AKTIF</h3>
                
                <p class="text-sm font-medium text-indigo-100 leading-relaxed mb-6">
                    "Selamat bekerja Pahlawan Sekolah! <br>
                    Tugas Anda hari ini: <b>Senyum, Absen, dan Bahagia.</b><br>
                    <span class="text-[10px] opacity-70 mt-2 block">(Apike digawe apa nang kene pak yaa, , Selamat Yang bru dapet SPMT . PPPK PW, , ,)</span>"
                </p>

                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white/10 p-3 rounded-xl backdrop-blur-md border border-white/10">
                        <div class="text-xl font-bold">ðŸ’ª</div>
                        <div class="text-[10px] font-bold uppercase mt-1">Semangat</div>
                    </div>
                    <div class="bg-white/10 p-3 rounded-xl backdrop-blur-md border border-white/10">
                        <div class="text-xl font-bold">ðŸ’¸</div>
                        <div class="text-[10px] font-bold uppercase mt-1">Gajian Lancar</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-center text-slate-400 text-[10px] font-mono mt-4">
            &copy; 2026 TIM IT SMAN 1 PEJAGOAN
        </div>

    </main>

    <div id="modalKamera" class="hidden fixed inset-0 z-50 bg-black flex flex-col items-center justify-center">
        <div class="absolute top-0 w-full p-6 flex justify-between z-30">
            <h3 id="judul-kamera" class="text-white font-bold bg-black/50 px-3 py-1 rounded-full text-xs">KAMERA</h3>
            <button onclick="tutupKamera()" class="text-white"><i data-lucide="x" class="w-8 h-8"></i></button>
        </div>
        <div class="relative w-full h-full bg-black">
            <video id="videoStream" autoplay playsinline muted class="w-full h-full object-cover"></video>
            <canvas id="canvasFoto" class="hidden"></canvas>
        </div>
        <div class="absolute bottom-10 z-30"><button onclick="jepret()" class="w-16 h-16 bg-white rounded-full border-4 border-slate-300 shadow-xl active:scale-95 transition"></button></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, where, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXWR-_aJyoMrUjTeNQYlcPD8p3eu58yOo",
            authDomain: "siganteng-absensi.firebaseapp.com",
            databaseURL: "https://siganteng-absensi-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "siganteng-absensi",
            storageBucket: "siganteng-absensi.firebasestorage.app",
            messagingSenderId: "917873420012",
            appId: "1:917873420012:web:0fe1a9eddc5f94959ba7c9"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let userUser = null;
        let lokasiUser = null;
        let streamKamera = null;
        let tipeAbsenAktif = "";
        let configSekolah = { validasi_gps_aktif: true, radius_meter: 50 };
        let SEKOLAH_LAT = -7.6739830;
        let SEKOLAH_LNG = 109.6319560;

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            const sess = sessionStorage.getItem('user_siganteng'); // Masih pakai session yang sama saat login
            if (sess) {
                userUser = JSON.parse(sess);
                initProfil();
                syncAdmin();
                cekGPS();
            } else {
                window.location.href = 'index.html';
            }
        });

        function initProfil() {
            document.getElementById('nama-user').innerText = userUser.nama;
            document.getElementById('nip-user').innerText = "ID: " + userUser.username;
            // Ambil foto profil (sama kayak guru, kita simpan di koleksi 'guru' saja biar nyampur gpp, atau 'karyawan')
            // Di sini saya pakai koleksi 'guru' karena biasanya data karyawan disatuin di login.
            getDoc(doc(db, "guru", userUser.username)).then(snap => {
                if(snap.exists() && snap.data().foto_profil) document.getElementById('foto-profil').src = snap.data().foto_profil;
            });
        }

        // --- GPS & KAMERA (SAMA) ---
        function cekGPS() { if(navigator.geolocation) { navigator.geolocation.watchPosition((p) => { lokasiUser = { lat: p.coords.latitude, lng: p.coords.longitude }; const d = hitungJarak(lokasiUser.lat, lokasiUser.lng, SEKOLAH_LAT, SEKOLAH_LNG); const box = document.getElementById('jarakBox'); const limit = configSekolah.radius_meter || 50; if(configSekolah.validasi_gps_aktif && d > limit) { box.innerHTML = `<span class="text-red-500 font-bold">Lokasi: ${Math.round(d)}m (Luar Area)</span>`; } else { box.innerHTML = `<span class="text-emerald-500 font-bold">Lokasi Valid: ${Math.round(d)}m</span>`; } }, null, { enableHighAccuracy: true }); } }
        function hitungJarak(lat1, lon1, lat2, lon2) { const R = 6371e3; const Ï†1 = lat1 * Math.PI/180; const Ï†2 = lat2 * Math.PI/180; const Î”Ï† = (lat2-lat1) * Math.PI/180; const Î”Î» = (lon2-lon1) * Math.PI/180; const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2); return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); }
        function syncAdmin() { onSnapshot(doc(db, "pengaturan", "sekolah"), (snap) => { if(snap.exists()) { configSekolah = snap.data(); if(configSekolah.lokasi_lat) SEKOLAH_LAT = configSekolah.lokasi_lat; if(configSekolah.lokasi_lng) SEKOLAH_LNG = configSekolah.lokasi_lng; } }); }

        window.bukaKameraProfil = () => { tipeAbsenAktif = "ProfilKaryawan"; document.getElementById('judul-kamera').innerText = "SELFIE PROFIL"; document.getElementById('modalKamera').classList.remove('hidden'); navigator.mediaDevices.getUserMedia({video: {facingMode: 'user', aspectRatio: 1}}).then(s => { streamKamera = s; document.getElementById('videoStream').srcObject = s; }); }
        window.tutupKamera = () => { document.getElementById('modalKamera').classList.add('hidden'); if(streamKamera) streamKamera.getTracks().forEach(t=>t.stop()); }
        
        window.prosesAbsen = (tipe) => { 
            if(!lokasiUser) return Swal.fire('GPS','Sedang mencari lokasi...','info'); 
            const d = hitungJarak(lokasiUser.lat, lokasiUser.lng, SEKOLAH_LAT, SEKOLAH_LNG); 
            if(configSekolah.validasi_gps_aktif && d > (configSekolah.radius_meter || 50)) { return Swal.fire('Kejauhan!', 'Anda belum di area sekolah.', 'error'); } 
            tipeAbsenAktif = tipe; 
            document.getElementById('judul-kamera').innerText = "ABSEN " + tipe.toUpperCase(); 
            document.getElementById('modalKamera').classList.remove('hidden'); 
            navigator.mediaDevices.getUserMedia({video: {facingMode: 'user'}}).then(s => { streamKamera = s; document.getElementById('videoStream').srcObject = s; }); 
        }
        
        window.jepret = async () => { 
            const vid = document.getElementById('videoStream'); const can = document.getElementById('canvasFoto'); can.width = 480; can.height = 480; can.getContext('2d').drawImage(vid,0,0,480,480); const foto = can.toDataURL('image/jpeg', 0.7); 
            
            // Simpan Profil
            if(tipeAbsenAktif === 'ProfilKaryawan') { try { tutupKamera(); Swal.fire({title:'Mengupdate Profil...', didOpen:()=>Swal.showLoading()}); const snap = await uploadString(ref(storage, `profil_guru/${userUser.username}.jpg`), foto, 'data_url'); const url = await getDownloadURL(snap.ref); await setDoc(doc(db, "guru", userUser.username), { foto_profil: url, updated_at: serverTimestamp() }, { merge: true }); Swal.fire('Cakep!', 'Foto profil berhasil diperbarui.', 'success'); document.getElementById('foto-profil').src = foto; } catch(e) { Swal.fire('Gagal', e.message, 'error'); } return; } 
            
            // Simpan Absen (Logic Sama, Status 'Guru' kita ganti 'Karyawan' biar beda dikit di DB kalau mau)
            const todayStr = new Date().toLocaleDateString('fr-CA'); const idDoc = `${todayStr}_${userUser.username}`; 
            try { 
                tutupKamera(); Swal.fire({title:'Menyimpan...', didOpen:()=>Swal.showLoading()}); 
                const snap = await uploadString(ref(storage, `absen_guru/${todayStr}/${userUser.username}_${tipeAbsenAktif}.jpg`), foto, 'data_url'); 
                const url = await getDownloadURL(snap.ref); 
                let data = { nisn: userUser.username, nama: userUser.nama, kelas: 'KARYAWAN', role: 'guru', tanggal: todayStr, status_terakhir: tipeAbsenAktif + " (Staff)" }; 
                if(tipeAbsenAktif === 'Masuk') { data.jam_masuk = serverTimestamp(); data.foto_masuk = url; } 
                else { data.jam_pulang = serverTimestamp(); data.foto_pulang = url; } 
                
                await setDoc(doc(db, "absensi", idDoc), data, {merge: true}); 
                document.getElementById('status-absen').innerText = "Sudah " + tipeAbsenAktif; 
                document.getElementById('status-absen').className = "text-[10px] font-bold bg-emerald-100 text-emerald-600 px-3 py-1 rounded-full"; 
                Swal.fire('Mantap!', 'Absensi berhasil. Selamat bekerja!', 'success'); 
            } catch(e) { Swal.fire('Error', e.message, 'error'); } 
        }

        window.logout = () => { sessionStorage.clear(); localStorage.clear(); window.location.href = 'index.html'; }
    </script>
</body>

</html>
